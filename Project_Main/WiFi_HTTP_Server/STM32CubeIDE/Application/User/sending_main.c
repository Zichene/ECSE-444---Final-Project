/**
  ******************************************************************************
  * @file    Wifi/WiFi_HTTP_Server/src/main.c
  * @author  MCD Application Team
  * @brief   This file provides main program functions
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2017 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
//#define SENDING_ACTIVE // Comment/Uncomment this depending on if you are this board as sending/receiving
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include <math.h>
#include "sending_board_config.h"
#define ARM_MATH_CM4
#include "arm_math.h"

#ifdef SENDING_ACTIVE
/* Private defines -----------------------------------------------------------*/
#define PORT           10 // PORT of this board [sending board]
#define REMOTE_PORT    80 // PORT Of the receiving board
#define REMOTE_SOCKET	0 // SOCKET of the receiving board
#define TERMINAL_USE

#define WIFI_WRITE_TIMEOUT 10000
#define WIFI_READ_TIMEOUT  10000
#define SOCKET                 1
#define SENDING_BUFLEN 1000
#define RECORDING_BUFLEN 40000
#define SAMPLING_RATE_FACTOR 2 // DEFAULT SAMPLING IS AT 20 kHz, a higher factor means a lower sampling rate


#ifdef  TERMINAL_USE
#define LOG(a) printf a
#else
#define LOG(a)
#endif

/* Private typedef------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
DAC_HandleTypeDef hdac1;
DMA_HandleTypeDef hdma_dac1_ch1;
DFSDM_Filter_HandleTypeDef hdfsdm1_filter0;
DFSDM_Channel_HandleTypeDef hdfsdm1_channel2;
DMA_HandleTypeDef hdma_dfsdm1_flt0;
TIM_HandleTypeDef htim2;
#if defined (TERMINAL_USE)
extern UART_HandleTypeDef hDiscoUart;
#endif /* TERMINAL_USE */

//static  uint8_t http[1024];
static  uint8_t  IP_Addr[4];
static uint8_t RemoteIP_Addr[4]; // address of receiving board
static int32_t recordingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static int32_t testingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static uint8_t sendingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime

/** INTERRUPT FLAGS **/
volatile uint8_t DFSDM_half_finished=false;
volatile uint8_t DFSDM_finished=false;
volatile uint8_t buttonPressed=0;

/* Private function prototypes -----------------------------------------------*/
#if defined (TERMINAL_USE)
#ifdef __GNUC__
/* With GCC, small printf (option LD Linker->Libraries->Small printf
   set to 'Yes') calls __io_putchar() */
#define PUTCHAR_PROTOTYPE int __io_putchar(int ch)
#else
#define PUTCHAR_PROTOTYPE int fputc(int ch, FILE *f)
#endif /* __GNUC__ */
#endif /* TERMINAL_USE */

static void SystemClock_Config(void);
static int wifi_start(void);
static int wifi_connect_to_board(uint8_t ip0, uint8_t ip1, uint8_t ip2, uint8_t ip3);
static int wifi_send_data_to_board(uint8_t* data);

/* MX Inits */
static void MX_DMA_Init(void);
static void MX_DAC1_Init(void);
static void MX_TIM2_Init(void);
static void MX_DFSDM1_Init(void);
static void MX_GPIO_Init(void);

/* Private functions ---------------------------------------------------------*/
void transformBufferToDAC(int32_t *buffer, uint32_t recording_buffer_length, int32_t *testbuffer, uint8_t *outputBuffer);
/**
  * @brief  Main program
  * @param  None
  * @retval None
  */
int main(void)
{
  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* Configure the system clock */
  SystemClock_Config();

  /* Configure LED2 */
  BSP_LED_Init(LED2);

  /* Initialize all configured peripherals */
  MX_DMA_Init();
  MX_DAC1_Init();
  MX_TIM2_Init();
  MX_DFSDM1_Init();
  MX_GPIO_Init();


  //HAL_DAC_Start(&hdac1, DAC_CHANNEL_1);
  HAL_TIM_Base_Start_IT(&htim2); // the _IT at the end of fn. means interrupt

  /* WIFI Web Server demonstration */
#if defined (TERMINAL_USE)
  /* Initialize all configured peripherals */
  hDiscoUart.Instance = DISCOVERY_COM1;
  hDiscoUart.Init.BaudRate = 115200;
  hDiscoUart.Init.WordLength = UART_WORDLENGTH_8B;
  hDiscoUart.Init.StopBits = UART_STOPBITS_1;
  hDiscoUart.Init.Parity = UART_PARITY_NONE;
  hDiscoUart.Init.Mode = UART_MODE_TX_RX;
  hDiscoUart.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  hDiscoUart.Init.OverSampling = UART_OVERSAMPLING_16;
  hDiscoUart.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  hDiscoUart.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;


  BSP_COM_Init(COM1, &hDiscoUart);

  /* resetting buffers */
  memset(recordingBuffer, 0, RECORDING_BUFLEN*sizeof(int32_t));
  memset(sendingBuffer, 0, SENDING_BUFLEN);

  printf("****** SENDING BOARD Initiating ****** \r\n");

#endif /* TERMINAL_USE */

  printf("***Testing rig begin*** \r\n");
  printf("Waiting for button press to send mic data.\r\n");
  while(buttonPressed==false){
  	__WFI(); // Waiting for interrupt mode?
  }
  buttonPressed=false;
	if (HAL_DFSDM_FilterRegularStart_DMA(&hdfsdm1_filter0, recordingBuffer, RECORDING_BUFLEN) != HAL_OK) {
	  printf("Failed to start DFSDM\r\n");
	}
	while (!DFSDM_finished) {
	}
	DFSDM_finished = false;
	HAL_DFSDM_FilterRegularStop_DMA(&hdfsdm1_filter0);
	transformBufferToDAC(recordingBuffer,RECORDING_BUFLEN,testingBuffer, sendingBuffer);

	if (HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, testingBuffer, RECORDING_BUFLEN, DAC_ALIGN_8B_R) != HAL_OK) {
		printf("Failed to start DAC");
	}
    while(buttonPressed==false){
    	__WFI(); // Waiting for interrupt mode?
    }
    buttonPressed = false;

	int32_t NumTaps=2000;
	int32_t blockSize=500;
	float32_t firStateF32[2*blockSize+NumTaps-1];
	int32_t pCoeffs=2;
	float32_t firCoeffs32[1999]={-7.8736384e-06, -2.0634683e-05, -2.5533617e-05, -2.0680796e-05, -7.9088679e-06,  7.9188433e-06,  2.0759147e-05,  2.5695045e-05,  2.0817546e-05,  7.9634589e-06, -7.9757983e-06, -2.0914465e-05, -2.5894723e-05, -2.0985333e-05, -8.0299399e-06,  8.0446784e-06,  2.1101094e-05,  2.6133219e-05,  2.1184616e-05,  8.1084864e-06, -8.1256590e-06, -2.1319496e-05, -2.6411100e-05, -2.1415856e-05, -8.1992744e-06,  8.2189165e-06,  2.1570131e-05,  2.6728940e-05,  2.1679514e-05,  8.3024810e-06, -8.3246281e-06, -2.1853464e-05, -2.7087312e-05, -2.1976058e-05, -8.4182839e-06,  8.4429718e-06,  2.2169962e-05,  2.7486793e-05,  2.2305952e-05,  8.5468619e-06, -8.5741262e-06, -2.2520093e-05, -2.7927963e-05, -2.2669668e-05, -8.6883943e-06,  8.7182712e-06,  2.2904328e-05,  2.8411405e-05,  2.3067678e-05,  8.8430617e-06, -8.8755873e-06, -2.3323141e-05, -2.8937704e-05, -2.3500454e-05, -9.0110454e-06,  9.0462561e-06,  2.3777006e-05,  2.9507449e-05,  2.3968474e-05,  9.1925276e-06, -9.2304599e-06, -2.4266403e-05, -3.0121231e-05, -2.4472218e-05, -9.3876915e-06,  9.4283823e-06,  2.4791811e-05,  3.0779646e-05,  2.5012166e-05,  9.5967216e-06, -9.6402078e-06, -2.5353716e-05, -3.1483292e-05, -2.5588805e-05, -9.8198031e-06,  9.8661220e-06,  2.5952602e-05,  3.2232772e-05,  2.6202621e-05,  1.0057123e-05, -1.0106311e-05, -2.6588960e-05, -3.3028689e-05, -2.6854105e-05, -1.0308867e-05,  1.0360964e-05,  2.7263281e-05,  3.3871655e-05,  2.7543750e-05,  1.0575227e-05, -1.0630269e-05, -2.7976062e-05, -3.4762282e-05, -2.8272054e-05, -1.0856390e-05,  1.0914416e-05,  2.8727801e-05,  3.5701188e-05,  2.9039517e-05,  1.1152549e-05, -1.1213597e-05, -2.9518999e-05, -3.6688993e-05, -2.9846641e-05, -1.1463896e-05,  1.1528005e-05,  3.0350164e-05,  3.7726324e-05,  3.0693934e-05,  1.1790625e-05, -1.1857834e-05, -3.1221804e-05, -3.8813812e-05, -3.1581907e-05, -1.2132932e-05,  1.2203280e-05,  3.2134432e-05,  3.9952092e-05,  3.2511075e-05,  1.2491013e-05, -1.2564540e-05, -3.3088565e-05, -4.1141803e-05, -3.3481956e-05, -1.2865067e-05,  1.2941813e-05,  3.4084724e-05,  4.2383591e-05,  3.4495073e-05,  1.3255294e-05, -1.3335298e-05, -3.5123436e-05, -4.3678107e-05, -3.5550953e-05, -1.3661896e-05,  1.3745199e-05,  3.6205229e-05,  4.5026006e-05,  3.6650128e-05,  1.4085075e-05, -1.4171719e-05, -3.7330638e-05, -4.6427951e-05, -3.7793135e-05, -1.4525038e-05,  1.4615063e-05,  3.8500203e-05,  4.7884609e-05,  3.8980514e-05,  1.4981992e-05, -1.5075439e-05, -3.9714468e-05, -4.9396655e-05, -4.0212813e-05, -1.5456144e-05,  1.5553057e-05,  4.0973983e-05,  5.0964769e-05,  4.1490582e-05,  1.5947708e-05, -1.6048129e-05, -4.2279302e-05, -5.2589639e-05, -4.2814380e-05, -1.6456896e-05,  1.6560867e-05,  4.3630986e-05,  5.4271958e-05,  4.4184769e-05,  1.6983923e-05, -1.7091488e-05, -4.5029602e-05, -5.6012430e-05, -4.5602318e-05, -1.7529008e-05,  1.7640211e-05,  4.6475723e-05,  5.7811763e-05,  4.7067603e-05,  1.8092370e-05, -1.8207255e-05, -4.7969928e-05, -5.9670676e-05, -4.8581205e-05, -1.8674232e-05,  1.8792845e-05,  4.9512803e-05,  6.1589893e-05,  5.0143713e-05,  1.9274820e-05, -1.9397205e-05, -5.1104940e-05, -6.3570149e-05, -5.1755722e-05, -1.9894362e-05,  2.0020566e-05,  5.2746939e-05,  6.5612189e-05,  5.3417836e-05,  2.0533089e-05, -2.0663157e-05, -5.4439409e-05, -6.7716765e-05, -5.5130666e-05, -2.1191235e-05,  2.1325215e-05,  5.6182964e-05,  6.9884639e-05,  5.6894830e-05,  2.1869035e-05, -2.2006975e-05, -5.7978229e-05, -7.2116585e-05, -5.8710955e-05, -2.2566732e-05,  2.2708680e-05,  5.9825836e-05,  7.4413387e-05,  6.0579678e-05,  2.3284568e-05, -2.3430574e-05, -6.1726426e-05, -7.6775839e-05, -6.2501642e-05, -2.4022790e-05,  2.4172903e-05,  6.3680649e-05,  7.9204748e-05,  6.4477503e-05,  2.4781650e-05, -2.4935920e-05, -6.5689165e-05, -8.1700932e-05, -6.6507924e-05, -2.5561400e-05,  2.5719880e-05,  6.7752646e-05,  8.4265224e-05,  6.8593581e-05,  2.6362301e-05, -2.6525042e-05, -6.9871772e-05, -8.6898466e-05, -7.0735158e-05, -2.7184614e-05,  2.7351670e-05,  7.2047235e-05,  8.9601517e-05,  7.2933352e-05,  2.8028607e-05, -2.8200031e-05, -7.4279738e-05, -9.2375249e-05, -7.5188870e-05, -2.8894551e-05,  2.9070398e-05,  7.6569997e-05,  9.5220550e-05,  7.7502434e-05,  2.9782721e-05, -2.9963047e-05, -7.8918739e-05, -9.8138322e-05, -7.9874777e-05, -3.0693400e-05,  3.0878262e-05,  8.1326705e-05,  1.0112948e-04,  8.2306643e-05,  3.1626872e-05, -3.1816327e-05, -8.3794651e-05, -1.0419497e-04, -8.4798794e-05, -3.2583430e-05,  3.2777538e-05,  8.6323343e-05,  1.0733574e-04,  8.7352004e-05,  3.3563370e-05, -3.3762190e-05, -8.8913566e-05, -1.1055276e-04, -8.9967063e-05, -3.4566995e-05,  3.4770589e-05,  9.1566119e-05,  1.1384703e-04,  9.2644774e-05,  3.5594613e-05, -3.5803044e-05, -9.4281816e-05, -1.1721955e-04, -9.5385960e-05, -3.6646540e-05,  3.6859871e-05,  9.7061488e-05,  1.2067135e-04,  9.8191460e-05,  3.7723098e-05, -3.7941394e-05, -9.9905986e-05, -1.2420350e-04, -1.0106213e-04, -3.8824614e-05,  3.9047942e-05,  1.0281618e-04,  1.2781706e-04,  1.0399884e-04,  3.9951425e-05, -4.0179853e-05, -1.0579294e-04, -1.3151314e-04, -1.0700250e-04, -4.1103874e-05,  4.1337471e-05,  1.0883720e-04,  1.3529287e-04,  1.1007400e-04,  4.2282311e-05, -4.2521148e-05, -1.1194986e-04, -1.3915738e-04, -1.1321430e-04, -4.3487095e-05,  4.3731246e-05,  1.1513189e-04,  1.4310788e-04,  1.1642434e-04,  4.4718595e-05, -4.4968134e-05, -1.1838425e-04, -1.4714554e-04, -1.1970511e-04, -4.5977186e-05,  4.6232189e-05,  1.2170793e-04,  1.5127163e-04,  1.2305761e-04,  4.7263254e-05, -4.7523799e-05, -1.2510397e-04, -1.5548740e-04, -1.2648287e-04, -4.8577194e-05,  4.8843362e-05,  1.2857339e-04,  1.5979414e-04,  1.2998195e-04,  4.9919412e-05, -5.0191286e-05, -1.3211728e-04, -1.6419320e-04, -1.3355593e-04, -5.1290324e-05,  5.1567987e-05,  1.3573673e-04,  1.6868594e-04,  1.3720593e-04,  5.2690357e-05, -5.2973897e-05, -1.3943288e-04, -1.7327376e-04, -1.4093308e-04, -5.4119949e-05,  5.4409454e-05,  1.4320689e-04,  1.7795811e-04,  1.4473855e-04,  5.5579551e-05, -5.5875113e-05, -1.4705994e-04, -1.8274046e-04, -1.4862357e-04, -5.7069626e-05,  5.7371339e-05,  1.5099326e-04,  1.8762235e-04,  1.5258935e-04,  5.8590650e-05, -5.8898612e-05, -1.5500812e-04, -1.9260534e-04, -1.5663719e-04, -6.0143114e-05,  6.0457423e-05,  1.5910582e-04,  1.9769104e-04,  1.6076839e-04,  6.1727521e-05, -6.2048281e-05, -1.6328768e-04, -2.0288112e-04, -1.6498430e-04, -6.3344391e-05,  6.3671708e-05,  1.6755509e-04,  2.0817728e-04,  1.6928632e-04,  6.4994260e-05, -6.5328242e-05, -1.7190946e-04, -2.1358129e-04, -1.7367588e-04, -6.6677679e-05,  6.7018438e-05,  1.7635225e-04,  2.1909497e-04,  1.7815447e-04,  6.8395216e-05, -6.8742869e-05, -1.8088498e-04, -2.2472019e-04, -1.8272360e-04, -7.0147460e-05,  7.0502126e-05,  1.8550920e-04,  2.3045890e-04,  1.8738486e-04,  7.1935014e-05, -7.2296817e-05, -1.9022651e-04, -2.3631308e-04, -1.9213988e-04, -7.3758506e-05,  7.4127574e-05,  1.9503858e-04,  2.4228480e-04,  1.9699032e-04,  7.5618582e-05, -7.5995045e-05, -1.9994712e-04, -2.4837619e-04, -2.0193794e-04, -7.7515908e-05,  7.7899904e-05,  2.0495390e-04,  2.5458947e-04,  2.0698453e-04,  7.9451177e-05, -7.9842847e-05, -2.1006075e-04, -2.6092690e-04, -2.1213194e-04, -8.1425103e-05,  8.1824591e-05,  2.1526958e-04,  2.6739086e-04,  2.1738210e-04,  8.3438425e-05, -8.3845884e-05, -2.2058234e-04, -2.7398378e-04, -2.2273699e-04, -8.5491909e-05,  8.5907494e-05,  2.2600106e-04,  2.8070820e-04,  2.2819869e-04,  8.7586348e-05, -8.8010223e-05, -2.3152786e-04, -2.8756675e-04, -2.3376933e-04, -8.9722565e-05,  9.0154897e-05,  2.3716492e-04,  2.9456212e-04,  2.3945112e-04,  9.1901413e-05, -9.2342375e-05, -2.4291451e-04, -3.0169716e-04, -2.4524637e-04, -9.4123775e-05,  9.4573549e-05,  2.4877896e-04,  3.0897479e-04,  2.5115745e-04,  9.6390570e-05, -9.6849344e-05, -2.5476073e-04, -3.1639803e-04, -2.5718685e-04, -9.8702750e-05,  9.9170719e-05,  2.6086235e-04,  3.2397006e-04,  2.6333714e-04,  1.0106131e-04, -1.0153867e-04, -2.6708644e-04, -3.3169414e-04, -2.6961098e-04, -1.0346727e-04,  1.0395424e-04,  2.7343575e-04,  3.3957369e-04,  2.7601117e-04,  1.0592170e-04, -1.0641850e-04, -2.7991312e-04, -3.4761225e-04, -2.8254059e-04, -1.0842573e-04,  1.0893258e-04,  2.8652151e-04,  3.5581352e-04,  2.8920224e-04,  1.1098050e-04, -1.1149765e-04, -2.9326400e-04, -3.6418132e-04, -2.9599926e-04, -1.1358722e-04,  1.1411491e-04,  3.0014381e-04,  3.7271966e-04,  3.0293492e-04,  1.1624715e-04, -1.1678563e-04, -3.0716427e-04, -3.8143271e-04, -3.1001262e-04, -1.1896160e-04,  1.1951115e-04,  3.1432888e-04,  3.9032482e-04,  3.1723589e-04,  1.2173193e-04, -1.2229283e-04, -3.2164126e-04, -3.9940051e-04, -3.2460844e-04, -1.2455957e-04,  1.2513211e-04,  3.2910522e-04,  4.0866452e-04,  3.3213412e-04,  1.2744601e-04, -1.2803049e-04, -3.3672471e-04, -4.1812179e-04, -3.3981698e-04, -1.3039280e-04,  1.3098954e-04,  3.4450388e-04,  4.2777748e-04,  3.4766122e-04,  1.3340156e-04, -1.3401089e-04, -3.5244704e-04, -4.3763697e-04, -3.5567123e-04, -1.3647399e-04,  1.3709627e-04,  3.6055873e-04,  4.4770592e-04,  3.6385164e-04,  1.3961186e-04, -1.4024745e-04, -3.6884366e-04, -4.5799022e-04, -3.7220725e-04, -1.4281703e-04,  1.4346631e-04,  3.7730680e-04,  4.6849605e-04,  3.8074311e-04,  1.4609145e-04, -1.4675482e-04, -3.8595333e-04, -4.7922988e-04, -3.8946450e-04, -1.4943715e-04,  1.5011503e-04,  3.9478869e-04,  4.9019849e-04,  3.9837697e-04,  1.5285626e-04, -1.5354909e-04, -4.0381856e-04, -5.0140900e-04, -4.0748631e-04, -1.5635104e-04,  1.5705928e-04,  4.1304894e-04,  5.1286886e-04,  4.1679863e-04,  1.5992382e-04, -1.6064796e-04, -4.2248610e-04, -5.2458591e-04, -4.2632032e-04, -1.6357709e-04,  1.6431762e-04,  4.3213662e-04,  5.3656837e-04,  4.3605811e-04,  1.6731342e-04, -1.6807089e-04, -4.4200744e-04, -5.4882490e-04, -4.4601907e-04, -1.7113555e-04,  1.7191052e-04,  4.5210584e-04,  5.6136459e-04,  4.5621063e-04,  1.7504635e-04, -1.7583941e-04, -4.6243949e-04, -5.7419702e-04, -4.6664061e-04, -1.7904883e-04,  1.7986061e-04,  4.7301645e-04,  5.8733226e-04,  4.7731725e-04,  1.8314619e-04, -1.8397733e-04, -4.8384523e-04, -6.0078094e-04, -4.8824925e-04, -1.8734176e-04,  1.8819297e-04,  4.9493481e-04,  6.1455426e-04,  4.9944576e-04,  1.9163909e-04, -1.9251109e-04, -5.0629464e-04, -6.2866405e-04, -5.1091645e-04, -1.9604191e-04,  1.9693548e-04,  5.1793470e-04,  6.4312278e-04,  5.2267154e-04,  2.0055416e-04, -2.0147011e-04, -5.2986556e-04, -6.5794365e-04, -5.3472180e-04, -2.0518002e-04,  2.0611921e-04,  5.4209837e-04,  6.7314061e-04,  5.4707867e-04,  2.0992389e-04, -2.1088723e-04, -5.5464495e-04, -6.8872843e-04, -5.5975421e-04, -2.1479044e-04,  2.1577890e-04,  5.6751779e-04,  7.0472273e-04,  5.7276123e-04,  2.1978462e-04, -2.2079922e-04, -5.8073017e-04, -7.2114011e-04, -5.8611330e-04, -2.2491166e-04,  2.2595350e-04,  5.9429612e-04,  7.3799815e-04,  5.9982482e-04,  2.3017715e-04, -2.3124737e-04, -6.0823059e-04, -7.5531551e-04, -6.1391108e-04, -2.3558698e-04,  2.3668681e-04,  6.2254944e-04,  7.7311206e-04,  6.2838834e-04,  2.4114745e-04, -2.4227820e-04, -6.3726952e-04, -7.9140890e-04, -6.4327389e-04, -2.4686524e-04,  2.4802830e-04,  6.5240881e-04,  8.1022851e-04,  6.5858614e-04,  2.5274748e-04, -2.5394433e-04, -6.6798642e-04, -8.2959484e-04, -6.7434473e-04, -2.5880177e-04,  2.6003398e-04,  6.8402278e-04,  8.4953345e-04,  6.9057061e-04,  2.6503621e-04, -2.6630546e-04, -7.0053967e-04, -8.7007163e-04, -7.0728614e-04, -2.7145945e-04,  2.7276757e-04,  7.1756038e-04,  8.9123855e-04,  7.2451525e-04,  2.7808078e-04, -2.7942967e-04, -7.3510981e-04, -9.1306545e-04, -7.4228355e-04, -2.8491009e-04,  2.8630183e-04,  7.5321468e-04,  9.3558576e-04,  7.6061848e-04,  2.9195802e-04, -2.9339483e-04, -7.7190359e-04, -9.5883538e-04, -7.7954949e-04, -2.9923598e-04,  3.0072024e-04,  7.9120727e-04,  9.8285284e-04,  7.9910821e-04,  3.0675623e-04, -3.0829049e-04, -8.1115878e-04, -1.0076796e-03, -8.1932865e-04, -3.1453195e-04,  3.1611898e-04,  8.3179367e-04,  1.0333602e-03,  8.4024746e-04,  3.2257735e-04, -3.2422012e-04, -8.5315028e-04, -1.0599429e-03, -8.6190417e-04, -3.3090775e-04,  3.3260947e-04,  8.7526999e-04,  1.0874795e-03,  8.8434144e-04,  3.3953973e-04, -3.4130386e-04, -8.9819752e-04, -1.1160262e-03, -9.0760543e-04, -3.4849119e-04,  3.5032150e-04,  9.2198130e-04,  1.1456439e-03,  9.3174617e-04,  3.5778154e-04, -3.5968210e-04, -9.4667383e-04, -1.1763984e-03, -9.5681790e-04, -3.6743185e-04,  3.6940709e-04,  9.7233214e-04,  1.2083616e-03,  9.8287960e-04,  3.7746503e-04, -3.7951977e-04, -9.9901827e-04, -1.2416113e-03, -1.0099955e-03, -3.8790603e-04,  3.9004552e-04,  1.0267998e-03,  1.2762327e-03,  1.0382355e-03,  3.9878207e-04, -4.0101205e-04, -1.0557507e-03, -1.3123187e-03, -1.0676762e-03, -4.1012290e-04,  4.1244965e-04,  1.0859515e-03,  1.3499708e-03,  1.0984014e-03,  4.2196111e-04, -4.2439153e-04, -1.1174910e-03, -1.3893007e-03, -1.1305030e-03, -4.3433249e-04,  4.3687414e-04,  1.1504663e-03,  1.4304308e-03,  1.1640820e-03,  4.4727637e-04, -4.4993760e-04, -1.1849845e-03, -1.4734962e-03, -1.1992499e-03, -4.6083617e-04,  4.6362617e-04,  1.2211639e-03,  1.5186460e-03,  1.2361297e-03,  4.7505983e-04, -4.7798880e-04, -1.2591353e-03, -1.5660451e-03, -1.2748576e-03, -4.9000049e-04,  4.9307975e-04,  1.2990437e-03,  1.6158767e-03,  1.3155849e-03,  5.0571721e-04, -5.0895934e-04, -1.3410504e-03, -1.6683445e-03, -1.3584803e-03, -5.2227576e-04,  5.2569481e-04,  1.3853355e-03,  1.7236761e-03,  1.4037318e-03,  5.3974966e-04, -5.4336136e-04, -1.4321003e-03, -1.7821261e-03, -1.4515503e-03, -5.5822132e-04,  5.6204334e-04,  1.4815709e-03,  1.8439806e-03,  1.5021728e-03,  5.7778344e-04, -5.8183570e-04, -1.5340020e-03, -1.9095620e-03, -1.5558665e-03, -5.9854066e-04,  6.0284568e-04,  1.5896813e-03,  1.9792352e-03,  1.6129342e-03,  6.2061153e-04, -6.2519489e-04, -1.6489355e-03, -2.0534144e-03, -1.6737198e-03, -6.4413092e-04,  6.4902180e-04,  1.7121368e-03,  2.1325722e-03,  1.7386159e-03,  6.6925292e-04, -6.7448475e-04, -1.7797112e-03, -2.2172498e-03, -1.8080728e-03, -6.9615437e-04,  7.0176561e-04,  1.8521487e-03,  2.3080703e-03,  1.8826093e-03,  7.2503925e-04, -7.3107440e-04, -1.9300154e-03, -2.4057546e-03, -1.9628262e-03, -7.5614404e-04,  7.6265488e-04,  2.0139693e-03,  2.5111413e-03,  2.0494232e-03,  7.8974452e-04, -7.9679162e-04, -2.1047793e-03, -2.6252117e-03, -2.1432204e-03, -8.2616423e-04,  8.3381893e-04,  2.2033500e-03,  2.7491220e-03,  2.2451849e-03,  8.6578528e-04, -8.7413220e-04, -2.3107530e-03, -2.8842432e-03, -2.3564655e-03, -9.0906228e-04,  9.1820253e-04,  2.4282666e-03,  3.0322140e-03,  2.4784374e-03,  9.5654031e-04, -9.6659572e-04, -2.5574291e-03, -3.1950095e-03, -2.6127610e-03, -1.0088786e-03,  1.0199973e-03,  2.7001076e-03,  3.3750317e-03,  2.7614596e-03,  1.0668822e-03, -1.0792462e-03, -2.8585916e-03, -3.5752319e-03, -2.9270244e-03, -1.1315443e-03,  1.1453798e-03,  3.0357188e-03,  3.7992769e-03,  3.1125581e-03,  1.2041052e-03, -1.2196963e-03, -3.2350500e-03, -4.0517799e-03, -3.3219745e-03, -1.2861335e-03,  1.3038429e-03,  3.4611151e-03,  4.3386267e-03,  3.5602825e-03,  1.3796429e-03, -1.3999405e-03, -3.7197665e-03, -4.6674474e-03, -3.8339974e-03, -1.4872621e-03,  1.5107678e-03,  4.0187003e-03,  5.0483137e-03,  4.1517534e-03,  1.6124887e-03, -1.6400375e-03, -4.3682437e-03, -5.4948008e-03, -4.5252411e-03, -1.7600810e-03,  1.7928250e-03,  4.7825846e-03,  6.0256553e-03,  4.9706915e-03,  1.9366815e-03, -1.9762561e-03, -5.2817619e-03, -6.6675177e-03, -5.5113167e-03, -2.1518528e-03,  2.2006596e-03,  5.8950277e-03,  7.4595649e-03,  6.1815155e-03,  2.4198796e-03, -2.4815939e-03, -6.6668304e-03, -8.4618689e-03, -7.0345355e-03, -2.7630947e-03,  2.8436370e-03,  7.6681550e-03,  9.7714690e-03,  8.1574329e-03,  3.2184752e-03, -3.3280300e-03, -9.0198005e-03, -1.1555979e-02, -9.7029663e-03, -3.8520000e-03,  4.0096801e-03,  1.0945374e-02,  1.4132003e-02,  1.1965996e-02,  4.7940178e-03, -5.0403231e-03, -1.3910222e-02, -1.8177980e-02, -1.5598790e-02, -6.3430695e-03,  6.7809849e-03,  1.9069088e-02,  2.5457849e-02,  2.2387995e-02,  9.3663455e-03, -1.0352747e-02, -3.0293770e-02, -4.2439391e-02, -3.9617631e-02, -1.7884456e-02,  2.1859276e-02,  7.3580617e-02,  1.2733264e-01,  1.7169201e-01,  1.9674243e-01,  1.9674243e-01,  1.7169201e-01,  1.2733264e-01,  7.3580617e-02,  2.1859276e-02, -1.7884456e-02, -3.9617631e-02, -4.2439391e-02, -3.0293770e-02, -1.0352747e-02,  9.3663455e-03,  2.2387995e-02,  2.5457849e-02,  1.9069088e-02,  6.7809849e-03, -6.3430695e-03, -1.5598790e-02, -1.8177980e-02, -1.3910222e-02, -5.0403231e-03,  4.7940178e-03,  1.1965996e-02,  1.4132003e-02,  1.0945374e-02,  4.0096801e-03, -3.8520000e-03, -9.7029663e-03, -1.1555979e-02, -9.0198005e-03, -3.3280300e-03,  3.2184752e-03,  8.1574329e-03,  9.7714690e-03,  7.6681550e-03,  2.8436370e-03, -2.7630947e-03, -7.0345355e-03, -8.4618689e-03, -6.6668304e-03, -2.4815939e-03,  2.4198796e-03,  6.1815155e-03,  7.4595649e-03,  5.8950277e-03,  2.2006596e-03, -2.1518528e-03, -5.5113167e-03, -6.6675177e-03, -5.2817619e-03, -1.9762561e-03,  1.9366815e-03,  4.9706915e-03,  6.0256553e-03,  4.7825846e-03,  1.7928250e-03, -1.7600810e-03, -4.5252411e-03, -5.4948008e-03, -4.3682437e-03, -1.6400375e-03,  1.6124887e-03,  4.1517534e-03,  5.0483137e-03,  4.0187003e-03,  1.5107678e-03, -1.4872621e-03, -3.8339974e-03, -4.6674474e-03, -3.7197665e-03, -1.3999405e-03,  1.3796429e-03,  3.5602825e-03,  4.3386267e-03,  3.4611151e-03,  1.3038429e-03, -1.2861335e-03, -3.3219745e-03, -4.0517799e-03, -3.2350500e-03, -1.2196963e-03,  1.2041052e-03,  3.1125581e-03,  3.7992769e-03,  3.0357188e-03,  1.1453798e-03, -1.1315443e-03, -2.9270244e-03, -3.5752319e-03, -2.8585916e-03, -1.0792462e-03,  1.0668822e-03,  2.7614596e-03,  3.3750317e-03,  2.7001076e-03,  1.0199973e-03, -1.0088786e-03, -2.6127610e-03, -3.1950095e-03, -2.5574291e-03, -9.6659572e-04,  9.5654031e-04,  2.4784374e-03,  3.0322140e-03,  2.4282666e-03,  9.1820253e-04, -9.0906228e-04, -2.3564655e-03, -2.8842432e-03, -2.3107530e-03, -8.7413220e-04,  8.6578528e-04,  2.2451849e-03,  2.7491220e-03,  2.2033500e-03,  8.3381893e-04, -8.2616423e-04, -2.1432204e-03, -2.6252117e-03, -2.1047793e-03, -7.9679162e-04,  7.8974452e-04,  2.0494232e-03,  2.5111413e-03,  2.0139693e-03,  7.6265488e-04, -7.5614404e-04, -1.9628262e-03, -2.4057546e-03, -1.9300154e-03, -7.3107440e-04,  7.2503925e-04,  1.8826093e-03,  2.3080703e-03,  1.8521487e-03,  7.0176561e-04, -6.9615437e-04, -1.8080728e-03, -2.2172498e-03, -1.7797112e-03, -6.7448475e-04,  6.6925292e-04,  1.7386159e-03,  2.1325722e-03,  1.7121368e-03,  6.4902180e-04, -6.4413092e-04, -1.6737198e-03, -2.0534144e-03, -1.6489355e-03, -6.2519489e-04,  6.2061153e-04,  1.6129342e-03,  1.9792352e-03,  1.5896813e-03,  6.0284568e-04, -5.9854066e-04, -1.5558665e-03, -1.9095620e-03, -1.5340020e-03, -5.8183570e-04,  5.7778344e-04,  1.5021728e-03,  1.8439806e-03,  1.4815709e-03,  5.6204334e-04, -5.5822132e-04, -1.4515503e-03, -1.7821261e-03, -1.4321003e-03, -5.4336136e-04,  5.3974966e-04,  1.4037318e-03,  1.7236761e-03,  1.3853355e-03,  5.2569481e-04, -5.2227576e-04, -1.3584803e-03, -1.6683445e-03, -1.3410504e-03, -5.0895934e-04,  5.0571721e-04,  1.3155849e-03,  1.6158767e-03,  1.2990437e-03,  4.9307975e-04, -4.9000049e-04, -1.2748576e-03, -1.5660451e-03, -1.2591353e-03, -4.7798880e-04,  4.7505983e-04,  1.2361297e-03,  1.5186460e-03,  1.2211639e-03,  4.6362617e-04, -4.6083617e-04, -1.1992499e-03, -1.4734962e-03, -1.1849845e-03, -4.4993760e-04,  4.4727637e-04,  1.1640820e-03,  1.4304308e-03,  1.1504663e-03,  4.3687414e-04, -4.3433249e-04, -1.1305030e-03, -1.3893007e-03, -1.1174910e-03, -4.2439153e-04,  4.2196111e-04,  1.0984014e-03,  1.3499708e-03,  1.0859515e-03,  4.1244965e-04, -4.1012290e-04, -1.0676762e-03, -1.3123187e-03, -1.0557507e-03, -4.0101205e-04,  3.9878207e-04,  1.0382355e-03,  1.2762327e-03,  1.0267998e-03,  3.9004552e-04, -3.8790603e-04, -1.0099955e-03, -1.2416113e-03, -9.9901827e-04, -3.7951977e-04,  3.7746503e-04,  9.8287960e-04,  1.2083616e-03,  9.7233214e-04,  3.6940709e-04, -3.6743185e-04, -9.5681790e-04, -1.1763984e-03, -9.4667383e-04, -3.5968210e-04,  3.5778154e-04,  9.3174617e-04,  1.1456439e-03,  9.2198130e-04,  3.5032150e-04, -3.4849119e-04, -9.0760543e-04, -1.1160262e-03, -8.9819752e-04, -3.4130386e-04,  3.3953973e-04,  8.8434144e-04,  1.0874795e-03,  8.7526999e-04,  3.3260947e-04, -3.3090775e-04, -8.6190417e-04, -1.0599429e-03, -8.5315028e-04, -3.2422012e-04,  3.2257735e-04,  8.4024746e-04,  1.0333602e-03,  8.3179367e-04,  3.1611898e-04, -3.1453195e-04, -8.1932865e-04, -1.0076796e-03, -8.1115878e-04, -3.0829049e-04,  3.0675623e-04,  7.9910821e-04,  9.8285284e-04,  7.9120727e-04,  3.0072024e-04, -2.9923598e-04, -7.7954949e-04, -9.5883538e-04, -7.7190359e-04, -2.9339483e-04,  2.9195802e-04,  7.6061848e-04,  9.3558576e-04,  7.5321468e-04,  2.8630183e-04, -2.8491009e-04, -7.4228355e-04, -9.1306545e-04, -7.3510981e-04, -2.7942967e-04,  2.7808078e-04,  7.2451525e-04,  8.9123855e-04,  7.1756038e-04,  2.7276757e-04, -2.7145945e-04, -7.0728614e-04, -8.7007163e-04, -7.0053967e-04, -2.6630546e-04,  2.6503621e-04,  6.9057061e-04,  8.4953345e-04,  6.8402278e-04,  2.6003398e-04, -2.5880177e-04, -6.7434473e-04, -8.2959484e-04, -6.6798642e-04, -2.5394433e-04,  2.5274748e-04,  6.5858614e-04,  8.1022851e-04,  6.5240881e-04,  2.4802830e-04, -2.4686524e-04, -6.4327389e-04, -7.9140890e-04, -6.3726952e-04, -2.4227820e-04,  2.4114745e-04,  6.2838834e-04,  7.7311206e-04,  6.2254944e-04,  2.3668681e-04, -2.3558698e-04, -6.1391108e-04, -7.5531551e-04, -6.0823059e-04, -2.3124737e-04,  2.3017715e-04,  5.9982482e-04,  7.3799815e-04,  5.9429612e-04,  2.2595350e-04, -2.2491166e-04, -5.8611330e-04, -7.2114011e-04, -5.8073017e-04, -2.2079922e-04,  2.1978462e-04,  5.7276123e-04,  7.0472273e-04,  5.6751779e-04,  2.1577890e-04, -2.1479044e-04, -5.5975421e-04, -6.8872843e-04, -5.5464495e-04, -2.1088723e-04,  2.0992389e-04,  5.4707867e-04,  6.7314061e-04,  5.4209837e-04,  2.0611921e-04, -2.0518002e-04, -5.3472180e-04, -6.5794365e-04, -5.2986556e-04, -2.0147011e-04,  2.0055416e-04,  5.2267154e-04,  6.4312278e-04,  5.1793470e-04,  1.9693548e-04, -1.9604191e-04, -5.1091645e-04, -6.2866405e-04, -5.0629464e-04, -1.9251109e-04,  1.9163909e-04,  4.9944576e-04,  6.1455426e-04,  4.9493481e-04,  1.8819297e-04, -1.8734176e-04, -4.8824925e-04, -6.0078094e-04, -4.8384523e-04, -1.8397733e-04,  1.8314619e-04,  4.7731725e-04,  5.8733226e-04,  4.7301645e-04,  1.7986061e-04, -1.7904883e-04, -4.6664061e-04, -5.7419702e-04, -4.6243949e-04, -1.7583941e-04,  1.7504635e-04,  4.5621063e-04,  5.6136459e-04,  4.5210584e-04,  1.7191052e-04, -1.7113555e-04, -4.4601907e-04, -5.4882490e-04, -4.4200744e-04, -1.6807089e-04,  1.6731342e-04,  4.3605811e-04,  5.3656837e-04,  4.3213662e-04,  1.6431762e-04, -1.6357709e-04, -4.2632032e-04, -5.2458591e-04, -4.2248610e-04, -1.6064796e-04,  1.5992382e-04,  4.1679863e-04,  5.1286886e-04,  4.1304894e-04,  1.5705928e-04, -1.5635104e-04, -4.0748631e-04, -5.0140900e-04, -4.0381856e-04, -1.5354909e-04,  1.5285626e-04,  3.9837697e-04,  4.9019849e-04,  3.9478869e-04,  1.5011503e-04, -1.4943715e-04, -3.8946450e-04, -4.7922988e-04, -3.8595333e-04, -1.4675482e-04,  1.4609145e-04,  3.8074311e-04,  4.6849605e-04,  3.7730680e-04,  1.4346631e-04, -1.4281703e-04, -3.7220725e-04, -4.5799022e-04, -3.6884366e-04, -1.4024745e-04,  1.3961186e-04,  3.6385164e-04,  4.4770592e-04,  3.6055873e-04,  1.3709627e-04, -1.3647399e-04, -3.5567123e-04, -4.3763697e-04, -3.5244704e-04, -1.3401089e-04,  1.3340156e-04,  3.4766122e-04,  4.2777748e-04,  3.4450388e-04,  1.3098954e-04, -1.3039280e-04, -3.3981698e-04, -4.1812179e-04, -3.3672471e-04, -1.2803049e-04,  1.2744601e-04,  3.3213412e-04,  4.0866452e-04,  3.2910522e-04,  1.2513211e-04, -1.2455957e-04, -3.2460844e-04, -3.9940051e-04, -3.2164126e-04, -1.2229283e-04,  1.2173193e-04,  3.1723589e-04,  3.9032482e-04,  3.1432888e-04,  1.1951115e-04, -1.1896160e-04, -3.1001262e-04, -3.8143271e-04, -3.0716427e-04, -1.1678563e-04,  1.1624715e-04,  3.0293492e-04,  3.7271966e-04,  3.0014381e-04,  1.1411491e-04, -1.1358722e-04, -2.9599926e-04, -3.6418132e-04, -2.9326400e-04, -1.1149765e-04,  1.1098050e-04,  2.8920224e-04,  3.5581352e-04,  2.8652151e-04,  1.0893258e-04, -1.0842573e-04, -2.8254059e-04, -3.4761225e-04, -2.7991312e-04, -1.0641850e-04,  1.0592170e-04,  2.7601117e-04,  3.3957369e-04,  2.7343575e-04,  1.0395424e-04, -1.0346727e-04, -2.6961098e-04, -3.3169414e-04, -2.6708644e-04, -1.0153867e-04,  1.0106131e-04,  2.6333714e-04,  3.2397006e-04,  2.6086235e-04,  9.9170719e-05, -9.8702750e-05, -2.5718685e-04, -3.1639803e-04, -2.5476073e-04, -9.6849344e-05,  9.6390570e-05,  2.5115745e-04,  3.0897479e-04,  2.4877896e-04,  9.4573549e-05, -9.4123775e-05, -2.4524637e-04, -3.0169716e-04, -2.4291451e-04, -9.2342375e-05,  9.1901413e-05,  2.3945112e-04,  2.9456212e-04,  2.3716492e-04,  9.0154897e-05, -8.9722565e-05, -2.3376933e-04, -2.8756675e-04, -2.3152786e-04, -8.8010223e-05,  8.7586348e-05,  2.2819869e-04,  2.8070820e-04,  2.2600106e-04,  8.5907494e-05, -8.5491909e-05, -2.2273699e-04, -2.7398378e-04, -2.2058234e-04, -8.3845884e-05,  8.3438425e-05,  2.1738210e-04,  2.6739086e-04,  2.1526958e-04,  8.1824591e-05, -8.1425103e-05, -2.1213194e-04, -2.6092690e-04, -2.1006075e-04, -7.9842847e-05,  7.9451177e-05,  2.0698453e-04,  2.5458947e-04,  2.0495390e-04,  7.7899904e-05, -7.7515908e-05, -2.0193794e-04, -2.4837619e-04, -1.9994712e-04, -7.5995045e-05,  7.5618582e-05,  1.9699032e-04,  2.4228480e-04,  1.9503858e-04,  7.4127574e-05, -7.3758506e-05, -1.9213988e-04, -2.3631308e-04, -1.9022651e-04, -7.2296817e-05,  7.1935014e-05,  1.8738486e-04,  2.3045890e-04,  1.8550920e-04,  7.0502126e-05, -7.0147460e-05, -1.8272360e-04, -2.2472019e-04, -1.8088498e-04, -6.8742869e-05,  6.8395216e-05,  1.7815447e-04,  2.1909497e-04,  1.7635225e-04,  6.7018438e-05, -6.6677679e-05, -1.7367588e-04, -2.1358129e-04, -1.7190946e-04, -6.5328242e-05,  6.4994260e-05,  1.6928632e-04,  2.0817728e-04,  1.6755509e-04,  6.3671708e-05, -6.3344391e-05, -1.6498430e-04, -2.0288112e-04, -1.6328768e-04, -6.2048281e-05,  6.1727521e-05,  1.6076839e-04,  1.9769104e-04,  1.5910582e-04,  6.0457423e-05, -6.0143114e-05, -1.5663719e-04, -1.9260534e-04, -1.5500812e-04, -5.8898612e-05,  5.8590650e-05,  1.5258935e-04,  1.8762235e-04,  1.5099326e-04,  5.7371339e-05, -5.7069626e-05, -1.4862357e-04, -1.8274046e-04, -1.4705994e-04, -5.5875113e-05,  5.5579551e-05,  1.4473855e-04,  1.7795811e-04,  1.4320689e-04,  5.4409454e-05, -5.4119949e-05, -1.4093308e-04, -1.7327376e-04, -1.3943288e-04, -5.2973897e-05,  5.2690357e-05,  1.3720593e-04,  1.6868594e-04,  1.3573673e-04,  5.1567987e-05, -5.1290324e-05, -1.3355593e-04, -1.6419320e-04, -1.3211728e-04, -5.0191286e-05,  4.9919412e-05,  1.2998195e-04,  1.5979414e-04,  1.2857339e-04,  4.8843362e-05, -4.8577194e-05, -1.2648287e-04, -1.5548740e-04, -1.2510397e-04, -4.7523799e-05,  4.7263254e-05,  1.2305761e-04,  1.5127163e-04,  1.2170793e-04,  4.6232189e-05, -4.5977186e-05, -1.1970511e-04, -1.4714554e-04, -1.1838425e-04, -4.4968134e-05,  4.4718595e-05,  1.1642434e-04,  1.4310788e-04,  1.1513189e-04,  4.3731246e-05, -4.3487095e-05, -1.1321430e-04, -1.3915738e-04, -1.1194986e-04, -4.2521148e-05,  4.2282311e-05,  1.1007400e-04,  1.3529287e-04,  1.0883720e-04,  4.1337471e-05, -4.1103874e-05, -1.0700250e-04, -1.3151314e-04, -1.0579294e-04, -4.0179853e-05,  3.9951425e-05,  1.0399884e-04,  1.2781706e-04,  1.0281618e-04,  3.9047942e-05, -3.8824614e-05, -1.0106213e-04, -1.2420350e-04, -9.9905986e-05, -3.7941394e-05,  3.7723098e-05,  9.8191460e-05,  1.2067135e-04,  9.7061488e-05,  3.6859871e-05, -3.6646540e-05, -9.5385960e-05, -1.1721955e-04, -9.4281816e-05, -3.5803044e-05,  3.5594613e-05,  9.2644774e-05,  1.1384703e-04,  9.1566119e-05,  3.4770589e-05, -3.4566995e-05, -8.9967063e-05, -1.1055276e-04, -8.8913566e-05, -3.3762190e-05,  3.3563370e-05,  8.7352004e-05,  1.0733574e-04,  8.6323343e-05,  3.2777538e-05, -3.2583430e-05, -8.4798794e-05, -1.0419497e-04, -8.3794651e-05, -3.1816327e-05,  3.1626872e-05,  8.2306643e-05,  1.0112948e-04,  8.1326705e-05,  3.0878262e-05, -3.0693400e-05, -7.9874777e-05, -9.8138322e-05, -7.8918739e-05, -2.9963047e-05,  2.9782721e-05,  7.7502434e-05,  9.5220550e-05,  7.6569997e-05,  2.9070398e-05, -2.8894551e-05, -7.5188870e-05, -9.2375249e-05, -7.4279738e-05, -2.8200031e-05,  2.8028607e-05,  7.2933352e-05,  8.9601517e-05,  7.2047235e-05,  2.7351670e-05, -2.7184614e-05, -7.0735158e-05, -8.6898466e-05, -6.9871772e-05, -2.6525042e-05,  2.6362301e-05,  6.8593581e-05,  8.4265224e-05,  6.7752646e-05,  2.5719880e-05, -2.5561400e-05, -6.6507924e-05, -8.1700932e-05, -6.5689165e-05, -2.4935920e-05,  2.4781650e-05,  6.4477503e-05,  7.9204748e-05,  6.3680649e-05,  2.4172903e-05, -2.4022790e-05, -6.2501642e-05, -7.6775839e-05, -6.1726426e-05, -2.3430574e-05,  2.3284568e-05,  6.0579678e-05,  7.4413387e-05,  5.9825836e-05,  2.2708680e-05, -2.2566732e-05, -5.8710955e-05, -7.2116585e-05, -5.7978229e-05, -2.2006975e-05,  2.1869035e-05,  5.6894830e-05,  6.9884639e-05,  5.6182964e-05,  2.1325215e-05, -2.1191235e-05, -5.5130666e-05, -6.7716765e-05, -5.4439409e-05, -2.0663157e-05,  2.0533089e-05,  5.3417836e-05,  6.5612189e-05,  5.2746939e-05,  2.0020566e-05, -1.9894362e-05, -5.1755722e-05, -6.3570149e-05, -5.1104940e-05, -1.9397205e-05,  1.9274820e-05,  5.0143713e-05,  6.1589893e-05,  4.9512803e-05,  1.8792845e-05, -1.8674232e-05, -4.8581205e-05, -5.9670676e-05, -4.7969928e-05, -1.8207255e-05,  1.8092370e-05,  4.7067603e-05,  5.7811763e-05,  4.6475723e-05,  1.7640211e-05, -1.7529008e-05, -4.5602318e-05, -5.6012430e-05, -4.5029602e-05, -1.7091488e-05,  1.6983923e-05,  4.4184769e-05,  5.4271958e-05,  4.3630986e-05,  1.6560867e-05, -1.6456896e-05, -4.2814380e-05, -5.2589639e-05, -4.2279302e-05, -1.6048129e-05,  1.5947708e-05,  4.1490582e-05,  5.0964769e-05,  4.0973983e-05,  1.5553057e-05, -1.5456144e-05, -4.0212813e-05, -4.9396655e-05, -3.9714468e-05, -1.5075439e-05,  1.4981992e-05,  3.8980514e-05,  4.7884609e-05,  3.8500203e-05,  1.4615063e-05, -1.4525038e-05, -3.7793135e-05, -4.6427951e-05, -3.7330638e-05, -1.4171719e-05,  1.4085075e-05,  3.6650128e-05,  4.5026006e-05,  3.6205229e-05,  1.3745199e-05, -1.3661896e-05, -3.5550953e-05, -4.3678107e-05, -3.5123436e-05, -1.3335298e-05,  1.3255294e-05,  3.4495073e-05,  4.2383591e-05,  3.4084724e-05,  1.2941813e-05, -1.2865067e-05, -3.3481956e-05, -4.1141803e-05, -3.3088565e-05, -1.2564540e-05,  1.2491013e-05,  3.2511075e-05,  3.9952092e-05,  3.2134432e-05,  1.2203280e-05, -1.2132932e-05, -3.1581907e-05, -3.8813812e-05, -3.1221804e-05, -1.1857834e-05,  1.1790625e-05,  3.0693934e-05,  3.7726324e-05,  3.0350164e-05,  1.1528005e-05, -1.1463896e-05, -2.9846641e-05, -3.6688993e-05, -2.9518999e-05, -1.1213597e-05,  1.1152549e-05,  2.9039517e-05,  3.5701188e-05,  2.8727801e-05,  1.0914416e-05, -1.0856390e-05, -2.8272054e-05, -3.4762282e-05, -2.7976062e-05, -1.0630269e-05,  1.0575227e-05,  2.7543750e-05,  3.3871655e-05,  2.7263281e-05,  1.0360964e-05, -1.0308867e-05, -2.6854105e-05, -3.3028689e-05, -2.6588960e-05, -1.0106311e-05,  1.0057123e-05,  2.6202621e-05,  3.2232772e-05,  2.5952602e-05,  9.8661220e-06, -9.8198031e-06, -2.5588805e-05, -3.1483292e-05, -2.5353716e-05, -9.6402078e-06,  9.5967216e-06,  2.5012166e-05,  3.0779646e-05,  2.4791811e-05,  9.4283823e-06, -9.3876915e-06, -2.4472218e-05, -3.0121231e-05, -2.4266403e-05, -9.2304599e-06,  9.1925276e-06,  2.3968474e-05,  2.9507449e-05,  2.3777006e-05,  9.0462561e-06, -9.0110454e-06, -2.3500454e-05, -2.8937704e-05, -2.3323141e-05, -8.8755873e-06,  8.8430617e-06,  2.3067678e-05,  2.8411405e-05,  2.2904328e-05,  8.7182712e-06, -8.6883943e-06, -2.2669668e-05, -2.7927963e-05, -2.2520093e-05, -8.5741262e-06,  8.5468619e-06,  2.2305952e-05,  2.7486793e-05,  2.2169962e-05,  8.4429718e-06, -8.4182839e-06, -2.1976058e-05, -2.7087312e-05, -2.1853464e-05, -8.3246281e-06,  8.3024810e-06,  2.1679514e-05,  2.6728940e-05,  2.1570131e-05,  8.2189165e-06, -8.1992744e-06, -2.1415856e-05, -2.6411100e-05, -2.1319496e-05, -8.1256590e-06,  8.1084864e-06,  2.1184616e-05,  2.6133219e-05,  2.1101094e-05,  8.0446784e-06, -8.0299399e-06, -2.0985333e-05, -2.5894723e-05, -2.0914465e-05, -7.9757983e-06,  7.9634589e-06,  2.0817546e-05,  2.5695045e-05,  2.0759147e-05,  7.9188433e-06, -7.9088679e-06, -2.0680796e-05, -2.5533617e-05, -2.0634683e-05, -7.8736384e-06};


	int32_t numBlock=RECORDING_BUFLEN/NumTaps;
	//int64_t pState=2;
	//int8_t postShift=0;
	arm_fir_instance_f32 S;

	arm_fir_init_f32(&S, NumTaps, firCoeffs32, firStateF32, blockSize);
	  for(int i=0; i < numBlock; i++)
	  {
	    arm_fir_f32(&S, recordingBuffer + (i * blockSize), recordingBuffer + (i * blockSize), blockSize);
	  }

	//arm_biquad_cas_df1_32x64_init_q31(bruh, 1, pCoeffs, pState, postShift);
	//arm_biquad_cas_df1_32x64_q31(bruh, recordingBuffer, recordingBuffer, 5);

	transformBufferToDAC(recordingBuffer,RECORDING_BUFLEN,testingBuffer, sendingBuffer);
	if (HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, testingBuffer, RECORDING_BUFLEN, DAC_ALIGN_8B_R) != HAL_OK) {
		printf("Failed to start DAC");
	}

	printf("***Testing rig end*** \r\n");
	  while(buttonPressed==false){
	  	__WFI(); // Waiting for interrupt mode?
	  }
	while(wifi_connect_to_board(REMOTE_IP_0, REMOTE_IP_1, REMOTE_IP_2, REMOTE_IP_3) != WIFI_STATUS_OK) {
		printf("Retrying to connect to board ... \r\n");
	}
	// successfully connected to board
	printf("Connected to other board. \r\n");
	//wifi_send_data_to_board("test");

    while (true) {
    printf("Waiting for button press to send mic data.\r\n");
    while(buttonPressed==false){
    	__WFI(); // Waiting for interrupt mode?
    }
    buttonPressed = false;
   // while (buttonPressed == false) {
    	// IF YOU WANT TO USE THE HALF_FINISHED THING U HAVE TO SET DMA TO CIRCULAR IN hal_msp.c
    	if (HAL_DFSDM_FilterRegularStart_DMA(&hdfsdm1_filter0, recordingBuffer, RECORDING_BUFLEN) != HAL_OK) {
    	  printf("Failed to start DFSDM\r\n");
    	}
    	/*
		while (!DFSDM_half_finished) {
		}
		// need to transform only first half
		printf("DFSDM half finished, sending first half of buffer");
		DFSDM_half_finished = false;
		transformBufferToDAC(recordingBuffer, VOICE_BUFLEN/2, sendingBuffer);
		HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, recordingBuffer, VOICE_BUFLEN/2, DAC_ALIGN_8B_R);
		//wifi_send_data_to_board(sendingBuffer);
		 */
		while (!DFSDM_finished) {
		}

		DFSDM_finished = false;
		HAL_DFSDM_FilterRegularStop_DMA(&hdfsdm1_filter0); //  this is necessary
		/* Need to transform only the last half*/
		/*
		transformBufferToDAC(&(recordingBuffer[VOICE_BUFLEN/2]), VOICE_BUFLEN/2, sendingBuffer);
		HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, &(recordingBuffer[VOICE_BUFLEN/2]), VOICE_BUFLEN/2, DAC_ALIGN_8B_R);
		wifi_send_data_to_board(sendingBuffer);
		*/
		/* test playback on this board */
		//transformBufferToDAC(recordingBuffer,RECORDING_BUFLEN, sendingBuffer);
		//if (HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, recordingBuffer, RECORDING_BUFLEN, DAC_ALIGN_8B_R) != HAL_OK) {
		//  printf("Failed to start DAC");
		//}

		printf("Sending audio to other board \r\n");

		uint16_t step = RECORDING_BUFLEN/SENDING_BUFLEN;
		for (int i = 0 ; i < step; i++) {
			if(wifi_send_data_to_board(&(sendingBuffer[i*SENDING_BUFLEN])) == WIFI_STATUS_OK) {
				printf("Sent packet %d\r\n", i);
			}
		}
   // }
    buttonPressed = false;
  }
}

/**
 * This function attempts to sent an HTTP request to the other board, which contains some data.
 */
static int wifi_send_data_to_board(uint8_t* data) {
	// first try to connect to the board

    if (WIFI_OpenClientConnection(REMOTE_SOCKET, WIFI_TCP_PROTOCOL, "test", RemoteIP_Addr, REMOTE_PORT, PORT) != WIFI_STATUS_OK) {
    	printf("Could not connect to other board \r\n");
    	return -1;
    }

    printf("Connected to other board\r\n");
	//char* http_header = "HTTP/1.0 200 OK\r\nContent-Type: text/plain\r\n";
    //strcat(http_header, data);

    uint16_t actualSent;
    /*
    for (int i = 0; i < 20; i++) {
    	if (WIFI_SendData(REMOTE_SOCKET, &(data[i*1000]), SENDING_BUFLEN, &actualSent, WIFI_WRITE_TIMEOUT) == WIFI_STATUS_OK) {
			printf("Sent packet %d \r\n", i);
			//memset(data, 0, strlen(data));
			return -1;
    	}
    }
    */
	if (WIFI_SendData(REMOTE_SOCKET,data, SENDING_BUFLEN, &actualSent, WIFI_WRITE_TIMEOUT) != WIFI_STATUS_OK) {
		printf("Could not send data \r\n");
		//memset(data, 0, strlen(data));
		return -1;
	}

    //memset(data, 0, strlen(data)); // maybe we can remove this
    // wait for resp from receiving board before proceeding
    uint8_t resp[100];
    memset(resp, 0, strlen((char*)resp));
    uint16_t actualReceived;

    while(WIFI_ReceiveData(REMOTE_SOCKET, resp, 100, &actualReceived, WIFI_READ_TIMEOUT) != WIFI_STATUS_OK) {

    }
    printf("Received response from receiving board: %s\r\n", resp);

    // close connection

    if (WIFI_CloseClientConnection(REMOTE_SOCKET) != WIFI_STATUS_OK) {
    	printf("Could not close client connection \r\n");
    	return -1;
    }
    printf("Closed client connection \r\n");

    return WIFI_STATUS_OK;
}
/**
 * This function takes care of:
 * - starting the es-wifi module
 * - connecting to a network whose credentials are provided in code
 * - connect to the receiving board using ip address provided in parameters of this function
 * - returns -1 if anything bad happens
 * - returns WIFI_STATUS_OK if successful
 */
static int wifi_connect_to_board(uint8_t ip0, uint8_t ip1, uint8_t ip2, uint8_t ip3) {
	// start wifi module
	wifi_start();


	// connect to existing AP
	if (WIFI_Connect(SSID, PASSWORD, SECURITY) == WIFI_STATUS_OK)
	{
	  if(WIFI_GetIP_Address(IP_Addr, sizeof(IP_Addr)) == WIFI_STATUS_OK)
	  {
		LOG(("eS-WiFi module connected: got IP Address : %d.%d.%d.%d\r\n",
				 IP_Addr[0],
				 IP_Addr[1],
				 IP_Addr[2],
				 IP_Addr[3]));
	  }
	  else
	  {
		LOG((" ERROR : es-wifi module CANNOT get IP address\r\n"));
		return -1;
	  }
	}
	else
	{
	   LOG(("ERROR : es-wifi module NOT connected\r\n"));
	   return -1;
	}
	// start server (?)

	if (WIFI_STATUS_OK != WIFI_StartServer(SOCKET, WIFI_TCP_PROTOCOL, 1, "", PORT)) {
		printf("ERROR: Could not start server \r\n");
		return -1;
	}

	// trying to connect to other board using IP addr
    RemoteIP_Addr[0] = ip0;
    RemoteIP_Addr[1] = ip1;
    RemoteIP_Addr[2] = ip2;
    RemoteIP_Addr[3] = ip3;
    if (WIFI_OpenClientConnection(REMOTE_SOCKET, WIFI_TCP_PROTOCOL, "test", RemoteIP_Addr, REMOTE_PORT, PORT) != WIFI_STATUS_OK) {
    	printf("Could not connect to other board \r\n");
    	return -1;
    }

    // we need to disconnect at the end since we will be reconnecting to send data
    // close connection
    if (WIFI_CloseClientConnection(REMOTE_SOCKET) != WIFI_STATUS_OK) {
    	printf("Could not close client connection \r\n");
    	return -1;
    }

    return WIFI_STATUS_OK;
}

/**
  * @brief  Send HTML page
  * @param  None
  * @retval None
  */


static int wifi_start(void)
{
  uint8_t  MAC_Addr[6];

 /*Initialize and use WIFI module */
  if(WIFI_Init() ==  WIFI_STATUS_OK)
  {
    LOG(("ES-WIFI Initialized.\r\n"));
    if(WIFI_GetMAC_Address(MAC_Addr, sizeof(MAC_Addr)) == WIFI_STATUS_OK)
    {
      LOG(("> eS-WiFi module MAC Address : %02X:%02X:%02X:%02X:%02X:%02X\r\n",
               MAC_Addr[0],
               MAC_Addr[1],
               MAC_Addr[2],
               MAC_Addr[3],
               MAC_Addr[4],
               MAC_Addr[5]));
    }
    else
    {
      LOG(("> ERROR : CANNOT get MAC address\r\n"));
      return -1;
    }
  }
  else
  {
    return -1;
  }
  return 0;
}

/**
 * Transforms a buffer's values into valid DAC 8bit right aligned values
 */
void transformBufferToDAC(int32_t *buffer, uint32_t recording_buffer_length, int32_t *testbuffer, uint8_t *outputBuffer) {
	// need to map buffer values to 8bit right alligned values (uint8_t)
	// from experimentation (screaming at the board): min values tend to be -3000 and max seems to be ~1000
	const int16_t MAX_VAL = 800;
	const int16_t MIN_VAL = -800;
	const float a = (255.0)/(MAX_VAL - MIN_VAL); // slope
	for (int i = 0; i < recording_buffer_length; i++) {
		int32_t val = buffer[i]; // 24-bit value
		val = val >> 8; // remove this for LOUDER but MORE SCUFFED NOISE
		// clip buffer values to within [-MIN_VAL, MAX_VAL]
		if (val <= MIN_VAL) {
			val = MIN_VAL;
		}
		if (val >= MAX_VAL) {
			val = MAX_VAL;
		}
		// scale values up by [-MIN_VAL] to make sure no negatives
		if (MIN_VAL < 0) {
			val += (-MIN_VAL);
		}
		// now the range of val should be [0, MAX_VAL-MIN_VAL], apply linear function to get DAC val
		val = round(a*val);
		if (val >= 0 && val <= 255) {
			outputBuffer[i] = (uint8_t)val; // change the buffer
			testbuffer[i]=val;
		} else {
			Error_Handler(); // should not happen
		}
	}
}

/**
  * @brief  System Clock Configuration
  *         The system Clock is configured as follow :
  *            System Clock source            = PLL (MSI)
  *            SYSCLK(Hz)                     = 80000000
  *            HCLK(Hz)                       = 80000000
  *            AHB Prescaler                  = 1
  *            APB1 Prescaler                 = 1
  *            APB2 Prescaler                 = 1
  *            MSI Frequency(Hz)              = 4000000
  *            PLL_M                          = 1
  *            PLL_N                          = 40
  *            PLL_R                          = 2
  *            PLL_P                          = 7
  *            PLL_Q                          = 4
  *            Flash Latency(WS)              = 4
  * @param  None
  * @retval None
  */
static void SystemClock_Config(void)
{
  RCC_ClkInitTypeDef RCC_ClkInitStruct;
  RCC_OscInitTypeDef RCC_OscInitStruct;

  /* MSI is enabled after System reset, activate PLL with MSI as source */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_MSI;
  RCC_OscInitStruct.MSIState = RCC_MSI_ON;
  RCC_OscInitStruct.MSIClockRange = RCC_MSIRANGE_6;
  RCC_OscInitStruct.MSICalibrationValue = RCC_MSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_MSI;
  RCC_OscInitStruct.PLL.PLLM = 1;
  RCC_OscInitStruct.PLL.PLLN = 40;
  RCC_OscInitStruct.PLL.PLLR = 2;
  RCC_OscInitStruct.PLL.PLLP = 7;
  RCC_OscInitStruct.PLL.PLLQ = 4;
  if(HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    /* Initialization Error */
    while(1);
  }

  /* Select PLL as system clock source and configure the HCLK, PCLK1 and PCLK2
     clocks dividers */
  RCC_ClkInitStruct.ClockType = (RCC_CLOCKTYPE_SYSCLK | RCC_CLOCKTYPE_HCLK | RCC_CLOCKTYPE_PCLK1 | RCC_CLOCKTYPE_PCLK2);
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;
  if(HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_4) != HAL_OK)
  {
    /* Initialization Error */
    while(1);
  }
}
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
/* USER CODE BEGIN MX_GPIO_Init_1 */
/* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();

  /*Configure GPIO pin : PC13 */
  GPIO_InitStruct.Pin = GPIO_PIN_13;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /* EXTI interrupt init*/
  HAL_NVIC_SetPriority(EXTI15_10_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);

/* USER CODE BEGIN MX_GPIO_Init_2 */
/* USER CODE END MX_GPIO_Init_2 */
}

#if defined (TERMINAL_USE)
/**
  * @brief  Retargets the C library printf function to the USART.
  * @param  None
  * @retval None
  */
PUTCHAR_PROTOTYPE
{
  /* Place your implementation of fputc here */
  /* e.g. write a character to the USART1 and Loop until the end of transmission */
  HAL_UART_Transmit(&hDiscoUart, (uint8_t *)&ch, 1, 0xFFFF);

  return ch;
}

#endif /* TERMINAL_USE */

#ifdef USE_FULL_ASSERT

/**
   * @brief Reports the name of the source file and the source line number
   * where the assert_param error has occurred.
   * @param file: pointer to the source file name
   * @param line: assert_param error line source number
   * @retval None
   */
void assert_failed(uint8_t* file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
    ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */

}

#endif

static void MX_DAC1_Init(void)
{

  /* USER CODE BEGIN DAC1_Init 0 */

  /* USER CODE END DAC1_Init 0 */

  DAC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN DAC1_Init 1 */

  /* USER CODE END DAC1_Init 1 */

  /** DAC Initialization
  */
  hdac1.Instance = DAC1;
  if (HAL_DAC_Init(&hdac1) != HAL_OK)
  {
    Error_Handler();
  }

  /** DAC channel OUT1 config
  */
  sConfig.DAC_SampleAndHold = DAC_SAMPLEANDHOLD_DISABLE;
  sConfig.DAC_Trigger = DAC_TRIGGER_T2_TRGO;
  sConfig.DAC_HighFrequency = DAC_HIGH_FREQUENCY_INTERFACE_MODE_ABOVE_80MHZ;
  sConfig.DAC_OutputBuffer = DAC_OUTPUTBUFFER_ENABLE;
  sConfig.DAC_ConnectOnChipPeripheral = DAC_CHIPCONNECT_DISABLE;
  sConfig.DAC_UserTrimming = DAC_TRIMMING_FACTORY;
  if (HAL_DAC_ConfigChannel(&hdac1, &sConfig, DAC_CHANNEL_1) != HAL_OK)
  {
    Error_Handler();
  }

  /** DAC channel OUT2 config
  */
  sConfig.DAC_Trigger = DAC_TRIGGER_NONE;
  if (HAL_DAC_ConfigChannel(&hdac1, &sConfig, DAC_CHANNEL_2) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN DAC1_Init 2 */

  /* USER CODE END DAC1_Init 2 */

}

/**
  * @brief DFSDM1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_DFSDM1_Init(void)
{

  /* USER CODE BEGIN DFSDM1_Init 0 */

  /* USER CODE END DFSDM1_Init 0 */

  /* USER CODE BEGIN DFSDM1_Init 1 */

  /* USER CODE END DFSDM1_Init 1 */
  hdfsdm1_filter0.Instance = DFSDM1_Filter0;
  hdfsdm1_filter0.Init.RegularParam.Trigger = DFSDM_FILTER_SW_TRIGGER;
  hdfsdm1_filter0.Init.RegularParam.FastMode = ENABLE;
  hdfsdm1_filter0.Init.RegularParam.DmaMode = ENABLE;
  hdfsdm1_filter0.Init.FilterParam.SincOrder = DFSDM_FILTER_FASTSINC_ORDER;
  hdfsdm1_filter0.Init.FilterParam.Oversampling = 100;
  hdfsdm1_filter0.Init.FilterParam.IntOversampling = 1;
  if (HAL_DFSDM_FilterInit(&hdfsdm1_filter0) != HAL_OK)
  {
    Error_Handler();
  }
  hdfsdm1_channel2.Instance = DFSDM1_Channel2;
  hdfsdm1_channel2.Init.OutputClock.Activation = ENABLE;
  hdfsdm1_channel2.Init.OutputClock.Selection = DFSDM_CHANNEL_OUTPUT_CLOCK_SYSTEM;
  hdfsdm1_channel2.Init.OutputClock.Divider = 50*SAMPLING_RATE_FACTOR; // CHANGED FROM 50 to 100 so that SAMPLING RATE IS 10K
  hdfsdm1_channel2.Init.Input.Multiplexer = DFSDM_CHANNEL_EXTERNAL_INPUTS;
  hdfsdm1_channel2.Init.Input.DataPacking = DFSDM_CHANNEL_STANDARD_MODE;
  hdfsdm1_channel2.Init.Input.Pins = DFSDM_CHANNEL_SAME_CHANNEL_PINS;
  hdfsdm1_channel2.Init.SerialInterface.Type = DFSDM_CHANNEL_SPI_RISING;
  hdfsdm1_channel2.Init.SerialInterface.SpiClock = DFSDM_CHANNEL_SPI_CLOCK_INTERNAL;
  hdfsdm1_channel2.Init.Awd.FilterOrder = DFSDM_CHANNEL_FASTSINC_ORDER;
  hdfsdm1_channel2.Init.Awd.Oversampling = 1;
  hdfsdm1_channel2.Init.Offset = 0;
  hdfsdm1_channel2.Init.RightBitShift = 0x00;
  if (HAL_DFSDM_ChannelInit(&hdfsdm1_channel2) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_DFSDM_FilterConfigRegChannel(&hdfsdm1_filter0, DFSDM_CHANNEL_2, DFSDM_CONTINUOUS_CONV_ON) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN DFSDM1_Init 2 */

  /* USER CODE END DFSDM1_Init 2 */

}

/**
  * @brief TIM2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM2_Init(void)
{

  /* USER CODE BEGIN TIM2_Init 0 */

  /* USER CODE END TIM2_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM2_Init 1 */

  /* USER CODE END TIM2_Init 1 */
  htim2.Instance = TIM2;
  htim2.Init.Prescaler = 0;
  htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim2.Init.Period = 5000*SAMPLING_RATE_FACTOR;
  htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim2, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_UPDATE;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim2, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM2_Init 2 */

  /* USER CODE END TIM2_Init 2 */

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMAMUX1_CLK_ENABLE();
  __HAL_RCC_DMA1_CLK_ENABLE();

  /* DMA interrupt init */
  /* DMA1_Channel1_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel1_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel1_IRQn);
  /* DMA1_Channel2_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel2_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel2_IRQn);

}

/**
  * @brief  EXTI line detection callback.
  * @param  GPIO_Pin: Specifies the port pin connected to corresponding EXTI line.
  * @retval None
  */

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
  switch (GPIO_Pin)
  {
  case (GPIO_PIN_1):
    {
      SPI_WIFI_ISR();
      break;
    }
  case (GPIO_PIN_13):
     {
      buttonPressed=1;
        break;
     }
    default:
    {
      break;
    }
  }
}
/*
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin){
	if(GPIO_Pin==GPIO_PIN_1){
	    SPI_WIFI_ISR();
	}
	else if (GPIO_Pin==USER_BUTTON_PIN)
    {
     buttonPressed=true;
    }
}*/

void HAL_DFSDM_FilterRegConvCpltCallback(DFSDM_Filter_HandleTypeDef *hdfsdm_filter) {
	DFSDM_finished = true;
}

void HAL_DFSDM_FilterRegConvHalfCpltCallback (DFSDM_Filter_HandleTypeDef * hdfsdm_filter) {
	DFSDM_half_finished = true;
}
/**
  * @brief  SPI3 line detection callback.
  * @param  None
  * @retval None
  */
void SPI3_IRQHandler(void)
{
  HAL_SPI_IRQHandler(&hspi);
}

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}
#endif




/**
  ******************************************************************************
  * @file    Wifi/WiFi_HTTP_Server/src/main.c
  * @author  MCD Application Team
  * @brief   This file provides main program functions
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2017 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
//#define SENDING_ACTIVE // Comment/Uncomment this depending on if you are this board as sending/receiving
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include <math.h>
#include "sending_board_config.h"
#define ARM_MATH_CM4
#include "arm_math.h"

#ifdef SENDING_ACTIVE
/* Private defines -----------------------------------------------------------*/
#define PORT           10 // PORT of this board [sending board]
#define REMOTE_PORT    80 // PORT Of the receiving board
#define REMOTE_SOCKET	0 // SOCKET of the receiving board
#define TERMINAL_USE

#define WIFI_WRITE_TIMEOUT 10000
#define WIFI_READ_TIMEOUT  10000
#define SOCKET                 1
#define SENDING_BUFLEN 1000
#define RECORDING_BUFLEN 40000
#define SAMPLING_RATE_FACTOR 2 // DEFAULT SAMPLING IS AT 20 kHz, a higher factor means a lower sampling rate


#ifdef  TERMINAL_USE
#define LOG(a) printf a
#else
#define LOG(a)
#endif

/* Private typedef------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
DAC_HandleTypeDef hdac1;
DMA_HandleTypeDef hdma_dac1_ch1;
DFSDM_Filter_HandleTypeDef hdfsdm1_filter0;
DFSDM_Channel_HandleTypeDef hdfsdm1_channel2;
DMA_HandleTypeDef hdma_dfsdm1_flt0;
TIM_HandleTypeDef htim2;
#if defined (TERMINAL_USE)
extern UART_HandleTypeDef hDiscoUart;
#endif /* TERMINAL_USE */

//static  uint8_t http[1024];
static  uint8_t  IP_Addr[4];
static uint8_t RemoteIP_Addr[4]; // address of receiving board
static int32_t recordingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static int32_t testingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static uint8_t sendingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime

/** INTERRUPT FLAGS **/
volatile uint8_t DFSDM_half_finished=false;
volatile uint8_t DFSDM_finished=false;
volatile uint8_t buttonPressed=0;

/* Private function prototypes -----------------------------------------------*/
#if defined (TERMINAL_USE)
#ifdef __GNUC__
/* With GCC, small printf (option LD Linker->Libraries->Small printf
   set to 'Yes') calls __io_putchar() */
#define PUTCHAR_PROTOTYPE int __io_putchar(int ch)
#else
#define PUTCHAR_PROTOTYPE int fputc(int ch, FILE *f)
#endif /* __GNUC__ */
#endif /* TERMINAL_USE */

static void SystemClock_Config(void);
static int wifi_start(void);
static int wifi_connect_to_board(uint8_t ip0, uint8_t ip1, uint8_t ip2, uint8_t ip3);
static int wifi_send_data_to_board(uint8_t* data);

/* MX Inits */
static void MX_DMA_Init(void);
static void MX_DAC1_Init(void);
static void MX_TIM2_Init(void);
static void MX_DFSDM1_Init(void);
static void MX_GPIO_Init(void);

/* Private functions ---------------------------------------------------------*/
void transformBufferToDAC(int32_t *buffer, uint32_t recording_buffer_length, int32_t *testbuffer, uint8_t *outputBuffer);
/**
  * @brief  Main program
  * @param  None
  * @retval None
  */
int main(void)
{
  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* Configure the system clock */
  SystemClock_Config();

  /* Configure LED2 */
  BSP_LED_Init(LED2);

  /* Initialize all configured peripherals */
  MX_DMA_Init();
  MX_DAC1_Init();
  MX_TIM2_Init();
  MX_DFSDM1_Init();
  MX_GPIO_Init();


  //HAL_DAC_Start(&hdac1, DAC_CHANNEL_1);
  HAL_TIM_Base_Start_IT(&htim2); // the _IT at the end of fn. means interrupt

  /* WIFI Web Server demonstration */
#if defined (TERMINAL_USE)
  /* Initialize all configured peripherals */
  hDiscoUart.Instance = DISCOVERY_COM1;
  hDiscoUart.Init.BaudRate = 115200;
  hDiscoUart.Init.WordLength = UART_WORDLENGTH_8B;
  hDiscoUart.Init.StopBits = UART_STOPBITS_1;
  hDiscoUart.Init.Parity = UART_PARITY_NONE;
  hDiscoUart.Init.Mode = UART_MODE_TX_RX;
  hDiscoUart.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  hDiscoUart.Init.OverSampling = UART_OVERSAMPLING_16;
  hDiscoUart.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  hDiscoUart.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;


  BSP_COM_Init(COM1, &hDiscoUart);

  /* resetting buffers */
  memset(recordingBuffer, 0, RECORDING_BUFLEN*sizeof(int32_t));
  memset(sendingBuffer, 0, SENDING_BUFLEN);

  printf("****** SENDING BOARD Initiating ****** \r\n");

#endif /* TERMINAL_USE */

  printf("***Testing rig begin*** \r\n");
  printf("Waiting for button press to send mic data.\r\n");
  while(buttonPressed==false){
  	__WFI(); // Waiting for interrupt mode?
  }
  buttonPressed=false;
	if (HAL_DFSDM_FilterRegularStart_DMA(&hdfsdm1_filter0, recordingBuffer, RECORDING_BUFLEN) != HAL_OK) {
	  printf("Failed to start DFSDM\r\n");
	}
	while (!DFSDM_finished) {
	}
	DFSDM_finished = false;
	HAL_DFSDM_FilterRegularStop_DMA(&hdfsdm1_filter0);
	transformBufferToDAC(recordingBuffer,RECORDING_BUFLEN,testingBuffer, sendingBuffer);
	/*
	for (int i=0; i<RECORDING_BUFLEN;i++){
		printf("%d ", testingBuffer[i]);
	}
	*/
	if (HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, testingBuffer, RECORDING_BUFLEN, DAC_ALIGN_8B_R) != HAL_OK) {
		printf("Failed to start DAC");
	}

	printf("Part 2");

    while(buttonPressed==false){
    	__WFI(); // Waiting for interrupt mode?
    }
    buttonPressed = false;

	int32_t NumTaps=2000;
	int32_t blockSize=20;
	float32_t firStateF32[2*blockSize+NumTaps-1];

	float32_t firCoeffs32[1999]={-1.2008008e-06,-3.5954434e-06,-5.9634157e-06,-8.2840250e-06,-1.0536939e-05,-1.2702357e-05,-1.4761183e-05,-1.6695187e-05,-1.8487161e-05,-2.0121069e-05,-2.1582189e-05,-2.2857236e-05,-2.3934487e-05,-2.4803878e-05,-2.5457101e-05,-2.5887681e-05,-2.6091032e-05,-2.6064509e-05,-2.5807438e-05,-2.5321126e-05,-2.4608862e-05,-2.3675898e-05,-2.2529408e-05,-2.1178444e-05,-1.9633861e-05,-1.7908237e-05,-1.6015775e-05,-1.3972185e-05,-1.1794568e-05,-9.5012672e-06,-7.1117260e-06,-4.6463245e-06,-2.1262127e-06, 4.2686609e-07, 2.9907571e-06, 5.5430809e-06, 8.0614228e-06, 1.0523525e-05, 1.2907476e-05, 1.5191904e-05, 1.7356158e-05, 1.9380495e-05, 2.1246250e-05, 2.2936007e-05, 2.4433756e-05, 2.5725042e-05, 2.6797096e-05, 2.7638962e-05, 2.8241600e-05, 2.8597983e-05, 2.8703169e-05, 2.8554362e-05, 2.8150952e-05, 2.7494538e-05, 2.6588932e-05, 2.5440146e-05, 2.4056354e-05, 2.2447846e-05, 2.0626952e-05, 1.8607956e-05, 1.6406988e-05, 1.4041903e-05, 1.1532139e-05, 8.8985670e-06, 6.1633196e-06, 3.3496140e-06, 4.8155969e-07,-2.4160417e-06,-5.3179047e-06,-8.1984748e-06,-1.1032147e-05,-1.3793488e-05,-1.6457458e-05,-1.8999631e-05,-2.1396417e-05,-2.3625270e-05,-2.5664897e-05,-2.7495457e-05,-2.9098745e-05,-3.0458372e-05,-3.1559920e-05,-3.2391095e-05,-3.2941850e-05,-3.3204501e-05,-3.3173815e-05,-3.2847084e-05,-3.2224177e-05,-3.1307563e-05,-3.0102325e-05,-2.8616137e-05,-2.6859230e-05,-2.4844329e-05,-2.2586565e-05,-2.0103378e-05,-1.7414379e-05,-1.4541213e-05,-1.1507382e-05,-8.3380676e-06,-5.0599244e-06,-1.7008643e-06, 1.7101747e-06, 5.1434708e-06, 8.5687711e-06, 1.1955552e-05, 1.5273282e-05, 1.8491695e-05, 2.1581057e-05, 2.4512432e-05, 2.7257953e-05, 2.9791074e-05, 3.2086822e-05, 3.4122037e-05, 3.5875598e-05, 3.7328631e-05, 3.8464707e-05, 3.9270013e-05, 3.9733507e-05, 3.9847049e-05, 3.9605510e-05, 3.9006851e-05, 3.8052179e-05, 3.6745779e-05, 3.5095110e-05, 3.3110782e-05, 3.0806500e-05, 2.8198979e-05, 2.5307832e-05, 2.2155439e-05, 1.8766771e-05, 1.5169212e-05, 1.1392339e-05, 7.4676892e-06, 3.4285035e-06,-6.9054681e-07,-4.8536510e-06,-9.0241625e-06,-1.3164915e-05,-1.7238544e-05,-2.1207822e-05,-2.5035986e-05,-2.8687074e-05,-3.2126254e-05,-3.5320149e-05,-3.8237154e-05,-4.0847737e-05,-4.3124732e-05,-4.5043611e-05,-4.6582733e-05,-4.7723578e-05,-4.8450949e-05,-4.8753155e-05,-4.8622152e-05,-4.8053669e-05,-4.7047292e-05,-4.5606515e-05,-4.3738763e-05,-4.1455372e-05,-3.8771542e-05,-3.5706247e-05,-3.2282117e-05,-2.8525281e-05,-2.4465178e-05,-2.0134338e-05,-1.5568129e-05,-1.0804478e-05,-5.8835662e-06,-8.4749452e-07, 4.2600656e-06, 9.3942439e-06, 1.4509358e-05, 1.9559310e-05, 2.4497998e-05, 2.9279726e-05, 3.3859620e-05, 3.8194040e-05, 4.2240988e-05, 4.5960503e-05, 4.9315053e-05, 5.2269892e-05, 5.4793419e-05, 5.6857492e-05, 5.8437732e-05, 5.9513789e-05, 6.0069574e-05, 6.0093461e-05, 5.9578447e-05, 5.8522277e-05, 5.6927524e-05, 5.4801626e-05, 5.2156888e-05, 4.9010426e-05, 4.5384083e-05, 4.1304289e-05, 3.6801883e-05, 3.1911895e-05, 2.6673283e-05, 2.1128634e-05, 1.5323828e-05, 9.3076692e-06, 3.1314812e-06,-3.1513178e-06,-9.4856707e-06,-1.5815355e-05,-2.2083474e-05,-2.8232958e-05,-3.4207078e-05,-3.9949957e-05,-4.5407087e-05,-5.0525834e-05,-5.5255936e-05,-5.9549989e-05,-6.3363901e-05,-6.6657343e-05,-6.9394149e-05,-7.1542700e-05,-7.3076267e-05,-7.3973309e-05,-7.4217739e-05,-7.3799130e-05,-7.2712890e-05,-7.0960368e-05,-6.8548926e-05,-6.5491940e-05,-6.1808762e-05,-5.7524618e-05,-5.2670457e-05,-4.7282741e-05,-4.1403191e-05,-3.5078474e-05,-2.8359845e-05,-2.1302745e-05,-1.3966352e-05,-6.4130970e-06, 1.2918594e-06, 9.0811786e-06, 1.6885924e-05, 2.4636160e-05, 3.2261573e-05, 3.9692097e-05, 4.6858550e-05, 5.3693266e-05, 6.0130724e-05, 6.6108168e-05, 7.1566201e-05, 7.6449367e-05, 8.0706696e-05, 8.4292220e-05, 8.7165450e-05, 8.9291804e-05, 9.0642998e-05, 9.1197374e-05, 9.0940176e-05, 8.9863770e-05, 8.7967801e-05, 8.5259281e-05, 8.1752622e-05, 7.7469592e-05, 7.2439209e-05, 6.6697571e-05, 6.0287616e-05, 5.3258816e-05, 4.5666813e-05, 3.7572993e-05, 2.9043998e-05, 2.0151198e-05, 1.0970096e-05, 1.5797016e-06,-7.9381370e-06,-1.7499439e-05,-2.7018822e-05,-3.6410253e-05,-4.5587815e-05,-5.4466488e-05,-6.2962918e-05,-7.0996195e-05,-7.8488607e-05,-8.5366381e-05,-9.1560394e-05,-9.7006850e-05,-1.0164792e-04,-1.0543234e-04,-1.0831593e-04,-1.1026210e-04,-1.1124226e-04,-1.1123618e-04,-1.1023226e-04,-1.0822772e-04,-1.0522878e-04,-1.0125067e-04,-9.6317589e-05,-9.0462641e-05,-8.3727596e-05,-7.6162633e-05,-6.7825987e-05,-5.8783514e-05,-4.9108191e-05,-3.8879539e-05,-2.8182981e-05,-1.7109147e-05,-5.7531125e-06, 5.7864046e-06, 1.7407891e-05, 2.9007919e-05, 4.0482060e-05, 5.1725808e-05, 6.2635524e-05, 7.3109382e-05, 8.3048299e-05, 9.2356867e-05, 1.0094425e-04, 1.0872506e-04, 1.1562019e-04, 1.2155757e-04, 1.2647294e-04, 1.3031050e-04, 1.3302350e-04, 1.3457476e-04, 1.3493715e-04, 1.3409391e-04, 1.3203891e-04, 1.2877689e-04, 1.2432346e-04, 1.1870514e-04, 1.1195923e-04, 1.0413356e-04, 9.5286226e-05, 8.5485174e-05, 7.4807671e-05, 6.3339738e-05, 5.1175465e-05, 3.8416256e-05, 2.5169997e-05, 1.1550158e-05,-2.3251691e-06,-1.6334279e-05,-3.0352910e-05,-4.4255335e-05,-5.7915478e-05,-7.1208041e-05,-8.4009644e-05,-9.6199959e-05,-1.0766282e-04,-1.1828732e-04,-1.2796887e-04,-1.3661020e-04,-1.4412233e-04,-1.5042543e-04,-1.5544969e-04,-1.5913601e-04,-1.6143668e-04,-1.6231590e-04,-1.6175028e-04,-1.5972915e-04,-1.5625479e-04,-1.5134259e-04,-1.4502100e-04,-1.3733146e-04,-1.2832814e-04,-1.1807761e-04,-1.0665835e-04,-9.4160216e-05,-8.0683694e-05,-6.6339159e-05,-5.1245965e-05,-3.5531477e-05,-1.9330004e-05,-2.7816711e-06, 1.3968783e-05, 3.0773258e-05, 4.7481585e-05, 6.3942861e-05, 8.0006793e-05, 9.5525061e-05, 1.1035267e-04, 1.2434929e-04, 1.3738056e-04, 1.4931938e-04, 1.6004712e-04, 1.6945475e-04, 1.7744398e-04, 1.8392818e-04, 1.8883337e-04, 1.9209894e-04, 1.9367838e-04, 1.9353984e-04, 1.9166653e-04, 1.8805711e-04, 1.8272579e-04, 1.7570237e-04, 1.6703218e-04, 1.5677582e-04, 1.4500871e-04, 1.3182068e-04, 1.1731520e-04, 1.0160866e-04, 8.4829445e-05, 6.7116882e-05, 4.8620126e-05, 2.9496909e-05, 9.9122106e-06,-9.9631458e-06,-2.9953972e-05,-4.9882242e-05,-6.9568665e-05,-8.8834283e-05,-1.0750208e-04,-1.2539860e-04,-1.4235552e-04,-1.5821126e-04,-1.7281246e-04,-1.8601543e-04,-1.9768762e-04,-2.0770882e-04,-2.1597245e-04,-2.2238659e-04,-2.2687502e-04,-2.2937798e-04,-2.2985297e-04,-2.2827523e-04,-2.2463817e-04,-2.1895362e-04,-2.1125188e-04,-2.0158167e-04,-1.9000985e-04,-1.7662103e-04,-1.6151693e-04,-1.4481572e-04,-1.2665104e-04,-1.0717102e-04,-8.6537067e-05,-6.4922532e-05,-4.2511301e-05,-1.9496235e-05, 3.9224715e-06, 2.7539016e-05, 5.1143777e-05, 7.4525163e-05, 9.7471486e-05, 1.1977287e-04, 1.4122314e-04, 1.6162173e-04, 1.8077551e-04, 1.9850062e-04, 2.1462420e-04, 2.2898605e-04, 2.4144019e-04, 2.5185631e-04, 2.6012109e-04, 2.6613942e-04, 2.6983535e-04, 2.7115305e-04, 2.7005745e-04, 2.6653477e-04, 2.6059287e-04, 2.5226136e-04, 2.4159157e-04, 2.2865627e-04, 2.1354928e-04, 1.9638478e-04, 1.7729650e-04, 1.5643670e-04, 1.3397502e-04, 1.1009709e-04, 8.5003006e-05, 5.8905732e-05, 3.2029259e-05, 4.6067254e-06,-2.3121590e-05,-5.0910355e-05,-7.8511334e-05,-1.0567559e-04,-1.3215571e-04,-1.5770804e-04,-1.8209489e-04,-2.0508675e-04,-2.2646442e-04,-2.4602105e-04,-2.6356414e-04,-2.7891739e-04,-2.9192245e-04,-3.0244047e-04,-3.1035359e-04,-3.1556616e-04,-3.1800580e-04,-3.1762429e-04,-3.1439825e-04,-3.0832952e-04,-2.9944545e-04,-2.8779886e-04,-2.7346782e-04,-2.5655519e-04,-2.3718790e-04,-2.1551610e-04,-1.9171198e-04,-1.6596845e-04,-1.3849763e-04,-1.0952908e-04,-7.9307962e-05,-4.8092937e-05,-1.6154015e-05, 1.6229781e-05, 4.8772824e-05, 8.1185380e-05, 1.1317617e-04, 1.4445496e-04, 1.7473519e-04, 2.0373653e-04, 2.3118750e-04, 2.5682798e-04, 2.8041160e-04, 3.0170814e-04, 3.2050567e-04, 3.3661271e-04, 3.4986004e-04, 3.6010249e-04, 3.6722043e-04, 3.7112111e-04, 3.7173970e-04, 3.6904016e-04, 3.6301580e-04, 3.5368966e-04, 3.4111453e-04, 3.2537278e-04, 3.0657588e-04, 2.8486368e-04, 2.6040343e-04, 2.3338850e-04, 2.0403692e-04, 1.7258967e-04, 1.3930867e-04, 1.0447471e-04, 6.8385023e-05, 3.1350857e-05,-6.3052407e-06,-4.4252182e-05,-8.2153229e-05,-1.1966896e-04,-1.5646028e-04,-1.9219145e-04,-2.2653316e-04,-2.5916547e-04,-2.8978084e-04,-3.1808692e-04,-3.4380937e-04,-3.6669444e-04,-3.8651142e-04,-4.0305498e-04,-4.1614715e-04,-4.2563925e-04,-4.3141342e-04,-4.3338398e-04,-4.3149851e-04,-4.2573859e-04,-4.1612031e-04,-4.0269441e-04,-3.8554613e-04,-3.6479481e-04,-3.4059311e-04,-3.1312592e-04,-2.8260903e-04,-2.4928749e-04,-2.1343365e-04,-1.7534499e-04,-1.3534168e-04,-9.3763945e-05,-5.0969163e-05,-7.3288614e-06, 3.6774496e-05, 8.0950828e-05, 1.2480586e-04, 1.6794459e-04, 2.0997485e-04, 2.5051082e-04, 2.8917653e-04, 3.2560933e-04, 3.5946322e-04, 3.9041214e-04, 4.1815304e-04, 4.4240879e-04, 4.6293091e-04, 4.7950206e-04, 4.9193822e-04, 5.0009069e-04, 5.0384772e-04, 5.0313581e-04, 4.9792078e-04, 4.8820837e-04, 4.7404457e-04, 4.5551559e-04, 4.3274742e-04, 4.0590511e-04, 3.7519160e-04, 3.4084626e-04, 3.0314311e-04, 2.6238864e-04, 2.1891941e-04, 1.7309927e-04, 1.2531637e-04, 7.5979952e-05, 2.5516805e-05,-2.5632326e-05,-7.7016579e-05,-1.2817891e-04,-1.7866010e-04,-2.2800290e-04,-2.7575604e-04,-3.2147839e-04,-3.6474297e-04,-4.0514089e-04,-4.4228517e-04,-4.7581436e-04,-5.0539608e-04,-5.3073017e-04,-5.5155171e-04,-5.6763367e-04,-5.7878934e-04,-5.8487427e-04,-5.8578804e-04,-5.8147550e-04,-5.7192766e-04,-5.5718223e-04,-5.3732370e-04,-5.1248296e-04,-4.8283662e-04,-4.4860580e-04,-4.1005458e-04,-3.6748800e-04,-3.2124978e-04,-2.7171951e-04,-2.1930965e-04,-1.6446214e-04,-1.0764468e-04,-4.9346849e-05, 9.9241144e-06, 6.9647655e-05, 1.2929444e-04, 1.8833098e-04, 2.4622438e-04, 3.0244710e-04, 3.5648168e-04, 4.0782548e-04, 4.5599530e-04, 5.0053185e-04, 5.4100407e-04, 5.7701325e-04, 6.0819688e-04, 6.3423219e-04, 6.5483941e-04, 6.6978467e-04, 6.7888250e-04, 6.8199789e-04, 6.7904802e-04, 6.7000343e-04, 6.5488877e-04, 6.3378312e-04, 6.0681973e-04, 5.7418537e-04, 5.3611912e-04, 4.9291075e-04, 4.4489858e-04, 3.9246693e-04, 3.3604308e-04, 2.7609390e-04, 2.1312202e-04, 1.4766170e-04, 8.0274322e-05, 1.1543693e-05,-5.7929005e-05,-1.2753039e-04,-1.9664023e-04,-2.6463693e-04,-3.3090303e-04,-3.9483078e-04,-4.5582763e-04,-5.1332162e-04,-5.6676674e-04,-6.1564799e-04,-6.5948623e-04,-6.9784287e-04,-7.3032407e-04,-7.5658470e-04,-7.7633190e-04,-7.8932812e-04,-7.9539379e-04,-7.9440946e-04,-7.8631740e-04,-7.7112276e-04,-7.4889402e-04,-7.1976305e-04,-6.8392451e-04,-6.4163468e-04,-5.9320981e-04,-5.3902382e-04,-4.7950555e-04,-4.1513544e-04,-3.4644175e-04,-2.7399632e-04,-1.9840985e-04,-1.2032690e-04,-4.0420411e-05, 4.0613984e-05, 1.2206394e-04, 2.0320658e-04, 2.8331483e-04, 3.6166385e-04, 4.3753751e-04, 5.1023484e-04, 5.7907642e-04, 6.4341061e-04, 7.0261964e-04, 7.5612543e-04, 8.0339511e-04, 8.4394618e-04, 8.7735134e-04, 9.0324275e-04, 9.2131594e-04, 9.3133312e-04, 9.3312591e-04, 9.2659757e-04, 9.1172451e-04, 8.8855722e-04, 8.5722057e-04, 8.1791342e-04, 7.7090757e-04, 7.1654605e-04, 6.5524080e-04, 5.8746966e-04, 5.1377279e-04, 4.3474848e-04, 3.5104843e-04, 2.6337242e-04, 1.7246268e-04, 7.9097591e-05,-1.5914757e-05,-1.1174352e-04,-2.0754221e-04,-3.0245611e-04,-3.9562971e-04,-4.8621436e-04,-5.7337585e-04,-6.5630194e-04,-7.3420986e-04,-8.0635349e-04,-8.7203039e-04,-9.3058846e-04,-9.8143227e-04,-1.0240289e-03,-1.0579133e-03,-1.0826932e-03,-1.0980531e-03,-1.1037582e-03,-1.0996571e-03,-1.0856839e-03,-1.0618600e-03,-1.0282945e-03,-9.8518435e-04,-9.3281334e-04,-8.7155067e-04,-8.0184845e-04,-7.2423858e-04,-6.3932892e-04,-5.4779863e-04,-4.5039296e-04,-3.4791731e-04,-2.4123075e-04,-1.3123897e-04,-1.8886719e-05, 9.4850082e-05, 2.0897271e-04, 3.2246820e-04, 4.3431822e-04, 5.4350797e-04, 6.4903523e-04, 7.4991940e-04, 8.4521035e-04, 9.3399724e-04, 1.0154169e-03, 1.0886623e-03, 1.1529896e-03, 1.2077264e-03, 1.2522777e-03, 1.2861323e-03, 1.3088683e-03, 1.3201578e-03, 1.3197707e-03, 1.3075780e-03, 1.2835540e-03, 1.2477777e-03, 1.2004333e-03, 1.1418098e-03, 1.0722993e-03, 9.9239531e-04, 9.0268904e-04, 8.0386550e-04, 6.9669851e-04, 5.8204486e-04, 4.6083774e-04, 3.3407934e-04, 2.0283282e-04, 6.8213680e-05,-6.8619540e-05,-2.0647492e-04,-3.4413733e-04,-4.8037882e-04,-6.1396934e-04,-7.4368754e-04,-8.6833165e-04,-9.8673030e-04,-1.0977532e-03,-1.2003216e-03,-1.2934184e-03,-1.3760980e-03,-1.4474951e-03,-1.5068339e-03,-1.5534353e-03,-1.5867249e-03,-1.6062385e-03,-1.6116282e-03,-1.6026666e-03,-1.5792502e-03,-1.5414024e-03,-1.4892741e-03,-1.4231446e-03,-1.3434205e-03,-1.2506338e-03,-1.1454390e-03,-1.0286085e-03,-9.0102792e-04,-7.6368915e-04,-6.1768353e-04,-4.6419336e-04,-3.0448274e-04,-1.3988760e-04, 2.8195121e-05, 1.9831885e-04, 3.6899942e-04, 5.3872756e-04, 7.0598179e-04, 8.6924151e-04, 1.0270004e-03, 1.1777798e-03, 1.3201418e-03, 1.4527028e-03, 1.5741459e-03, 1.6832335e-03, 1.7788195e-03, 1.8598599e-03, 1.9254242e-03, 1.9747043e-03, 2.0070241e-03, 2.0218464e-03, 2.0187804e-03, 1.9975866e-03, 1.9581814e-03, 1.9006400e-03, 1.8251981e-03, 1.7322521e-03, 1.6223582e-03, 1.4962299e-03, 1.3547339e-03, 1.1988854e-03, 1.0298408e-03, 8.4889071e-04, 6.5744990e-04, 4.5704760e-04, 2.4931572e-04, 3.5976402e-05,-1.8117148e-04,-4.0026668e-04,-6.1940069e-04,-8.3663344e-04,-1.0500096e-03,-1.2575751e-03,-1.4573941e-03,-1.6475659e-03,-1.8262421e-03,-1.9916428e-03,-2.1420738e-03,-2.2759419e-03,-2.3917708e-03,-2.4882154e-03,-2.5640757e-03,-2.6183095e-03,-2.6500441e-03,-2.6585868e-03,-2.6434336e-03,-2.6042772e-03,-2.5410128e-03,-2.4537430e-03,-2.3427801e-03,-2.2086476e-03,-2.0520796e-03,-1.8740181e-03,-1.6756092e-03,-1.4581970e-03,-1.2233159e-03,-9.7268120e-04,-7.0817828e-04,-4.3184968e-04,-1.4588102e-04, 1.4741456e-04, 4.4561340e-04, 7.4619942e-04, 1.0465834e-03, 1.3441231e-03, 1.6361443e-03, 1.9199625e-03, 2.1929048e-03, 2.4523326e-03, 2.6956641e-03, 2.9203968e-03, 3.1241299e-03, 3.3045861e-03, 3.4596331e-03, 3.5873044e-03, 3.6858187e-03, 3.7535985e-03, 3.7892878e-03, 3.7917679e-03, 3.7601715e-03, 3.6938960e-03, 3.5926137e-03, 3.4562817e-03, 3.2851478e-03, 3.0797562e-03, 2.8409497e-03, 2.5698703e-03, 2.2679574e-03, 1.9369435e-03, 1.5788480e-03, 1.1959685e-03, 7.9086968e-04, 3.6637028e-04,-7.4472115e-05,-5.2837842e-04,-9.9186734e-04,-1.4612764e-03,-1.9327848e-03,-2.4024376e-03,-2.8661717e-03,-3.3198427e-03,-3.7592528e-03,-4.1801798e-03,-4.5784066e-03,-4.9497512e-03,-5.2900967e-03,-5.5954219e-03,-5.8618311e-03,-6.0855837e-03,-6.2631231e-03,-6.3911052e-03,-6.4664250e-03,-6.4862426e-03,-6.4480076e-03,-6.3494816e-03,-6.1887592e-03,-5.9642863e-03,-5.6748777e-03,-5.3197306e-03,-4.8984366e-03,-4.4109917e-03,-3.8578024e-03,-3.2396900e-03,-2.5578918e-03,-1.8140600e-03,-1.0102567e-03,-1.4894734e-04, 7.6700934e-04, 1.7343740e-03, 2.7495418e-03, 3.8085606e-03, 4.9071510e-03, 6.0407289e-03, 7.2044311e-03, 8.3931415e-03, 9.6015208e-03, 1.0824036e-02, 1.2054994e-02, 1.3288574e-02, 1.4518862e-02, 1.5739886e-02, 1.6945654e-02, 1.8130186e-02, 1.9287556e-02, 2.0411923e-02, 2.1497573e-02, 2.2538948e-02, 2.3530684e-02, 2.4467645e-02, 2.5344954e-02, 2.6158023e-02, 2.6902585e-02, 2.7574716e-02, 2.8170864e-02, 2.8687870e-02, 2.9122986e-02, 2.9473898e-02, 2.9738735e-02, 2.9916082e-02, 3.0004994e-02, 3.0004994e-02, 2.9916082e-02, 2.9738735e-02, 2.9473898e-02, 2.9122986e-02, 2.8687870e-02, 2.8170864e-02, 2.7574716e-02, 2.6902585e-02, 2.6158023e-02, 2.5344954e-02, 2.4467645e-02, 2.3530684e-02, 2.2538948e-02, 2.1497573e-02, 2.0411923e-02, 1.9287556e-02, 1.8130186e-02, 1.6945654e-02, 1.5739886e-02, 1.4518862e-02, 1.3288574e-02, 1.2054994e-02, 1.0824036e-02, 9.6015208e-03, 8.3931415e-03, 7.2044311e-03, 6.0407289e-03, 4.9071510e-03, 3.8085606e-03, 2.7495418e-03, 1.7343740e-03, 7.6700934e-04,-1.4894734e-04,-1.0102567e-03,-1.8140600e-03,-2.5578918e-03,-3.2396900e-03,-3.8578024e-03,-4.4109917e-03,-4.8984366e-03,-5.3197306e-03,-5.6748777e-03,-5.9642863e-03,-6.1887592e-03,-6.3494816e-03,-6.4480076e-03,-6.4862426e-03,-6.4664250e-03,-6.3911052e-03,-6.2631231e-03,-6.0855837e-03,-5.8618311e-03,-5.5954219e-03,-5.2900967e-03,-4.9497512e-03,-4.5784066e-03,-4.1801798e-03,-3.7592528e-03,-3.3198427e-03,-2.8661717e-03,-2.4024376e-03,-1.9327848e-03,-1.4612764e-03,-9.9186734e-04,-5.2837842e-04,-7.4472115e-05, 3.6637028e-04, 7.9086968e-04, 1.1959685e-03, 1.5788480e-03, 1.9369435e-03, 2.2679574e-03, 2.5698703e-03, 2.8409497e-03, 3.0797562e-03, 3.2851478e-03, 3.4562817e-03, 3.5926137e-03, 3.6938960e-03, 3.7601715e-03, 3.7917679e-03, 3.7892878e-03, 3.7535985e-03, 3.6858187e-03, 3.5873044e-03, 3.4596331e-03, 3.3045861e-03, 3.1241299e-03, 2.9203968e-03, 2.6956641e-03, 2.4523326e-03, 2.1929048e-03, 1.9199625e-03, 1.6361443e-03, 1.3441231e-03, 1.0465834e-03, 7.4619942e-04, 4.4561340e-04, 1.4741456e-04,-1.4588102e-04,-4.3184968e-04,-7.0817828e-04,-9.7268120e-04,-1.2233159e-03,-1.4581970e-03,-1.6756092e-03,-1.8740181e-03,-2.0520796e-03,-2.2086476e-03,-2.3427801e-03,-2.4537430e-03,-2.5410128e-03,-2.6042772e-03,-2.6434336e-03,-2.6585868e-03,-2.6500441e-03,-2.6183095e-03,-2.5640757e-03,-2.4882154e-03,-2.3917708e-03,-2.2759419e-03,-2.1420738e-03,-1.9916428e-03,-1.8262421e-03,-1.6475659e-03,-1.4573941e-03,-1.2575751e-03,-1.0500096e-03,-8.3663344e-04,-6.1940069e-04,-4.0026668e-04,-1.8117148e-04, 3.5976402e-05, 2.4931572e-04, 4.5704760e-04, 6.5744990e-04, 8.4889071e-04, 1.0298408e-03, 1.1988854e-03, 1.3547339e-03, 1.4962299e-03, 1.6223582e-03, 1.7322521e-03, 1.8251981e-03, 1.9006400e-03, 1.9581814e-03, 1.9975866e-03, 2.0187804e-03, 2.0218464e-03, 2.0070241e-03, 1.9747043e-03, 1.9254242e-03, 1.8598599e-03, 1.7788195e-03, 1.6832335e-03, 1.5741459e-03, 1.4527028e-03, 1.3201418e-03, 1.1777798e-03, 1.0270004e-03, 8.6924151e-04, 7.0598179e-04, 5.3872756e-04, 3.6899942e-04, 1.9831885e-04, 2.8195121e-05,-1.3988760e-04,-3.0448274e-04,-4.6419336e-04,-6.1768353e-04,-7.6368915e-04,-9.0102792e-04,-1.0286085e-03,-1.1454390e-03,-1.2506338e-03,-1.3434205e-03,-1.4231446e-03,-1.4892741e-03,-1.5414024e-03,-1.5792502e-03,-1.6026666e-03,-1.6116282e-03,-1.6062385e-03,-1.5867249e-03,-1.5534353e-03,-1.5068339e-03,-1.4474951e-03,-1.3760980e-03,-1.2934184e-03,-1.2003216e-03,-1.0977532e-03,-9.8673030e-04,-8.6833165e-04,-7.4368754e-04,-6.1396934e-04,-4.8037882e-04,-3.4413733e-04,-2.0647492e-04,-6.8619540e-05, 6.8213680e-05, 2.0283282e-04, 3.3407934e-04, 4.6083774e-04, 5.8204486e-04, 6.9669851e-04, 8.0386550e-04, 9.0268904e-04, 9.9239531e-04, 1.0722993e-03, 1.1418098e-03, 1.2004333e-03, 1.2477777e-03, 1.2835540e-03, 1.3075780e-03, 1.3197707e-03, 1.3201578e-03, 1.3088683e-03, 1.2861323e-03, 1.2522777e-03, 1.2077264e-03, 1.1529896e-03, 1.0886623e-03, 1.0154169e-03, 9.3399724e-04, 8.4521035e-04, 7.4991940e-04, 6.4903523e-04, 5.4350797e-04, 4.3431822e-04, 3.2246820e-04, 2.0897271e-04, 9.4850082e-05,-1.8886719e-05,-1.3123897e-04,-2.4123075e-04,-3.4791731e-04,-4.5039296e-04,-5.4779863e-04,-6.3932892e-04,-7.2423858e-04,-8.0184845e-04,-8.7155067e-04,-9.3281334e-04,-9.8518435e-04,-1.0282945e-03,-1.0618600e-03,-1.0856839e-03,-1.0996571e-03,-1.1037582e-03,-1.0980531e-03,-1.0826932e-03,-1.0579133e-03,-1.0240289e-03,-9.8143227e-04,-9.3058846e-04,-8.7203039e-04,-8.0635349e-04,-7.3420986e-04,-6.5630194e-04,-5.7337585e-04,-4.8621436e-04,-3.9562971e-04,-3.0245611e-04,-2.0754221e-04,-1.1174352e-04,-1.5914757e-05, 7.9097591e-05, 1.7246268e-04, 2.6337242e-04, 3.5104843e-04, 4.3474848e-04, 5.1377279e-04, 5.8746966e-04, 6.5524080e-04, 7.1654605e-04, 7.7090757e-04, 8.1791342e-04, 8.5722057e-04, 8.8855722e-04, 9.1172451e-04, 9.2659757e-04, 9.3312591e-04, 9.3133312e-04, 9.2131594e-04, 9.0324275e-04, 8.7735134e-04, 8.4394618e-04, 8.0339511e-04, 7.5612543e-04, 7.0261964e-04, 6.4341061e-04, 5.7907642e-04, 5.1023484e-04, 4.3753751e-04, 3.6166385e-04, 2.8331483e-04, 2.0320658e-04, 1.2206394e-04, 4.0613984e-05,-4.0420411e-05,-1.2032690e-04,-1.9840985e-04,-2.7399632e-04,-3.4644175e-04,-4.1513544e-04,-4.7950555e-04,-5.3902382e-04,-5.9320981e-04,-6.4163468e-04,-6.8392451e-04,-7.1976305e-04,-7.4889402e-04,-7.7112276e-04,-7.8631740e-04,-7.9440946e-04,-7.9539379e-04,-7.8932812e-04,-7.7633190e-04,-7.5658470e-04,-7.3032407e-04,-6.9784287e-04,-6.5948623e-04,-6.1564799e-04,-5.6676674e-04,-5.1332162e-04,-4.5582763e-04,-3.9483078e-04,-3.3090303e-04,-2.6463693e-04,-1.9664023e-04,-1.2753039e-04,-5.7929005e-05, 1.1543693e-05, 8.0274322e-05, 1.4766170e-04, 2.1312202e-04, 2.7609390e-04, 3.3604308e-04, 3.9246693e-04, 4.4489858e-04, 4.9291075e-04, 5.3611912e-04, 5.7418537e-04, 6.0681973e-04, 6.3378312e-04, 6.5488877e-04, 6.7000343e-04, 6.7904802e-04, 6.8199789e-04, 6.7888250e-04, 6.6978467e-04, 6.5483941e-04, 6.3423219e-04, 6.0819688e-04, 5.7701325e-04, 5.4100407e-04, 5.0053185e-04, 4.5599530e-04, 4.0782548e-04, 3.5648168e-04, 3.0244710e-04, 2.4622438e-04, 1.8833098e-04, 1.2929444e-04, 6.9647655e-05, 9.9241144e-06,-4.9346849e-05,-1.0764468e-04,-1.6446214e-04,-2.1930965e-04,-2.7171951e-04,-3.2124978e-04,-3.6748800e-04,-4.1005458e-04,-4.4860580e-04,-4.8283662e-04,-5.1248296e-04,-5.3732370e-04,-5.5718223e-04,-5.7192766e-04,-5.8147550e-04,-5.8578804e-04,-5.8487427e-04,-5.7878934e-04,-5.6763367e-04,-5.5155171e-04,-5.3073017e-04,-5.0539608e-04,-4.7581436e-04,-4.4228517e-04,-4.0514089e-04,-3.6474297e-04,-3.2147839e-04,-2.7575604e-04,-2.2800290e-04,-1.7866010e-04,-1.2817891e-04,-7.7016579e-05,-2.5632326e-05, 2.5516805e-05, 7.5979952e-05, 1.2531637e-04, 1.7309927e-04, 2.1891941e-04, 2.6238864e-04, 3.0314311e-04, 3.4084626e-04, 3.7519160e-04, 4.0590511e-04, 4.3274742e-04, 4.5551559e-04, 4.7404457e-04, 4.8820837e-04, 4.9792078e-04, 5.0313581e-04, 5.0384772e-04, 5.0009069e-04, 4.9193822e-04, 4.7950206e-04, 4.6293091e-04, 4.4240879e-04, 4.1815304e-04, 3.9041214e-04, 3.5946322e-04, 3.2560933e-04, 2.8917653e-04, 2.5051082e-04, 2.0997485e-04, 1.6794459e-04, 1.2480586e-04, 8.0950828e-05, 3.6774496e-05,-7.3288614e-06,-5.0969163e-05,-9.3763945e-05,-1.3534168e-04,-1.7534499e-04,-2.1343365e-04,-2.4928749e-04,-2.8260903e-04,-3.1312592e-04,-3.4059311e-04,-3.6479481e-04,-3.8554613e-04,-4.0269441e-04,-4.1612031e-04,-4.2573859e-04,-4.3149851e-04,-4.3338398e-04,-4.3141342e-04,-4.2563925e-04,-4.1614715e-04,-4.0305498e-04,-3.8651142e-04,-3.6669444e-04,-3.4380937e-04,-3.1808692e-04,-2.8978084e-04,-2.5916547e-04,-2.2653316e-04,-1.9219145e-04,-1.5646028e-04,-1.1966896e-04,-8.2153229e-05,-4.4252182e-05,-6.3052407e-06, 3.1350857e-05, 6.8385023e-05, 1.0447471e-04, 1.3930867e-04, 1.7258967e-04, 2.0403692e-04, 2.3338850e-04, 2.6040343e-04, 2.8486368e-04, 3.0657588e-04, 3.2537278e-04, 3.4111453e-04, 3.5368966e-04, 3.6301580e-04, 3.6904016e-04, 3.7173970e-04, 3.7112111e-04, 3.6722043e-04, 3.6010249e-04, 3.4986004e-04, 3.3661271e-04, 3.2050567e-04, 3.0170814e-04, 2.8041160e-04, 2.5682798e-04, 2.3118750e-04, 2.0373653e-04, 1.7473519e-04, 1.4445496e-04, 1.1317617e-04, 8.1185380e-05, 4.8772824e-05, 1.6229781e-05,-1.6154015e-05,-4.8092937e-05,-7.9307962e-05,-1.0952908e-04,-1.3849763e-04,-1.6596845e-04,-1.9171198e-04,-2.1551610e-04,-2.3718790e-04,-2.5655519e-04,-2.7346782e-04,-2.8779886e-04,-2.9944545e-04,-3.0832952e-04,-3.1439825e-04,-3.1762429e-04,-3.1800580e-04,-3.1556616e-04,-3.1035359e-04,-3.0244047e-04,-2.9192245e-04,-2.7891739e-04,-2.6356414e-04,-2.4602105e-04,-2.2646442e-04,-2.0508675e-04,-1.8209489e-04,-1.5770804e-04,-1.3215571e-04,-1.0567559e-04,-7.8511334e-05,-5.0910355e-05,-2.3121590e-05, 4.6067254e-06, 3.2029259e-05, 5.8905732e-05, 8.5003006e-05, 1.1009709e-04, 1.3397502e-04, 1.5643670e-04, 1.7729650e-04, 1.9638478e-04, 2.1354928e-04, 2.2865627e-04, 2.4159157e-04, 2.5226136e-04, 2.6059287e-04, 2.6653477e-04, 2.7005745e-04, 2.7115305e-04, 2.6983535e-04, 2.6613942e-04, 2.6012109e-04, 2.5185631e-04, 2.4144019e-04, 2.2898605e-04, 2.1462420e-04, 1.9850062e-04, 1.8077551e-04, 1.6162173e-04, 1.4122314e-04, 1.1977287e-04, 9.7471486e-05, 7.4525163e-05, 5.1143777e-05, 2.7539016e-05, 3.9224715e-06,-1.9496235e-05,-4.2511301e-05,-6.4922532e-05,-8.6537067e-05,-1.0717102e-04,-1.2665104e-04,-1.4481572e-04,-1.6151693e-04,-1.7662103e-04,-1.9000985e-04,-2.0158167e-04,-2.1125188e-04,-2.1895362e-04,-2.2463817e-04,-2.2827523e-04,-2.2985297e-04,-2.2937798e-04,-2.2687502e-04,-2.2238659e-04,-2.1597245e-04,-2.0770882e-04,-1.9768762e-04,-1.8601543e-04,-1.7281246e-04,-1.5821126e-04,-1.4235552e-04,-1.2539860e-04,-1.0750208e-04,-8.8834283e-05,-6.9568665e-05,-4.9882242e-05,-2.9953972e-05,-9.9631458e-06, 9.9122106e-06, 2.9496909e-05, 4.8620126e-05, 6.7116882e-05, 8.4829445e-05, 1.0160866e-04, 1.1731520e-04, 1.3182068e-04, 1.4500871e-04, 1.5677582e-04, 1.6703218e-04, 1.7570237e-04, 1.8272579e-04, 1.8805711e-04, 1.9166653e-04, 1.9353984e-04, 1.9367838e-04, 1.9209894e-04, 1.8883337e-04, 1.8392818e-04, 1.7744398e-04, 1.6945475e-04, 1.6004712e-04, 1.4931938e-04, 1.3738056e-04, 1.2434929e-04, 1.1035267e-04, 9.5525061e-05, 8.0006793e-05, 6.3942861e-05, 4.7481585e-05, 3.0773258e-05, 1.3968783e-05,-2.7816711e-06,-1.9330004e-05,-3.5531477e-05,-5.1245965e-05,-6.6339159e-05,-8.0683694e-05,-9.4160216e-05,-1.0665835e-04,-1.1807761e-04,-1.2832814e-04,-1.3733146e-04,-1.4502100e-04,-1.5134259e-04,-1.5625479e-04,-1.5972915e-04,-1.6175028e-04,-1.6231590e-04,-1.6143668e-04,-1.5913601e-04,-1.5544969e-04,-1.5042543e-04,-1.4412233e-04,-1.3661020e-04,-1.2796887e-04,-1.1828732e-04,-1.0766282e-04,-9.6199959e-05,-8.4009644e-05,-7.1208041e-05,-5.7915478e-05,-4.4255335e-05,-3.0352910e-05,-1.6334279e-05,-2.3251691e-06, 1.1550158e-05, 2.5169997e-05, 3.8416256e-05, 5.1175465e-05, 6.3339738e-05, 7.4807671e-05, 8.5485174e-05, 9.5286226e-05, 1.0413356e-04, 1.1195923e-04, 1.1870514e-04, 1.2432346e-04, 1.2877689e-04, 1.3203891e-04, 1.3409391e-04, 1.3493715e-04, 1.3457476e-04, 1.3302350e-04, 1.3031050e-04, 1.2647294e-04, 1.2155757e-04, 1.1562019e-04, 1.0872506e-04, 1.0094425e-04, 9.2356867e-05, 8.3048299e-05, 7.3109382e-05, 6.2635524e-05, 5.1725808e-05, 4.0482060e-05, 2.9007919e-05, 1.7407891e-05, 5.7864046e-06,-5.7531125e-06,-1.7109147e-05,-2.8182981e-05,-3.8879539e-05,-4.9108191e-05,-5.8783514e-05,-6.7825987e-05,-7.6162633e-05,-8.3727596e-05,-9.0462641e-05,-9.6317589e-05,-1.0125067e-04,-1.0522878e-04,-1.0822772e-04,-1.1023226e-04,-1.1123618e-04,-1.1124226e-04,-1.1026210e-04,-1.0831593e-04,-1.0543234e-04,-1.0164792e-04,-9.7006850e-05,-9.1560394e-05,-8.5366381e-05,-7.8488607e-05,-7.0996195e-05,-6.2962918e-05,-5.4466488e-05,-4.5587815e-05,-3.6410253e-05,-2.7018822e-05,-1.7499439e-05,-7.9381370e-06, 1.5797016e-06, 1.0970096e-05, 2.0151198e-05, 2.9043998e-05, 3.7572993e-05, 4.5666813e-05, 5.3258816e-05, 6.0287616e-05, 6.6697571e-05, 7.2439209e-05, 7.7469592e-05, 8.1752622e-05, 8.5259281e-05, 8.7967801e-05, 8.9863770e-05, 9.0940176e-05, 9.1197374e-05, 9.0642998e-05, 8.9291804e-05, 8.7165450e-05, 8.4292220e-05, 8.0706696e-05, 7.6449367e-05, 7.1566201e-05, 6.6108168e-05, 6.0130724e-05, 5.3693266e-05, 4.6858550e-05, 3.9692097e-05, 3.2261573e-05, 2.4636160e-05, 1.6885924e-05, 9.0811786e-06, 1.2918594e-06,-6.4130970e-06,-1.3966352e-05,-2.1302745e-05,-2.8359845e-05,-3.5078474e-05,-4.1403191e-05,-4.7282741e-05,-5.2670457e-05,-5.7524618e-05,-6.1808762e-05,-6.5491940e-05,-6.8548926e-05,-7.0960368e-05,-7.2712890e-05,-7.3799130e-05,-7.4217739e-05,-7.3973309e-05,-7.3076267e-05,-7.1542700e-05,-6.9394149e-05,-6.6657343e-05,-6.3363901e-05,-5.9549989e-05,-5.5255936e-05,-5.0525834e-05,-4.5407087e-05,-3.9949957e-05,-3.4207078e-05,-2.8232958e-05,-2.2083474e-05,-1.5815355e-05,-9.4856707e-06,-3.1513178e-06, 3.1314812e-06, 9.3076692e-06, 1.5323828e-05, 2.1128634e-05, 2.6673283e-05, 3.1911895e-05, 3.6801883e-05, 4.1304289e-05, 4.5384083e-05, 4.9010426e-05, 5.2156888e-05, 5.4801626e-05, 5.6927524e-05, 5.8522277e-05, 5.9578447e-05, 6.0093461e-05, 6.0069574e-05, 5.9513789e-05, 5.8437732e-05, 5.6857492e-05, 5.4793419e-05, 5.2269892e-05, 4.9315053e-05, 4.5960503e-05, 4.2240988e-05, 3.8194040e-05, 3.3859620e-05, 2.9279726e-05, 2.4497998e-05, 1.9559310e-05, 1.4509358e-05, 9.3942439e-06, 4.2600656e-06,-8.4749452e-07,-5.8835662e-06,-1.0804478e-05,-1.5568129e-05,-2.0134338e-05,-2.4465178e-05,-2.8525281e-05,-3.2282117e-05,-3.5706247e-05,-3.8771542e-05,-4.1455372e-05,-4.3738763e-05,-4.5606515e-05,-4.7047292e-05,-4.8053669e-05,-4.8622152e-05,-4.8753155e-05,-4.8450949e-05,-4.7723578e-05,-4.6582733e-05,-4.5043611e-05,-4.3124732e-05,-4.0847737e-05,-3.8237154e-05,-3.5320149e-05,-3.2126254e-05,-2.8687074e-05,-2.5035986e-05,-2.1207822e-05,-1.7238544e-05,-1.3164915e-05,-9.0241625e-06,-4.8536510e-06,-6.9054681e-07, 3.4285035e-06, 7.4676892e-06, 1.1392339e-05, 1.5169212e-05, 1.8766771e-05, 2.2155439e-05, 2.5307832e-05, 2.8198979e-05, 3.0806500e-05, 3.3110782e-05, 3.5095110e-05, 3.6745779e-05, 3.8052179e-05, 3.9006851e-05, 3.9605510e-05, 3.9847049e-05, 3.9733507e-05, 3.9270013e-05, 3.8464707e-05, 3.7328631e-05, 3.5875598e-05, 3.4122037e-05, 3.2086822e-05, 2.9791074e-05, 2.7257953e-05, 2.4512432e-05, 2.1581057e-05, 1.8491695e-05, 1.5273282e-05, 1.1955552e-05, 8.5687711e-06, 5.1434708e-06, 1.7101747e-06,-1.7008643e-06,-5.0599244e-06,-8.3380676e-06,-1.1507382e-05,-1.4541213e-05,-1.7414379e-05,-2.0103378e-05,-2.2586565e-05,-2.4844329e-05,-2.6859230e-05,-2.8616137e-05,-3.0102325e-05,-3.1307563e-05,-3.2224177e-05,-3.2847084e-05,-3.3173815e-05,-3.3204501e-05,-3.2941850e-05,-3.2391095e-05,-3.1559920e-05,-3.0458372e-05,-2.9098745e-05,-2.7495457e-05,-2.5664897e-05,-2.3625270e-05,-2.1396417e-05,-1.8999631e-05,-1.6457458e-05,-1.3793488e-05,-1.1032147e-05,-8.1984748e-06,-5.3179047e-06,-2.4160417e-06, 4.8155969e-07, 3.3496140e-06, 6.1633196e-06, 8.8985670e-06, 1.1532139e-05, 1.4041903e-05, 1.6406988e-05, 1.8607956e-05, 2.0626952e-05, 2.2447846e-05, 2.4056354e-05, 2.5440146e-05, 2.6588932e-05, 2.7494538e-05, 2.8150952e-05, 2.8554362e-05, 2.8703169e-05, 2.8597983e-05, 2.8241600e-05, 2.7638962e-05, 2.6797096e-05, 2.5725042e-05, 2.4433756e-05, 2.2936007e-05, 2.1246250e-05, 1.9380495e-05, 1.7356158e-05, 1.5191904e-05, 1.2907476e-05, 1.0523525e-05, 8.0614228e-06, 5.5430809e-06, 2.9907571e-06, 4.2686609e-07,-2.1262127e-06,-4.6463245e-06,-7.1117260e-06,-9.5012672e-06,-1.1794568e-05,-1.3972185e-05,-1.6015775e-05,-1.7908237e-05,-1.9633861e-05,-2.1178444e-05,-2.2529408e-05,-2.3675898e-05,-2.4608862e-05,-2.5321126e-05,-2.5807438e-05,-2.6064509e-05,-2.6091032e-05,-2.5887681e-05,-2.5457101e-05,-2.4803878e-05,-2.3934487e-05,-2.2857236e-05,-2.1582189e-05,-2.0121069e-05,-1.8487161e-05,-1.6695187e-05,-1.4761183e-05,-1.2702357e-05,-1.0536939e-05,-8.2840250e-06,-5.9634157e-06,-3.5954434e-06,-1.2008008e-06};


	int32_t numBlock=RECORDING_BUFLEN/NumTaps;

	arm_fir_instance_f32 S;

	arm_fir_init_f32(&S, NumTaps, firCoeffs32, firStateF32, blockSize);
	  for(int i=0; i < numBlock; i++)
	  {
	    arm_fir_f32(&S, recordingBuffer + (i * blockSize), recordingBuffer + (i * blockSize), blockSize);
	  }

	transformBufferToDAC(recordingBuffer,RECORDING_BUFLEN,testingBuffer, sendingBuffer);
	if (HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, testingBuffer, RECORDING_BUFLEN, DAC_ALIGN_8B_R) != HAL_OK) {
		printf("Failed to start DAC");
	}
	/*
	for (int i=0; i<RECORDING_BUFLEN;i++){
		printf("%d ", testingBuffer[i]);
	}
	*/
	printf("***Testing rig end*** \r\n");
	  while(buttonPressed==false){
	  	__WFI(); // Waiting for interrupt mode?
	  }
	while(wifi_connect_to_board(REMOTE_IP_0, REMOTE_IP_1, REMOTE_IP_2, REMOTE_IP_3) != WIFI_STATUS_OK) {
		printf("Retrying to connect to board ... \r\n");
	}
	// successfully connected to board
	printf("Connected to other board. \r\n");
	//wifi_send_data_to_board("test");

    while (true) {
    printf("Waiting for button press to send mic data.\r\n");
    while(buttonPressed==false){
    	__WFI(); // Waiting for interrupt mode?
    }
    buttonPressed = false;
   // while (buttonPressed == false) {
    	// IF YOU WANT TO USE THE HALF_FINISHED THING U HAVE TO SET DMA TO CIRCULAR IN hal_msp.c
    	if (HAL_DFSDM_FilterRegularStart_DMA(&hdfsdm1_filter0, recordingBuffer, RECORDING_BUFLEN) != HAL_OK) {
    	  printf("Failed to start DFSDM\r\n");
    	}
    	/*
		while (!DFSDM_half_finished) {
		}
		// need to transform only first half
		printf("DFSDM half finished, sending first half of buffer");
		DFSDM_half_finished = false;
		transformBufferToDAC(recordingBuffer, VOICE_BUFLEN/2, sendingBuffer);
		HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, recordingBuffer, VOICE_BUFLEN/2, DAC_ALIGN_8B_R);
		//wifi_send_data_to_board(sendingBuffer);
		 */
		while (!DFSDM_finished) {
		}

		DFSDM_finished = false;
		HAL_DFSDM_FilterRegularStop_DMA(&hdfsdm1_filter0); //  this is necessary
		/* Need to transform only the last half*/
		/*
		transformBufferToDAC(&(recordingBuffer[VOICE_BUFLEN/2]), VOICE_BUFLEN/2, sendingBuffer);
		HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, &(recordingBuffer[VOICE_BUFLEN/2]), VOICE_BUFLEN/2, DAC_ALIGN_8B_R);
		wifi_send_data_to_board(sendingBuffer);
		*/
		/* test playback on this board */
		//transformBufferToDAC(recordingBuffer,RECORDING_BUFLEN, sendingBuffer);
		//if (HAL_DAC_Start_DMA(&hdac1, DAC_CHANNEL_1, recordingBuffer, RECORDING_BUFLEN, DAC_ALIGN_8B_R) != HAL_OK) {
		//  printf("Failed to start DAC");
		//}

		printf("Sending audio to other board \r\n");

		uint16_t step = RECORDING_BUFLEN/SENDING_BUFLEN;
		for (int i = 0 ; i < step; i++) {
			if(wifi_send_data_to_board(&(sendingBuffer[i*SENDING_BUFLEN])) == WIFI_STATUS_OK) {
				printf("Sent packet %d\r\n", i);
			}
		}
   // }
    buttonPressed = false;
  }
}

/**
 * This function attempts to sent an HTTP request to the other board, which contains some data.
 */
static int wifi_send_data_to_board(uint8_t* data) {
	// first try to connect to the board

    if (WIFI_OpenClientConnection(REMOTE_SOCKET, WIFI_TCP_PROTOCOL, "test", RemoteIP_Addr, REMOTE_PORT, PORT) != WIFI_STATUS_OK) {
    	printf("Could not connect to other board \r\n");
    	return -1;
    }

    printf("Connected to other board\r\n");
	//char* http_header = "HTTP/1.0 200 OK\r\nContent-Type: text/plain\r\n";
    //strcat(http_header, data);

    uint16_t actualSent;
    /*
    for (int i = 0; i < 20; i++) {
    	if (WIFI_SendData(REMOTE_SOCKET, &(data[i*1000]), SENDING_BUFLEN, &actualSent, WIFI_WRITE_TIMEOUT) == WIFI_STATUS_OK) {
			printf("Sent packet %d \r\n", i);
			//memset(data, 0, strlen(data));
			return -1;
    	}
    }
    */
	if (WIFI_SendData(REMOTE_SOCKET,data, SENDING_BUFLEN, &actualSent, WIFI_WRITE_TIMEOUT) != WIFI_STATUS_OK) {
		printf("Could not send data \r\n");
		//memset(data, 0, strlen(data));
		return -1;
	}

    //memset(data, 0, strlen(data)); // maybe we can remove this
    // wait for resp from receiving board before proceeding
    uint8_t resp[100];
    memset(resp, 0, strlen((char*)resp));
    uint16_t actualReceived;

    while(WIFI_ReceiveData(REMOTE_SOCKET, resp, 100, &actualReceived, WIFI_READ_TIMEOUT) != WIFI_STATUS_OK) {

    }
    printf("Received response from receiving board: %s\r\n", resp);

    // close connection

    if (WIFI_CloseClientConnection(REMOTE_SOCKET) != WIFI_STATUS_OK) {
    	printf("Could not close client connection \r\n");
    	return -1;
    }
    printf("Closed client connection \r\n");

    return WIFI_STATUS_OK;
}
/**
 * This function takes care of:
 * - starting the es-wifi module
 * - connecting to a network whose credentials are provided in code
 * - connect to the receiving board using ip address provided in parameters of this function
 * - returns -1 if anything bad happens
 * - returns WIFI_STATUS_OK if successful
 */
static int wifi_connect_to_board(uint8_t ip0, uint8_t ip1, uint8_t ip2, uint8_t ip3) {
	// start wifi module
	wifi_start();


	// connect to existing AP
	if (WIFI_Connect(SSID, PASSWORD, SECURITY) == WIFI_STATUS_OK)
	{
	  if(WIFI_GetIP_Address(IP_Addr, sizeof(IP_Addr)) == WIFI_STATUS_OK)
	  {
		LOG(("eS-WiFi module connected: got IP Address : %d.%d.%d.%d\r\n",
				 IP_Addr[0],
				 IP_Addr[1],
				 IP_Addr[2],
				 IP_Addr[3]));
	  }
	  else
	  {
		LOG((" ERROR : es-wifi module CANNOT get IP address\r\n"));
		return -1;
	  }
	}
	else
	{
	   LOG(("ERROR : es-wifi module NOT connected\r\n"));
	   return -1;
	}
	// start server (?)

	if (WIFI_STATUS_OK != WIFI_StartServer(SOCKET, WIFI_TCP_PROTOCOL, 1, "", PORT)) {
		printf("ERROR: Could not start server \r\n");
		return -1;
	}

	// trying to connect to other board using IP addr
    RemoteIP_Addr[0] = ip0;
    RemoteIP_Addr[1] = ip1;
    RemoteIP_Addr[2] = ip2;
    RemoteIP_Addr[3] = ip3;
    if (WIFI_OpenClientConnection(REMOTE_SOCKET, WIFI_TCP_PROTOCOL, "test", RemoteIP_Addr, REMOTE_PORT, PORT) != WIFI_STATUS_OK) {
    	printf("Could not connect to other board \r\n");
    	return -1;
    }

    // we need to disconnect at the end since we will be reconnecting to send data
    // close connection
    if (WIFI_CloseClientConnection(REMOTE_SOCKET) != WIFI_STATUS_OK) {
    	printf("Could not close client connection \r\n");
    	return -1;
    }

    return WIFI_STATUS_OK;
}

/**
  * @brief  Send HTML page
  * @param  None
  * @retval None
  */


static int wifi_start(void)
{
  uint8_t  MAC_Addr[6];

 /*Initialize and use WIFI module */
  if(WIFI_Init() ==  WIFI_STATUS_OK)
  {
    LOG(("ES-WIFI Initialized.\r\n"));
    if(WIFI_GetMAC_Address(MAC_Addr, sizeof(MAC_Addr)) == WIFI_STATUS_OK)
    {
      LOG(("> eS-WiFi module MAC Address : %02X:%02X:%02X:%02X:%02X:%02X\r\n",
               MAC_Addr[0],
               MAC_Addr[1],
               MAC_Addr[2],
               MAC_Addr[3],
               MAC_Addr[4],
               MAC_Addr[5]));
    }
    else
    {
      LOG(("> ERROR : CANNOT get MAC address\r\n"));
      return -1;
    }
  }
  else
  {
    return -1;
  }
  return 0;
}

/**
 * Transforms a buffer's values into valid DAC 8bit right aligned values
 */
void transformBufferToDAC(int32_t *buffer, uint32_t recording_buffer_length, int32_t *testbuffer, uint8_t *outputBuffer) {
	// need to map buffer values to 8bit right alligned values (uint8_t)
	// from experimentation (screaming at the board): min values tend to be -3000 and max seems to be ~1000
	const int16_t MAX_VAL = 800;
	const int16_t MIN_VAL = -800;
	const float a = (255.0)/(MAX_VAL - MIN_VAL); // slope
	for (int i = 0; i < recording_buffer_length; i++) {
		int32_t val = buffer[i]; // 24-bit value
		val = val >> 8; // remove this for LOUDER but MORE SCUFFED NOISE
		// clip buffer values to within [-MIN_VAL, MAX_VAL]
		if (val <= MIN_VAL) {
			val = MIN_VAL;
		}
		if (val >= MAX_VAL) {
			val = MAX_VAL;
		}
		// scale values up by [-MIN_VAL] to make sure no negatives
		if (MIN_VAL < 0) {
			val += (-MIN_VAL);
		}
		// now the range of val should be [0, MAX_VAL-MIN_VAL], apply linear function to get DAC val
		val = round(a*val);
		if (val >= 0 && val <= 255) {
			outputBuffer[i] = (uint8_t)val; // change the buffer
			testbuffer[i]=val;
		} else {
			Error_Handler(); // should not happen
		}
	}
}

/**
  * @brief  System Clock Configuration
  *         The system Clock is configured as follow :
  *            System Clock source            = PLL (MSI)
  *            SYSCLK(Hz)                     = 80000000
  *            HCLK(Hz)                       = 80000000
  *            AHB Prescaler                  = 1
  *            APB1 Prescaler                 = 1
  *            APB2 Prescaler                 = 1
  *            MSI Frequency(Hz)              = 4000000
  *            PLL_M                          = 1
  *            PLL_N                          = 40
  *            PLL_R                          = 2
  *            PLL_P                          = 7
  *            PLL_Q                          = 4
  *            Flash Latency(WS)              = 4
  * @param  None
  * @retval None
  */
static void SystemClock_Config(void)
{
  RCC_ClkInitTypeDef RCC_ClkInitStruct;
  RCC_OscInitTypeDef RCC_OscInitStruct;

  /* MSI is enabled after System reset, activate PLL with MSI as source */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_MSI;
  RCC_OscInitStruct.MSIState = RCC_MSI_ON;
  RCC_OscInitStruct.MSIClockRange = RCC_MSIRANGE_6;
  RCC_OscInitStruct.MSICalibrationValue = RCC_MSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_MSI;
  RCC_OscInitStruct.PLL.PLLM = 1;
  RCC_OscInitStruct.PLL.PLLN = 40;
  RCC_OscInitStruct.PLL.PLLR = 2;
  RCC_OscInitStruct.PLL.PLLP = 7;
  RCC_OscInitStruct.PLL.PLLQ = 4;
  if(HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    /* Initialization Error */
    while(1);
  }

  /* Select PLL as system clock source and configure the HCLK, PCLK1 and PCLK2
     clocks dividers */
  RCC_ClkInitStruct.ClockType = (RCC_CLOCKTYPE_SYSCLK | RCC_CLOCKTYPE_HCLK | RCC_CLOCKTYPE_PCLK1 | RCC_CLOCKTYPE_PCLK2);
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;
  if(HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_4) != HAL_OK)
  {
    /* Initialization Error */
    while(1);
  }
}
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
/* USER CODE BEGIN MX_GPIO_Init_1 */
/* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();

  /*Configure GPIO pin : PC13 */
  GPIO_InitStruct.Pin = GPIO_PIN_13;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /* EXTI interrupt init*/
  HAL_NVIC_SetPriority(EXTI15_10_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);

/* USER CODE BEGIN MX_GPIO_Init_2 */
/* USER CODE END MX_GPIO_Init_2 */
}

#if defined (TERMINAL_USE)
/**
  * @brief  Retargets the C library printf function to the USART.
  * @param  None
  * @retval None
  */
PUTCHAR_PROTOTYPE
{
  /* Place your implementation of fputc here */
  /* e.g. write a character to the USART1 and Loop until the end of transmission */
  HAL_UART_Transmit(&hDiscoUart, (uint8_t *)&ch, 1, 0xFFFF);

  return ch;
}

#endif /* TERMINAL_USE */

#ifdef USE_FULL_ASSERT

/**
   * @brief Reports the name of the source file and the source line number
   * where the assert_param error has occurred.
   * @param file: pointer to the source file name
   * @param line: assert_param error line source number
   * @retval None
   */
void assert_failed(uint8_t* file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
    ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */

}

#endif

static void MX_DAC1_Init(void)
{

  /* USER CODE BEGIN DAC1_Init 0 */

  /* USER CODE END DAC1_Init 0 */

  DAC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN DAC1_Init 1 */

  /* USER CODE END DAC1_Init 1 */

  /** DAC Initialization
  */
  hdac1.Instance = DAC1;
  if (HAL_DAC_Init(&hdac1) != HAL_OK)
  {
    Error_Handler();
  }

  /** DAC channel OUT1 config
  */
  sConfig.DAC_SampleAndHold = DAC_SAMPLEANDHOLD_DISABLE;
  sConfig.DAC_Trigger = DAC_TRIGGER_T2_TRGO;
  sConfig.DAC_HighFrequency = DAC_HIGH_FREQUENCY_INTERFACE_MODE_ABOVE_80MHZ;
  sConfig.DAC_OutputBuffer = DAC_OUTPUTBUFFER_ENABLE;
  sConfig.DAC_ConnectOnChipPeripheral = DAC_CHIPCONNECT_DISABLE;
  sConfig.DAC_UserTrimming = DAC_TRIMMING_FACTORY;
  if (HAL_DAC_ConfigChannel(&hdac1, &sConfig, DAC_CHANNEL_1) != HAL_OK)
  {
    Error_Handler();
  }

  /** DAC channel OUT2 config
  */
  sConfig.DAC_Trigger = DAC_TRIGGER_NONE;
  if (HAL_DAC_ConfigChannel(&hdac1, &sConfig, DAC_CHANNEL_2) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN DAC1_Init 2 */

  /* USER CODE END DAC1_Init 2 */

}

/**
  * @brief DFSDM1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_DFSDM1_Init(void)
{

  /* USER CODE BEGIN DFSDM1_Init 0 */

  /* USER CODE END DFSDM1_Init 0 */

  /* USER CODE BEGIN DFSDM1_Init 1 */

  /* USER CODE END DFSDM1_Init 1 */
  hdfsdm1_filter0.Instance = DFSDM1_Filter0;
  hdfsdm1_filter0.Init.RegularParam.Trigger = DFSDM_FILTER_SW_TRIGGER;
  hdfsdm1_filter0.Init.RegularParam.FastMode = ENABLE;
  hdfsdm1_filter0.Init.RegularParam.DmaMode = ENABLE;
  hdfsdm1_filter0.Init.FilterParam.SincOrder = DFSDM_FILTER_FASTSINC_ORDER;
  hdfsdm1_filter0.Init.FilterParam.Oversampling = 100;
  hdfsdm1_filter0.Init.FilterParam.IntOversampling = 1;
  if (HAL_DFSDM_FilterInit(&hdfsdm1_filter0) != HAL_OK)
  {
    Error_Handler();
  }
  hdfsdm1_channel2.Instance = DFSDM1_Channel2;
  hdfsdm1_channel2.Init.OutputClock.Activation = ENABLE;
  hdfsdm1_channel2.Init.OutputClock.Selection = DFSDM_CHANNEL_OUTPUT_CLOCK_SYSTEM;
  hdfsdm1_channel2.Init.OutputClock.Divider = 50*SAMPLING_RATE_FACTOR; // CHANGED FROM 50 to 100 so that SAMPLING RATE IS 10K
  hdfsdm1_channel2.Init.Input.Multiplexer = DFSDM_CHANNEL_EXTERNAL_INPUTS;
  hdfsdm1_channel2.Init.Input.DataPacking = DFSDM_CHANNEL_STANDARD_MODE;
  hdfsdm1_channel2.Init.Input.Pins = DFSDM_CHANNEL_SAME_CHANNEL_PINS;
  hdfsdm1_channel2.Init.SerialInterface.Type = DFSDM_CHANNEL_SPI_RISING;
  hdfsdm1_channel2.Init.SerialInterface.SpiClock = DFSDM_CHANNEL_SPI_CLOCK_INTERNAL;
  hdfsdm1_channel2.Init.Awd.FilterOrder = DFSDM_CHANNEL_FASTSINC_ORDER;
  hdfsdm1_channel2.Init.Awd.Oversampling = 1;
  hdfsdm1_channel2.Init.Offset = 0;
  hdfsdm1_channel2.Init.RightBitShift = 0x00;
  if (HAL_DFSDM_ChannelInit(&hdfsdm1_channel2) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_DFSDM_FilterConfigRegChannel(&hdfsdm1_filter0, DFSDM_CHANNEL_2, DFSDM_CONTINUOUS_CONV_ON) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN DFSDM1_Init 2 */

  /* USER CODE END DFSDM1_Init 2 */

}

/**
  * @brief TIM2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM2_Init(void)
{

  /* USER CODE BEGIN TIM2_Init 0 */

  /* USER CODE END TIM2_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM2_Init 1 */

  /* USER CODE END TIM2_Init 1 */
  htim2.Instance = TIM2;
  htim2.Init.Prescaler = 0;
  htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim2.Init.Period = 5000*SAMPLING_RATE_FACTOR;
  htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim2, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_UPDATE;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim2, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM2_Init 2 */

  /* USER CODE END TIM2_Init 2 */

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMAMUX1_CLK_ENABLE();
  __HAL_RCC_DMA1_CLK_ENABLE();

  /* DMA interrupt init */
  /* DMA1_Channel1_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel1_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel1_IRQn);
  /* DMA1_Channel2_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel2_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel2_IRQn);

}

/**
  * @brief  EXTI line detection callback.
  * @param  GPIO_Pin: Specifies the port pin connected to corresponding EXTI line.
  * @retval None
  */

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
  switch (GPIO_Pin)
  {
  case (GPIO_PIN_1):
    {
      SPI_WIFI_ISR();
      break;
    }
  case (GPIO_PIN_13):
     {
      buttonPressed=1;
        break;
     }
    default:
    {
      break;
    }
  }
}
/*
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin){
	if(GPIO_Pin==GPIO_PIN_1){
	    SPI_WIFI_ISR();
	}
	else if (GPIO_Pin==USER_BUTTON_PIN)
    {
     buttonPressed=true;
    }
}*/

void HAL_DFSDM_FilterRegConvCpltCallback(DFSDM_Filter_HandleTypeDef *hdfsdm_filter) {
	DFSDM_finished = true;
}

void HAL_DFSDM_FilterRegConvHalfCpltCallback (DFSDM_Filter_HandleTypeDef * hdfsdm_filter) {
	DFSDM_half_finished = true;
}
/**
  * @brief  SPI3 line detection callback.
  * @param  None
  * @retval None
  */
void SPI3_IRQHandler(void)
{
  HAL_SPI_IRQHandler(&hspi);
}

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}
#endif




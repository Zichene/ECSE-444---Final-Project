/**
  ******************************************************************************
  * @file    Wifi/WiFi_HTTP_Server/src/main.c
  * @author  MCD Application Team
  * @brief   This file provides main program functions
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2017 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
//#define SENDING_ACTIVE // Comment/Uncomment this depending on if you are this board as sending/receiving
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include <math.h>
#include "sending_board_config.h"
#define ARM_MATH_CM4
#include "arm_math.h"

#ifdef SENDING_ACTIVE
/* Private defines -----------------------------------------------------------*/
#define PORT           10 // PORT of this board [sending board]
#define REMOTE_PORT    80 // PORT Of the receiving board
#define REMOTE_SOCKET	0 // SOCKET of the receiving board
#define TERMINAL_USE

#define WIFI_WRITE_TIMEOUT 10000
#define WIFI_READ_TIMEOUT  10000
#define SOCKET                 1
#define SENDING_BUFLEN 1000
#define RECORDING_BUFLEN 40000
#define SAMPLING_RATE_FACTOR 2 // DEFAULT SAMPLING IS AT 20 kHz, a higher factor means a lower sampling rate


#ifdef  TERMINAL_USE
#define LOG(a) printf a
#else
#define LOG(a)
#endif

/* Private typedef------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
DAC_HandleTypeDef hdac1;
DMA_HandleTypeDef hdma_dac1_ch1;
DFSDM_Filter_HandleTypeDef hdfsdm1_filter0;
DFSDM_Channel_HandleTypeDef hdfsdm1_channel2;
DMA_HandleTypeDef hdma_dfsdm1_flt0;
TIM_HandleTypeDef htim2;
#if defined (TERMINAL_USE)
extern UART_HandleTypeDef hDiscoUart;
#endif /* TERMINAL_USE */

volatile uint8_t mode=0;

//static  uint8_t http[1024];
static  uint8_t  IP_Addr[4];
static uint8_t RemoteIP_Addr[4]; // address of receiving board
static int32_t recordingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static uint32_t testingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static float32_t floatBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static uint8_t sendingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime

/** INTERRUPT FLAGS **/
volatile uint8_t DFSDM_half_finished=false;
volatile uint8_t DFSDM_finished=false;
volatile uint8_t buttonPressed=0;



/* Private function prototypes -----------------------------------------------*/
#if defined (TERMINAL_USE)
#ifdef __GNUC__
/* With GCC, small printf (option LD Linker->Libraries->Small printf
   set to 'Yes') calls __io_putchar() */
#define PUTCHAR_PROTOTYPE int __io_putchar(int ch)
#else
#define PUTCHAR_PROTOTYPE int fputc(int ch, FILE *f)
#endif /* __GNUC__ */
#endif /* TERMINAL_USE */

static void SystemClock_Config(void);
static int wifi_start(void);
static int wifi_connect_to_board(uint8_t ip0, uint8_t ip1, uint8_t ip2, uint8_t ip3);
static int wifi_send_data_to_board(uint8_t* data);

/* MX Inits */
static void MX_DMA_Init(void);
static void MX_DAC1_Init(void);
static void MX_TIM2_Init(void);
static void MX_DFSDM1_Init(void);
static void MX_GPIO_Init(void);

/* Private functions ---------------------------------------------------------*/
void transformBufferToDAC(float32_t *buffer, uint32_t recording_buffer_length, uint8_t *outputBuffer);
void transformBufferToFloat(int32_t *buffer, uint32_t recording_buffer_length, float32_t *outputBuffer);

/**
  * @brief  Main program
  * @param  None
  * @retval None
  */
int main(void)
{
  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* Configure the system clock */
  SystemClock_Config();

  /* Configure LED2 */
  BSP_LED_Init(LED2);

  /* Initialize all configured peripherals */
  MX_DMA_Init();
  MX_DAC1_Init();
  MX_TIM2_Init();
  MX_DFSDM1_Init();
  MX_GPIO_Init();


  //HAL_DAC_Start(&hdac1, DAC_CHANNEL_1);
  HAL_TIM_Base_Start_IT(&htim2); // the _IT at the end of fn. means interrupt

  /* WIFI Web Server demonstration */
#if defined (TERMINAL_USE)
  /* Initialize all configured peripherals */
  hDiscoUart.Instance = DISCOVERY_COM1;
  hDiscoUart.Init.BaudRate = 115200;
  hDiscoUart.Init.WordLength = UART_WORDLENGTH_8B;
  hDiscoUart.Init.StopBits = UART_STOPBITS_1;
  hDiscoUart.Init.Parity = UART_PARITY_NONE;
  hDiscoUart.Init.Mode = UART_MODE_TX_RX;
  hDiscoUart.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  hDiscoUart.Init.OverSampling = UART_OVERSAMPLING_16;
  hDiscoUart.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  hDiscoUart.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;


  BSP_COM_Init(COM1, &hDiscoUart);

  /* resetting buffers */
  memset(recordingBuffer, 0, RECORDING_BUFLEN*sizeof(int32_t));
  memset(sendingBuffer, 0, SENDING_BUFLEN);

  printf("****** SENDING BOARD Initiating ****** \r\n");

#endif /* TERMINAL_USE */


	/*
	for (int i=0; i<RECORDING_BUFLEN;i++){
		printf("%d ", testingBuffer[i]);
	}
	*/
	//arm_rfft_fast_instance_f32 S;
	//arm_rfft_fast_init_f32(S, 1024);




	while(wifi_connect_to_board(REMOTE_IP_0, REMOTE_IP_1, REMOTE_IP_2, REMOTE_IP_3) != WIFI_STATUS_OK) {
		printf("Retrying to connect to board ... \r\n");
	}
	// successfully connected to board
	printf("Connected to other board. \r\n");
	//wifi_send_data_to_board("test");

    while (true) {
    	  printf("Waiting for button press to send mic data.\r\n");
    buttonPressed=false;
	  while(buttonPressed==false){
		__WFI(); // Waiting for interrupt mode?
	  }
	  buttonPressed=false;
		if (HAL_DFSDM_FilterRegularStart_DMA(&hdfsdm1_filter0, recordingBuffer, RECORDING_BUFLEN) != HAL_OK) {
		  printf("Failed to start DFSDM\r\n");
		}
		while (!DFSDM_finished) {
		}
		DFSDM_finished = false;
		HAL_DFSDM_FilterRegularStop_DMA(&hdfsdm1_filter0);

		transformBufferToFloat(recordingBuffer, RECORDING_BUFLEN, floatBuffer);
		/** Filter setup**/
		int32_t NumTaps=2048;
		int32_t blockSize=32;
		float32_t firStateF32[2*blockSize+NumTaps-1];
		float32_t firCoeffs32[2048]={ 2.2169437e-05,  1.7611449e-05,  1.1319235e-05,  3.9046933e-06, -3.9092642e-06, -1.1359033e-05, -1.7714769e-05, -2.2351731e-05, -2.4811546e-05, -2.4847418e-05, -2.2448817e-05, -1.7843192e-05, -1.1474480e-05, -3.9604181e-06,  3.9672265e-06,  1.1533758e-05,  1.7997083e-05,  2.2720321e-05,  2.5234422e-05,  2.5284625e-05,  2.2856192e-05,  1.8176805e-05,  1.1695316e-05,  4.0388089e-06, -4.0479195e-06, -1.1774639e-05, -1.8382728e-05, -2.3219487e-05, -2.5802451e-05, -2.5867396e-05, -2.3395253e-05, -1.8615219e-05, -1.1983628e-05, -4.1405152e-06,  4.1519934e-06,  1.2083563e-05,  1.8874649e-05,  2.3852940e-05,  2.6519754e-05,  2.6599854e-05,  2.4069722e-05,  1.9161390e-05,  1.2341315e-05,  4.2661926e-06, -4.2801041e-06, -1.2462436e-05, -1.9475817e-05, -2.4624429e-05, -2.7390486e-05, -2.7486159e-05, -2.4883356e-05, -1.9818304e-05, -1.2770296e-05, -4.4165024e-06,  4.4329139e-06,  1.2913181e-05,  2.0189230e-05,  2.5537734e-05,  2.8418847e-05,  2.8530515e-05,  2.5839951e-05,  2.0588974e-05,  1.3272507e-05,  4.5921130e-06, -4.6110915e-06, -1.3437742e-05, -2.1017918e-05, -2.6596679e-05, -2.9609074e-05, -2.9737165e-05, -2.6943338e-05, -2.1476445e-05, -1.3849906e-05, -4.7936993e-06,  4.8153128e-06,  1.4038083e-05,  2.1964942e-05,  2.7805124e-05,  3.0965456e-05,  3.1110399e-05,  2.8197393e-05,  2.2483796e-05,  1.4504472e-05,  5.0219441e-06, -5.0462613e-06, -1.4716188e-05, -2.3033399e-05, -2.9166977e-05, -3.2492326e-05, -3.2654559e-05, -2.9606036e-05, -2.3614142e-05, -1.5238206e-05, -5.2775380e-06,  5.3046285e-06,  1.5474067e-05,  2.4226422e-05,  3.0686189e-05,  3.4194073e-05,  3.4374036e-05,  3.1173235e-05,  2.4870636e-05,  1.6053137e-05,  5.5611804e-06, -5.5911145e-06, -1.6313755e-05, -2.5547185e-05, -3.2366765e-05, -3.6075140e-05, -3.6273282e-05, -3.2903010e-05, -2.6256472e-05, -1.6951316e-05, -5.8735799e-06,  5.9064290e-06,  1.7237314e-05,  2.6998904e-05,  3.4212764e-05,  3.8140032e-05,  3.8356807e-05,  3.4799435e-05,  2.7774889e-05,  1.7934828e-05,  6.2154551e-06, -6.2512917e-06, -1.8246836e-05, -2.8584841e-05, -3.6228303e-05, -4.0393321e-05, -4.0629190e-05, -3.6866648e-05, -2.9429174e-05, -1.9005785e-05, -6.5875354e-06,  6.6264332e-06,  1.9344444e-05,  3.0308309e-05,  3.8417561e-05,  4.2839648e-05,  4.3095079e-05,  3.9108848e-05,  3.1222667e-05,  2.0166335e-05,  6.9905621e-06, -7.0325957e-06, -2.0532296e-05, -3.2172675e-05, -4.0784790e-05, -4.5483731e-05, -4.5759200e-05, -4.1530307e-05, -3.3158763e-05, -2.1418662e-05, -7.4252888e-06,  7.4705344e-06,  2.1812587e-05,  3.4181364e-05,  4.3334311e-05,  4.8330372e-05,  4.8626364e-05,  4.4135371e-05,  3.5240917e-05,  2.2764988e-05,  7.8924829e-06, -7.9410180e-06, -2.3187554e-05, -3.6337864e-05, -4.6070530e-05, -5.1384461e-05, -5.1701471e-05, -4.6928470e-05, -3.7472651e-05, -2.4207580e-05, -8.3929267e-06,  8.4448304e-06,  2.4659473e-05,  3.8645731e-05,  4.8997936e-05,  5.4650987e-05,  5.4989519e-05,  4.9914122e-05,  3.9857559e-05,  2.5748748e-05,  8.9274183e-06, -8.9827713e-06, -2.6230673e-05, -4.1108597e-05, -5.2121114e-05, -5.8135042e-05, -5.8495611e-05, -5.3096941e-05, -4.2399311e-05, -2.7390854e-05, -9.4967731e-06,  9.5556581e-06,  2.7903529e-05,  4.3730172e-05,  5.5444752e-05,  6.1841834e-05,  6.2224968e-05,  5.6481647e-05,  4.5101659e-05,  2.9136315e-05,  1.0101826e-05, -1.0164327e-05, -2.9680475e-05, -4.6514255e-05, -5.8973645e-05, -6.5776693e-05, -6.6182932e-05, -6.0073070e-05, -4.7968449e-05, -3.0987603e-05, -1.0743430e-05,  1.0809635e-05,  3.1564003e-05,  4.9464737e-05,  6.2712712e-05,  6.9945083e-05,  7.0374981e-05,  6.3876166e-05,  5.1003622e-05,  3.2947257e-05,  1.1422464e-05, -1.1492460e-05, -3.3556672e-05, -5.2585613e-05, -6.6666998e-05, -7.4352615e-05, -7.4806741e-05, -6.7896024e-05, -5.4211228e-05, -3.5017883e-05, -1.2139827e-05,  1.2213707e-05,  3.5661109e-05,  5.5880989e-05,  7.0841693e-05,  7.9005054e-05,  7.9483995e-05,  7.2137875e-05,  5.7595430e-05,  3.7202163e-05,  1.2896447e-05, -1.2974305e-05, -3.7880020e-05, -5.9355091e-05, -7.5242136e-05, -8.3908340e-05, -8.4412699e-05, -7.6607109e-05, -6.1160520e-05, -3.9502860e-05, -1.3693278e-05,  1.3775211e-05,  4.0216194e-05,  6.3012274e-05,  7.9873834e-05,  8.9068595e-05,  8.9598996e-05,  8.1309284e-05,  6.4910921e-05,  4.1922823e-05,  1.4531306e-05, -1.4617413e-05, -4.2672508e-05, -6.6857038e-05, -8.4742474e-05, -9.4492144e-05, -9.5049230e-05, -8.6250144e-05, -6.8851209e-05, -4.4465001e-05, -1.5411549e-05,  1.5501935e-05,  4.5251939e-05,  7.0894033e-05,  8.9853938e-05,  1.0018553e-04,  1.0076997e-04,  9.1435633e-05,  7.2986116e-05,  4.7132441e-05,  1.6335062e-05, -1.6429835e-05, -4.7957570e-05, -7.5128079e-05, -9.5214320e-05, -1.0615553e-04, -1.0676802e-04, -9.6871913e-05, -7.7320551e-05, -4.9928308e-05, -1.7302939e-05,  1.7402210e-05,  5.0792599e-05,  7.9564176e-05,  1.0082994e-04,  1.1240919e-04,  1.1305044e-04,  1.0256538e-04,  8.1859609e-05,  5.2855886e-05,  1.8316315e-05, -1.8420201e-05, -5.3760350e-05, -8.4207521e-05, -1.0670739e-04, -1.1895382e-04, -1.1962458e-04, -1.0852269e-04, -8.6608594e-05, -5.5918592e-05, -1.9376375e-05,  1.9484995e-05,  5.6864282e-05,  8.9063525e-05,  1.1285349e-04,  1.2579704e-04,  1.2649809e-04,  1.1475077e-04,  9.1573028e-05,  5.9119989e-05,  2.0484350e-05, -2.0597832e-05, -6.0108005e-05, -9.4137832e-05, -1.1927540e-04, -1.3294681e-04, -1.3367896e-04, -1.2125686e-04, -9.6758681e-05, -6.2463796e-05, -2.1641527e-05,  2.1760002e-05,  6.3495285e-05,  9.9436339e-05,  1.2598058e-04,  1.4041143e-04,  1.4117554e-04,  1.2804853e-04,  1.0217158e-04,  6.5953904e-05,  2.2849253e-05, -2.2972860e-05, -6.7030068e-05, -1.0496522e-04, -1.3297684e-04, -1.4819960e-04, -1.4899656e-04, -1.3513370e-04, -1.0781805e-04, -6.9594386e-05, -2.4108940e-05,  2.4237823e-05,  7.0716488e-05,  1.1073093e-04,  1.4027238e-04,  1.5632046e-04,  1.5715120e-04,  1.4252067e-04,  1.1370472e-04,  7.3389522e-05,  2.5422067e-05, -2.5556379e-05, -7.4558887e-05, -1.1674029e-04, -1.4787580e-04, -1.6478358e-04, -1.6564910e-04, -1.5021820e-04, -1.1983855e-04, -7.7343809e-05, -2.6790194e-05,  2.6930094e-05,  7.8561830e-05,  1.2300043e-04,  1.5579615e-04,  1.7359907e-04,  1.7450040e-04,  1.5823547e-04,  1.2622689e-04,  8.1461983e-05,  2.8214960e-05, -2.8360618e-05, -8.2730133e-05, -1.2951890e-04, -1.6404299e-04, -1.8277756e-04, -1.8371580e-04, -1.6658220e-04, -1.3287747e-04, -8.5749043e-05, -2.9698098e-05,  2.9849692e-05,  8.7068876e-05,  1.3630365e-04,  1.7262640e-04,  1.9233029e-04,  1.9330660e-04,  1.7526863e-04,  1.3979849e-04,  9.0210273e-05,  3.1241439e-05, -3.1399158e-05, -9.1583432e-05, -1.4336310e-04, -1.8155705e-04, -2.0226915e-04, -2.0328476e-04, -1.8430562e-04, -1.4699860e-04, -9.4851266e-05, -3.2846921e-05,  3.3010965e-05,  9.6279495e-05,  1.5070616e-04,  1.9084624e-04,  2.1260676e-04,  2.1366296e-04,  1.9370468e-04,  1.5448699e-04,  9.9677956e-05,  3.4516601e-05, -3.4687183e-05, -1.0116311e-04, -1.5834232e-04, -2.0050597e-04, -2.2335649e-04, -2.2445467e-04, -2.0347803e-04, -1.6227342e-04, -1.0469665e-04, -3.6252665e-05,  3.6430011e-05,  1.0624069e-04,  1.6628163e-04,  2.1054900e-04,  2.3453259e-04,  2.3567423e-04,  2.1363867e-04,  1.7036828e-04,  1.0991405e-04,  3.8057441e-05, -3.8241792e-05, -1.1151908e-04, -1.7453481e-04, -2.2098895e-04, -2.4615022e-04, -2.4733688e-04, -2.2420047e-04, -1.7878265e-04, -1.1533733e-04, -3.9933410e-05,  4.0125023e-05,  1.1700559e-04,  1.8311330e-04,  2.3184031e-04,  2.5822558e-04,  2.5945894e-04,  2.3517823e-04,  1.8752833e-04,  1.2097412e-04,  4.1883224e-05, -4.2082374e-05, -1.2270800e-04, -1.9202934e-04, -2.4311860e-04, -2.7077597e-04, -2.7205784e-04, -2.4658779e-04, -1.9661800e-04, -1.2683260e-04, -4.3909719e-05,  4.4116701e-05,  1.2863466e-04,  2.0129602e-04,  2.5484043e-04,  2.8381995e-04,  2.8515225e-04,  2.5844610e-04,  2.0606520e-04,  1.3292153e-04,  4.6015938e-05, -4.6231068e-05, -1.3479454e-04, -2.1092738e-04, -2.6702362e-04, -2.9737741e-04, -2.9876221e-04, -2.7077137e-04, -2.1588449e-04, -1.3925033e-04, -4.8205147e-05,  4.8428766e-05,  1.4119724e-04,  2.2093851e-04,  2.7968733e-04,  3.1146974e-04,  3.1290927e-04,  2.8358319e-04,  2.2609152e-04,  1.4582912e-04,  5.0480861e-05, -5.0713333e-05, -1.4785312e-04, -2.3134565e-04, -2.9285218e-04, -3.2611997e-04, -3.2761661e-04, -2.9690264e-04, -2.3670315e-04, -1.5266881e-04, -5.2846866e-05,  5.3088587e-05,  1.5477333e-04,  2.4216632e-04,  3.0654041e-04,  3.4135293e-04,  3.4290929e-04,  3.1075248e-04,  2.4773758e-04,  1.5978118e-04,  5.5307251e-05, -5.5558647e-05, -1.6196994e-04, -2.5341943e-04, -3.2077603e-04, -3.5719547e-04, -3.5881434e-04, -3.2515729e-04, -2.5921449e-04, -1.6717895e-04, -5.7866438e-05,  5.8127972e-05,  1.6945597e-04,  2.6512546e-04,  3.3558506e-04,  3.7367664e-04,  3.7536107e-04,  3.4014374e-04,  2.7115518e-04,  1.7487592e-04,  6.0529221e-05, -6.0801393e-05, -1.7724556e-04, -2.7730660e-04, -3.5099569e-04, -3.9082796e-04, -3.9258125e-04, -3.5574070e-04, -2.8358279e-04, -1.8288707e-04, -6.3300800e-05,  6.3584155e-05,  1.8535407e-04,  2.8998697e-04,  3.6703856e-04,  4.0868369e-04,  4.1050941e-04,  3.7197962e-04,  2.9652247e-04,  1.9122867e-04,  6.6186834e-05, -6.6481965e-05, -1.9379820e-04, -3.0319279e-04, -3.8374702e-04, -4.2728109e-04, -4.2918316e-04, -3.8889470e-04, -3.1000160e-04, -1.9991846e-04, -6.9193489e-05,  6.9501043e-05,  2.0259615e-04,  3.1695270e-04,  4.0115743e-04,  4.4666086e-04,  4.4864354e-04,  4.0652329e-04,  3.2405008e-04,  2.0897583e-04,  7.2327499e-05, -7.2648182e-05, -2.1176783e-04, -3.3129794e-04, -4.1930955e-04, -4.6686744e-04, -4.6893541e-04, -4.2490622e-04, -3.3870063e-04, -2.1842194e-04, -7.5596232e-05,  7.5930820e-05,  2.2133500e-04,  3.4626275e-04,  4.3824691e-04,  4.8794954e-04,  4.9010791e-04,  4.4408826e-04,  3.5398909e-04,  2.2828004e-04,  7.9007767e-05, -7.9357109e-05, -2.3132156e-04, -3.6188468e-04, -4.5801729e-04, -5.0996062e-04, -5.1221503e-04, -4.6411856e-04, -3.6995483e-04, -2.3857565e-04, -8.2570984e-05,  8.2936016e-05,  2.4175377e-04,  3.7820505e-04,  4.7867322e-04,  5.3295949e-04,  5.3531615e-04,  4.8505120e-04,  3.8664120e-04,  2.4933687e-04,  8.6295661e-05, -8.6677415e-05, -2.5266058e-04, -3.9526938e-04, -5.0027266e-04, -5.5701102e-04, -5.5947676e-04, -5.0694587e-04, -4.0409605e-04, -2.6059472e-04, -9.0192597e-05,  9.0592214e-05,  2.6407396e-04,  4.1312797e-04,  5.2287962e-04,  5.8218690e-04,  5.8476932e-04,  5.2986858e-04,  4.2237230e-04,  2.7238354e-04,  9.4273741e-05, -9.4692485e-05, -2.7602931e-04, -4.3183654e-04, -5.4656504e-04, -6.0856659e-04, -6.1127409e-04, -5.5389252e-04, -4.4152863e-04, -2.8474140e-04, -9.8552354e-05,  9.8991630e-05,  2.8856593e-04,  4.5145695e-04,  5.7140771e-04,  6.3623837e-04,  6.3908030e-04,  5.7909905e-04,  4.6163033e-04,  2.9771066e-04,  1.0304319e-04, -1.0350456e-04, -3.0172758e-04, -4.7205810e-04, -5.9749542e-04, -6.6530060e-04, -6.6828742e-04, -6.0557887e-04, -4.8275016e-04, -3.1133857e-04, -1.0776271e-04,  1.0824793e-04,  3.1556312e-04,  4.9371694e-04,  6.2492619e-04,  6.9586319e-04,  6.9900658e-04,  6.3343340e-04,  5.0496953e-04,  3.2567799e-04,  1.1272934e-04, -1.1324037e-04, -3.3012724e-04, -5.1651965e-04, -6.5380988e-04, -7.2804933e-04, -7.3136243e-04, -6.6277638e-04, -5.2837976e-04, -3.4078824e-04, -1.1796376e-04,  1.1850280e-04,  3.4548140e-04,  5.4056307e-04,  6.8426999e-04,  7.6199755e-04,  7.6549513e-04,  6.9373579e-04,  5.5308364e-04,  3.5673611e-04,  1.2348926e-04, -1.2405880e-04, -3.6169484e-04, -5.6595640e-04, -7.1644579e-04, -7.9786413e-04, -8.0156292e-04, -7.2645613e-04, -5.7919727e-04, -3.7359708e-04, -1.2933218e-04,  1.2993504e-04,  3.7884592e-04,  5.9282320e-04,  7.5049495e-04,  8.3582607e-04,  8.3974503e-04,  7.6110116e-04,  6.0685228e-04,  3.9145673e-04,  1.3552238e-04, -1.3616177e-04, -3.9702359e-04, -6.2130381e-04, -7.8659662e-04, -8.7608456e-04, -8.8024529e-04, -7.9785718e-04, -6.3619846e-04, -4.1041251e-04, -1.4209389e-04,  1.4277347e-04,  4.1632925e-04,  6.5155830e-04,  8.2495519e-04,  9.1886923e-04,  9.2329645e-04,  8.3693701e-04,  6.6740702e-04,  4.3057586e-04,  1.4908564e-04, -1.4980959e-04, -4.3687899e-04, -6.8376999e-04, -8.6580491e-04, -9.6444337e-04, -9.6916549e-04, -8.7858487e-04, -7.0067450e-04, -4.5207475e-04, -1.5654235e-04,  1.5731551e-04,  4.5880635e-04,  7.1814986e-04,  9.0941543e-04,  1.0131102e-03,  1.0181600e-03,  9.2308234e-04,  7.3622763e-04,  4.7505687e-04,  1.6451566e-04, -1.6534363e-04, -4.8226566e-04, -7.5494187e-04, -9.5609876e-04, -1.0652208e-03, -1.0706365e-03, -9.7075572e-04, -7.7432930e-04, -4.9969359e-04, -1.7306551e-04,  1.7395481e-04,  5.0743629e-04,  7.9442968e-04,  1.0062179e-03,  1.1211838e-03,  1.1270097e-03,  1.0219852e-03,  8.1528601e-04,  5.2618480e-04,  1.8226189e-04, -1.8322013e-04, -5.3452783e-04, -8.3694499e-04, -1.0601975e-03, -1.1814775e-03, -1.1877660e-03, -1.0772167e-03, -8.5945729e-04, -5.5476512e-04, -1.9218697e-04,  1.9322315e-04,  5.6378675e-04,  8.8287811e-04,  1.1185376e-03,  1.2466657e-03,  1.2534785e-03,  1.1369758e-03,  9.0726760e-04,  5.8571174e-04,  2.0293790e-04, -2.0406269e-04, -5.9550487e-04, -9.3269147e-04, -1.1818312e-03, -1.3174171e-03, -1.3248277e-03, -1.2018876e-03, -9.5922162e-04, -6.1935448e-04, -2.1463038e-04,  2.1585653e-04,  6.3003019e-04,  9.8693694e-04,  1.2507864e-03,  1.3945311e-03,  1.4026279e-03,  1.2727000e-03,  1.0159241e-03,  6.5608887e-04,  2.2740325e-04, -2.2874614e-04, -6.6778105e-04, -1.0462786e-03, -1.3262559e-03, -1.4789712e-03, -1.4878611e-03, -1.3503163e-03, -1.0781058e-03, -6.9639330e-04, -2.4142461e-04,  2.4290295e-04,  7.0926486e-04,  1.1115224e-03,  1.4092758e-03,  1.5719091e-03,  1.5817230e-03,  1.4358370e-03,  1.1466580e-03,  7.4085185e-04,  2.5689990e-04, -2.5853667e-04, -7.5510296e-04, -1.1836567e-03, -1.5011178e-03, -1.6747844e-03, -1.6856837e-03, -1.5306170e-03, -1.2226793e-03, -7.9018511e-04, -2.7408282e-04,  2.7590660e-04,  8.0606452e-04,  1.2639059e-03,  1.6033593e-03,  1.7893850e-03,  1.8015718e-03,  1.6363432e-03,  1.3075389e-03,  8.4529246e-04,  2.9329047e-04, -2.9533718e-04, -8.6311311e-04, -1.3538063e-03, -1.7179818e-03, -1.9179597e-03, -1.9316897e-03, -1.7551428e-03, -1.4029660e-03, -9.0731109e-04, -3.1492429e-04,  3.1723977e-04,  9.2747221e-04,  1.4553110e-03,  1.8475083e-03,  2.0633762e-03,  2.0789782e-03,  1.8897366e-03,  1.5111755e-03,  9.7770000e-04,  3.3950016e-04, -3.4214384e-04, -1.0007190e-03, -1.5709422e-03, -1.9952021e-03, -2.2293494e-03, -2.2472533e-03, -2.0436615e-03, -1.6350516e-03, -1.0583624e-03, -3.6769222e-04,  3.7074249e-04,  1.0849221e-03,  1.7040136e-03,  2.1653592e-03,  2.4207794e-03,  2.4415582e-03,  2.2216006e-03,  1.7784210e-03,  1.1518286e-03,  4.0039856e-04, -4.0396102e-04, -1.1828488e-03, -1.8589680e-03, -2.3637512e-03, -2.6442642e-03, -2.6686986e-03, -2.4298885e-03, -1.9464719e-03, -1.2615369e-03, -4.3884250e-04,  4.4306290e-04,  1.2982870e-03,  2.0419022e-03,  2.5983189e-03,  2.9089047e-03,  2.9380867e-03,  2.6773092e-03,  2.1464176e-03,  1.3922813e-03,  4.8473449e-04, -4.8981970e-04, -1.4365636e-03, -2.2614148e-03, -2.8802953e-03, -3.2276148e-03, -3.2631199e-03, -2.9764052e-03, -2.3885921e-03, -1.5509523e-03, -5.4054115e-04,  5.4679499e-04,  1.6054136e-03,  2.5300365e-03,  3.2261095e-03,  3.6193512e-03,  3.6635390e-03,  3.3457291e-03,  2.6883406e-03,  1.7478226e-03,  6.0995503e-04, -6.1784242e-04, -1.8165141e-03, -2.8667664e-03, -3.6607823e-03, -4.1131161e-03, -4.1696854e-03, -3.8139318e-03, -3.0694758e-03, -1.9989129e-03, -6.9876399e-04,  7.0903385e-04,  2.0883619e-03,  3.3018637e-03,  4.2243861e-03,  4.7556243e-03,  4.8307190e-03,  4.4277132e-03,  3.5710519e-03,  2.3306647e-03,  8.1658290e-04, -8.3052339e-04, -2.4521022e-03, -3.8866391e-03, -4.9853653e-03, -5.6272615e-03, -5.7318826e-03, -5.2686916e-03, -4.2618808e-03, -2.7900576e-03, -9.8064279e-04,  1.0006709e-03,  2.9645680e-03,  4.7156140e-03,  6.0710438e-03,  6.8790847e-03,  7.0350444e-03,  6.4935392e-03,  5.2755402e-03,  3.4693544e-03,  1.2251935e-03, -1.2564290e-03, -3.7416410e-03, -5.9841353e-03, -7.7482814e-03, -8.8323598e-03, -9.0897499e-03, -8.4460028e-03, -6.9100141e-03, -4.5779788e-03, -1.6294031e-03,  1.6848563e-03,  5.0618463e-03,  8.1716938e-03,  1.0686750e-02,  1.2312304e-02,  1.2816236e-02,  1.2054935e-02,  9.9930400e-03,  6.7149822e-03,  2.4269156e-03, -2.5515941e-03, -7.8059283e-03, -1.2853765e-02, -1.7179572e-02, -2.0273735e-02, -2.1673332e-02, -2.1001351e-02, -1.8001122e-02, -1.2563079e-02, -4.7414484e-03,  5.2407754e-03,  1.6999318e-02,  3.0008373e-02,  4.3631426e-02,  5.7161079e-02,  6.9865055e-02,  8.1035060e-02,  9.0034873e-02,  9.6344080e-02,  9.9594154e-02,  9.9594154e-02,  9.6344080e-02,  9.0034873e-02,  8.1035060e-02,  6.9865055e-02,  5.7161079e-02,  4.3631426e-02,  3.0008373e-02,  1.6999318e-02,  5.2407754e-03, -4.7414484e-03, -1.2563079e-02, -1.8001122e-02, -2.1001351e-02, -2.1673332e-02, -2.0273735e-02, -1.7179572e-02, -1.2853765e-02, -7.8059283e-03, -2.5515941e-03,  2.4269156e-03,  6.7149822e-03,  9.9930400e-03,  1.2054935e-02,  1.2816236e-02,  1.2312304e-02,  1.0686750e-02,  8.1716938e-03,  5.0618463e-03,  1.6848563e-03, -1.6294031e-03, -4.5779788e-03, -6.9100141e-03, -8.4460028e-03, -9.0897499e-03, -8.8323598e-03, -7.7482814e-03, -5.9841353e-03, -3.7416410e-03, -1.2564290e-03,  1.2251935e-03,  3.4693544e-03,  5.2755402e-03,  6.4935392e-03,  7.0350444e-03,  6.8790847e-03,  6.0710438e-03,  4.7156140e-03,  2.9645680e-03,  1.0006709e-03, -9.8064279e-04, -2.7900576e-03, -4.2618808e-03, -5.2686916e-03, -5.7318826e-03, -5.6272615e-03, -4.9853653e-03, -3.8866391e-03, -2.4521022e-03, -8.3052339e-04,  8.1658290e-04,  2.3306647e-03,  3.5710519e-03,  4.4277132e-03,  4.8307190e-03,  4.7556243e-03,  4.2243861e-03,  3.3018637e-03,  2.0883619e-03,  7.0903385e-04, -6.9876399e-04, -1.9989129e-03, -3.0694758e-03, -3.8139318e-03, -4.1696854e-03, -4.1131161e-03, -3.6607823e-03, -2.8667664e-03, -1.8165141e-03, -6.1784242e-04,  6.0995503e-04,  1.7478226e-03,  2.6883406e-03,  3.3457291e-03,  3.6635390e-03,  3.6193512e-03,  3.2261095e-03,  2.5300365e-03,  1.6054136e-03,  5.4679499e-04, -5.4054115e-04, -1.5509523e-03, -2.3885921e-03, -2.9764052e-03, -3.2631199e-03, -3.2276148e-03, -2.8802953e-03, -2.2614148e-03, -1.4365636e-03, -4.8981970e-04,  4.8473449e-04,  1.3922813e-03,  2.1464176e-03,  2.6773092e-03,  2.9380867e-03,  2.9089047e-03,  2.5983189e-03,  2.0419022e-03,  1.2982870e-03,  4.4306290e-04, -4.3884250e-04, -1.2615369e-03, -1.9464719e-03, -2.4298885e-03, -2.6686986e-03, -2.6442642e-03, -2.3637512e-03, -1.8589680e-03, -1.1828488e-03, -4.0396102e-04,  4.0039856e-04,  1.1518286e-03,  1.7784210e-03,  2.2216006e-03,  2.4415582e-03,  2.4207794e-03,  2.1653592e-03,  1.7040136e-03,  1.0849221e-03,  3.7074249e-04, -3.6769222e-04, -1.0583624e-03, -1.6350516e-03, -2.0436615e-03, -2.2472533e-03, -2.2293494e-03, -1.9952021e-03, -1.5709422e-03, -1.0007190e-03, -3.4214384e-04,  3.3950016e-04,  9.7770000e-04,  1.5111755e-03,  1.8897366e-03,  2.0789782e-03,  2.0633762e-03,  1.8475083e-03,  1.4553110e-03,  9.2747221e-04,  3.1723977e-04, -3.1492429e-04, -9.0731109e-04, -1.4029660e-03, -1.7551428e-03, -1.9316897e-03, -1.9179597e-03, -1.7179818e-03, -1.3538063e-03, -8.6311311e-04, -2.9533718e-04,  2.9329047e-04,  8.4529246e-04,  1.3075389e-03,  1.6363432e-03,  1.8015718e-03,  1.7893850e-03,  1.6033593e-03,  1.2639059e-03,  8.0606452e-04,  2.7590660e-04, -2.7408282e-04, -7.9018511e-04, -1.2226793e-03, -1.5306170e-03, -1.6856837e-03, -1.6747844e-03, -1.5011178e-03, -1.1836567e-03, -7.5510296e-04, -2.5853667e-04,  2.5689990e-04,  7.4085185e-04,  1.1466580e-03,  1.4358370e-03,  1.5817230e-03,  1.5719091e-03,  1.4092758e-03,  1.1115224e-03,  7.0926486e-04,  2.4290295e-04, -2.4142461e-04, -6.9639330e-04, -1.0781058e-03, -1.3503163e-03, -1.4878611e-03, -1.4789712e-03, -1.3262559e-03, -1.0462786e-03, -6.6778105e-04, -2.2874614e-04,  2.2740325e-04,  6.5608887e-04,  1.0159241e-03,  1.2727000e-03,  1.4026279e-03,  1.3945311e-03,  1.2507864e-03,  9.8693694e-04,  6.3003019e-04,  2.1585653e-04, -2.1463038e-04, -6.1935448e-04, -9.5922162e-04, -1.2018876e-03, -1.3248277e-03, -1.3174171e-03, -1.1818312e-03, -9.3269147e-04, -5.9550487e-04, -2.0406269e-04,  2.0293790e-04,  5.8571174e-04,  9.0726760e-04,  1.1369758e-03,  1.2534785e-03,  1.2466657e-03,  1.1185376e-03,  8.8287811e-04,  5.6378675e-04,  1.9322315e-04, -1.9218697e-04, -5.5476512e-04, -8.5945729e-04, -1.0772167e-03, -1.1877660e-03, -1.1814775e-03, -1.0601975e-03, -8.3694499e-04, -5.3452783e-04, -1.8322013e-04,  1.8226189e-04,  5.2618480e-04,  8.1528601e-04,  1.0219852e-03,  1.1270097e-03,  1.1211838e-03,  1.0062179e-03,  7.9442968e-04,  5.0743629e-04,  1.7395481e-04, -1.7306551e-04, -4.9969359e-04, -7.7432930e-04, -9.7075572e-04, -1.0706365e-03, -1.0652208e-03, -9.5609876e-04, -7.5494187e-04, -4.8226566e-04, -1.6534363e-04,  1.6451566e-04,  4.7505687e-04,  7.3622763e-04,  9.2308234e-04,  1.0181600e-03,  1.0131102e-03,  9.0941543e-04,  7.1814986e-04,  4.5880635e-04,  1.5731551e-04, -1.5654235e-04, -4.5207475e-04, -7.0067450e-04, -8.7858487e-04, -9.6916549e-04, -9.6444337e-04, -8.6580491e-04, -6.8376999e-04, -4.3687899e-04, -1.4980959e-04,  1.4908564e-04,  4.3057586e-04,  6.6740702e-04,  8.3693701e-04,  9.2329645e-04,  9.1886923e-04,  8.2495519e-04,  6.5155830e-04,  4.1632925e-04,  1.4277347e-04, -1.4209389e-04, -4.1041251e-04, -6.3619846e-04, -7.9785718e-04, -8.8024529e-04, -8.7608456e-04, -7.8659662e-04, -6.2130381e-04, -3.9702359e-04, -1.3616177e-04,  1.3552238e-04,  3.9145673e-04,  6.0685228e-04,  7.6110116e-04,  8.3974503e-04,  8.3582607e-04,  7.5049495e-04,  5.9282320e-04,  3.7884592e-04,  1.2993504e-04, -1.2933218e-04, -3.7359708e-04, -5.7919727e-04, -7.2645613e-04, -8.0156292e-04, -7.9786413e-04, -7.1644579e-04, -5.6595640e-04, -3.6169484e-04, -1.2405880e-04,  1.2348926e-04,  3.5673611e-04,  5.5308364e-04,  6.9373579e-04,  7.6549513e-04,  7.6199755e-04,  6.8426999e-04,  5.4056307e-04,  3.4548140e-04,  1.1850280e-04, -1.1796376e-04, -3.4078824e-04, -5.2837976e-04, -6.6277638e-04, -7.3136243e-04, -7.2804933e-04, -6.5380988e-04, -5.1651965e-04, -3.3012724e-04, -1.1324037e-04,  1.1272934e-04,  3.2567799e-04,  5.0496953e-04,  6.3343340e-04,  6.9900658e-04,  6.9586319e-04,  6.2492619e-04,  4.9371694e-04,  3.1556312e-04,  1.0824793e-04, -1.0776271e-04, -3.1133857e-04, -4.8275016e-04, -6.0557887e-04, -6.6828742e-04, -6.6530060e-04, -5.9749542e-04, -4.7205810e-04, -3.0172758e-04, -1.0350456e-04,  1.0304319e-04,  2.9771066e-04,  4.6163033e-04,  5.7909905e-04,  6.3908030e-04,  6.3623837e-04,  5.7140771e-04,  4.5145695e-04,  2.8856593e-04,  9.8991630e-05, -9.8552354e-05, -2.8474140e-04, -4.4152863e-04, -5.5389252e-04, -6.1127409e-04, -6.0856659e-04, -5.4656504e-04, -4.3183654e-04, -2.7602931e-04, -9.4692485e-05,  9.4273741e-05,  2.7238354e-04,  4.2237230e-04,  5.2986858e-04,  5.8476932e-04,  5.8218690e-04,  5.2287962e-04,  4.1312797e-04,  2.6407396e-04,  9.0592214e-05, -9.0192597e-05, -2.6059472e-04, -4.0409605e-04, -5.0694587e-04, -5.5947676e-04, -5.5701102e-04, -5.0027266e-04, -3.9526938e-04, -2.5266058e-04, -8.6677415e-05,  8.6295661e-05,  2.4933687e-04,  3.8664120e-04,  4.8505120e-04,  5.3531615e-04,  5.3295949e-04,  4.7867322e-04,  3.7820505e-04,  2.4175377e-04,  8.2936016e-05, -8.2570984e-05, -2.3857565e-04, -3.6995483e-04, -4.6411856e-04, -5.1221503e-04, -5.0996062e-04, -4.5801729e-04, -3.6188468e-04, -2.3132156e-04, -7.9357109e-05,  7.9007767e-05,  2.2828004e-04,  3.5398909e-04,  4.4408826e-04,  4.9010791e-04,  4.8794954e-04,  4.3824691e-04,  3.4626275e-04,  2.2133500e-04,  7.5930820e-05, -7.5596232e-05, -2.1842194e-04, -3.3870063e-04, -4.2490622e-04, -4.6893541e-04, -4.6686744e-04, -4.1930955e-04, -3.3129794e-04, -2.1176783e-04, -7.2648182e-05,  7.2327499e-05,  2.0897583e-04,  3.2405008e-04,  4.0652329e-04,  4.4864354e-04,  4.4666086e-04,  4.0115743e-04,  3.1695270e-04,  2.0259615e-04,  6.9501043e-05, -6.9193489e-05, -1.9991846e-04, -3.1000160e-04, -3.8889470e-04, -4.2918316e-04, -4.2728109e-04, -3.8374702e-04, -3.0319279e-04, -1.9379820e-04, -6.6481965e-05,  6.6186834e-05,  1.9122867e-04,  2.9652247e-04,  3.7197962e-04,  4.1050941e-04,  4.0868369e-04,  3.6703856e-04,  2.8998697e-04,  1.8535407e-04,  6.3584155e-05, -6.3300800e-05, -1.8288707e-04, -2.8358279e-04, -3.5574070e-04, -3.9258125e-04, -3.9082796e-04, -3.5099569e-04, -2.7730660e-04, -1.7724556e-04, -6.0801393e-05,  6.0529221e-05,  1.7487592e-04,  2.7115518e-04,  3.4014374e-04,  3.7536107e-04,  3.7367664e-04,  3.3558506e-04,  2.6512546e-04,  1.6945597e-04,  5.8127972e-05, -5.7866438e-05, -1.6717895e-04, -2.5921449e-04, -3.2515729e-04, -3.5881434e-04, -3.5719547e-04, -3.2077603e-04, -2.5341943e-04, -1.6196994e-04, -5.5558647e-05,  5.5307251e-05,  1.5978118e-04,  2.4773758e-04,  3.1075248e-04,  3.4290929e-04,  3.4135293e-04,  3.0654041e-04,  2.4216632e-04,  1.5477333e-04,  5.3088587e-05, -5.2846866e-05, -1.5266881e-04, -2.3670315e-04, -2.9690264e-04, -3.2761661e-04, -3.2611997e-04, -2.9285218e-04, -2.3134565e-04, -1.4785312e-04, -5.0713333e-05,  5.0480861e-05,  1.4582912e-04,  2.2609152e-04,  2.8358319e-04,  3.1290927e-04,  3.1146974e-04,  2.7968733e-04,  2.2093851e-04,  1.4119724e-04,  4.8428766e-05, -4.8205147e-05, -1.3925033e-04, -2.1588449e-04, -2.7077137e-04, -2.9876221e-04, -2.9737741e-04, -2.6702362e-04, -2.1092738e-04, -1.3479454e-04, -4.6231068e-05,  4.6015938e-05,  1.3292153e-04,  2.0606520e-04,  2.5844610e-04,  2.8515225e-04,  2.8381995e-04,  2.5484043e-04,  2.0129602e-04,  1.2863466e-04,  4.4116701e-05, -4.3909719e-05, -1.2683260e-04, -1.9661800e-04, -2.4658779e-04, -2.7205784e-04, -2.7077597e-04, -2.4311860e-04, -1.9202934e-04, -1.2270800e-04, -4.2082374e-05,  4.1883224e-05,  1.2097412e-04,  1.8752833e-04,  2.3517823e-04,  2.5945894e-04,  2.5822558e-04,  2.3184031e-04,  1.8311330e-04,  1.1700559e-04,  4.0125023e-05, -3.9933410e-05, -1.1533733e-04, -1.7878265e-04, -2.2420047e-04, -2.4733688e-04, -2.4615022e-04, -2.2098895e-04, -1.7453481e-04, -1.1151908e-04, -3.8241792e-05,  3.8057441e-05,  1.0991405e-04,  1.7036828e-04,  2.1363867e-04,  2.3567423e-04,  2.3453259e-04,  2.1054900e-04,  1.6628163e-04,  1.0624069e-04,  3.6430011e-05, -3.6252665e-05, -1.0469665e-04, -1.6227342e-04, -2.0347803e-04, -2.2445467e-04, -2.2335649e-04, -2.0050597e-04, -1.5834232e-04, -1.0116311e-04, -3.4687183e-05,  3.4516601e-05,  9.9677956e-05,  1.5448699e-04,  1.9370468e-04,  2.1366296e-04,  2.1260676e-04,  1.9084624e-04,  1.5070616e-04,  9.6279495e-05,  3.3010965e-05, -3.2846921e-05, -9.4851266e-05, -1.4699860e-04, -1.8430562e-04, -2.0328476e-04, -2.0226915e-04, -1.8155705e-04, -1.4336310e-04, -9.1583432e-05, -3.1399158e-05,  3.1241439e-05,  9.0210273e-05,  1.3979849e-04,  1.7526863e-04,  1.9330660e-04,  1.9233029e-04,  1.7262640e-04,  1.3630365e-04,  8.7068876e-05,  2.9849692e-05, -2.9698098e-05, -8.5749043e-05, -1.3287747e-04, -1.6658220e-04, -1.8371580e-04, -1.8277756e-04, -1.6404299e-04, -1.2951890e-04, -8.2730133e-05, -2.8360618e-05,  2.8214960e-05,  8.1461983e-05,  1.2622689e-04,  1.5823547e-04,  1.7450040e-04,  1.7359907e-04,  1.5579615e-04,  1.2300043e-04,  7.8561830e-05,  2.6930094e-05, -2.6790194e-05, -7.7343809e-05, -1.1983855e-04, -1.5021820e-04, -1.6564910e-04, -1.6478358e-04, -1.4787580e-04, -1.1674029e-04, -7.4558887e-05, -2.5556379e-05,  2.5422067e-05,  7.3389522e-05,  1.1370472e-04,  1.4252067e-04,  1.5715120e-04,  1.5632046e-04,  1.4027238e-04,  1.1073093e-04,  7.0716488e-05,  2.4237823e-05, -2.4108940e-05, -6.9594386e-05, -1.0781805e-04, -1.3513370e-04, -1.4899656e-04, -1.4819960e-04, -1.3297684e-04, -1.0496522e-04, -6.7030068e-05, -2.2972860e-05,  2.2849253e-05,  6.5953904e-05,  1.0217158e-04,  1.2804853e-04,  1.4117554e-04,  1.4041143e-04,  1.2598058e-04,  9.9436339e-05,  6.3495285e-05,  2.1760002e-05, -2.1641527e-05, -6.2463796e-05, -9.6758681e-05, -1.2125686e-04, -1.3367896e-04, -1.3294681e-04, -1.1927540e-04, -9.4137832e-05, -6.0108005e-05, -2.0597832e-05,  2.0484350e-05,  5.9119989e-05,  9.1573028e-05,  1.1475077e-04,  1.2649809e-04,  1.2579704e-04,  1.1285349e-04,  8.9063525e-05,  5.6864282e-05,  1.9484995e-05, -1.9376375e-05, -5.5918592e-05, -8.6608594e-05, -1.0852269e-04, -1.1962458e-04, -1.1895382e-04, -1.0670739e-04, -8.4207521e-05, -5.3760350e-05, -1.8420201e-05,  1.8316315e-05,  5.2855886e-05,  8.1859609e-05,  1.0256538e-04,  1.1305044e-04,  1.1240919e-04,  1.0082994e-04,  7.9564176e-05,  5.0792599e-05,  1.7402210e-05, -1.7302939e-05, -4.9928308e-05, -7.7320551e-05, -9.6871913e-05, -1.0676802e-04, -1.0615553e-04, -9.5214320e-05, -7.5128079e-05, -4.7957570e-05, -1.6429835e-05,  1.6335062e-05,  4.7132441e-05,  7.2986116e-05,  9.1435633e-05,  1.0076997e-04,  1.0018553e-04,  8.9853938e-05,  7.0894033e-05,  4.5251939e-05,  1.5501935e-05, -1.5411549e-05, -4.4465001e-05, -6.8851209e-05, -8.6250144e-05, -9.5049230e-05, -9.4492144e-05, -8.4742474e-05, -6.6857038e-05, -4.2672508e-05, -1.4617413e-05,  1.4531306e-05,  4.1922823e-05,  6.4910921e-05,  8.1309284e-05,  8.9598996e-05,  8.9068595e-05,  7.9873834e-05,  6.3012274e-05,  4.0216194e-05,  1.3775211e-05, -1.3693278e-05, -3.9502860e-05, -6.1160520e-05, -7.6607109e-05, -8.4412699e-05, -8.3908340e-05, -7.5242136e-05, -5.9355091e-05, -3.7880020e-05, -1.2974305e-05,  1.2896447e-05,  3.7202163e-05,  5.7595430e-05,  7.2137875e-05,  7.9483995e-05,  7.9005054e-05,  7.0841693e-05,  5.5880989e-05,  3.5661109e-05,  1.2213707e-05, -1.2139827e-05, -3.5017883e-05, -5.4211228e-05, -6.7896024e-05, -7.4806741e-05, -7.4352615e-05, -6.6666998e-05, -5.2585613e-05, -3.3556672e-05, -1.1492460e-05,  1.1422464e-05,  3.2947257e-05,  5.1003622e-05,  6.3876166e-05,  7.0374981e-05,  6.9945083e-05,  6.2712712e-05,  4.9464737e-05,  3.1564003e-05,  1.0809635e-05, -1.0743430e-05, -3.0987603e-05, -4.7968449e-05, -6.0073070e-05, -6.6182932e-05, -6.5776693e-05, -5.8973645e-05, -4.6514255e-05, -2.9680475e-05, -1.0164327e-05,  1.0101826e-05,  2.9136315e-05,  4.5101659e-05,  5.6481647e-05,  6.2224968e-05,  6.1841834e-05,  5.5444752e-05,  4.3730172e-05,  2.7903529e-05,  9.5556581e-06, -9.4967731e-06, -2.7390854e-05, -4.2399311e-05, -5.3096941e-05, -5.8495611e-05, -5.8135042e-05, -5.2121114e-05, -4.1108597e-05, -2.6230673e-05, -8.9827713e-06,  8.9274183e-06,  2.5748748e-05,  3.9857559e-05,  4.9914122e-05,  5.4989519e-05,  5.4650987e-05,  4.8997936e-05,  3.8645731e-05,  2.4659473e-05,  8.4448304e-06, -8.3929267e-06, -2.4207580e-05, -3.7472651e-05, -4.6928470e-05, -5.1701471e-05, -5.1384461e-05, -4.6070530e-05, -3.6337864e-05, -2.3187554e-05, -7.9410180e-06,  7.8924829e-06,  2.2764988e-05,  3.5240917e-05,  4.4135371e-05,  4.8626364e-05,  4.8330372e-05,  4.3334311e-05,  3.4181364e-05,  2.1812587e-05,  7.4705344e-06, -7.4252888e-06, -2.1418662e-05, -3.3158763e-05, -4.1530307e-05, -4.5759200e-05, -4.5483731e-05, -4.0784790e-05, -3.2172675e-05, -2.0532296e-05, -7.0325957e-06,  6.9905621e-06,  2.0166335e-05,  3.1222667e-05,  3.9108848e-05,  4.3095079e-05,  4.2839648e-05,  3.8417561e-05,  3.0308309e-05,  1.9344444e-05,  6.6264332e-06, -6.5875354e-06, -1.9005785e-05, -2.9429174e-05, -3.6866648e-05, -4.0629190e-05, -4.0393321e-05, -3.6228303e-05, -2.8584841e-05, -1.8246836e-05, -6.2512917e-06,  6.2154551e-06,  1.7934828e-05,  2.7774889e-05,  3.4799435e-05,  3.8356807e-05,  3.8140032e-05,  3.4212764e-05,  2.6998904e-05,  1.7237314e-05,  5.9064290e-06, -5.8735799e-06, -1.6951316e-05, -2.6256472e-05, -3.2903010e-05, -3.6273282e-05, -3.6075140e-05, -3.2366765e-05, -2.5547185e-05, -1.6313755e-05, -5.5911145e-06,  5.5611804e-06,  1.6053137e-05,  2.4870636e-05,  3.1173235e-05,  3.4374036e-05,  3.4194073e-05,  3.0686189e-05,  2.4226422e-05,  1.5474067e-05,  5.3046285e-06, -5.2775380e-06, -1.5238206e-05, -2.3614142e-05, -2.9606036e-05, -3.2654559e-05, -3.2492326e-05, -2.9166977e-05, -2.3033399e-05, -1.4716188e-05, -5.0462613e-06,  5.0219441e-06,  1.4504472e-05,  2.2483796e-05,  2.8197393e-05,  3.1110399e-05,  3.0965456e-05,  2.7805124e-05,  2.1964942e-05,  1.4038083e-05,  4.8153128e-06, -4.7936993e-06, -1.3849906e-05, -2.1476445e-05, -2.6943338e-05, -2.9737165e-05, -2.9609074e-05, -2.6596679e-05, -2.1017918e-05, -1.3437742e-05, -4.6110915e-06,  4.5921130e-06,  1.3272507e-05,  2.0588974e-05,  2.5839951e-05,  2.8530515e-05,  2.8418847e-05,  2.5537734e-05,  2.0189230e-05,  1.2913181e-05,  4.4329139e-06, -4.4165024e-06, -1.2770296e-05, -1.9818304e-05, -2.4883356e-05, -2.7486159e-05, -2.7390486e-05, -2.4624429e-05, -1.9475817e-05, -1.2462436e-05, -4.2801041e-06,  4.2661926e-06,  1.2341315e-05,  1.9161390e-05,  2.4069722e-05,  2.6599854e-05,  2.6519754e-05,  2.3852940e-05,  1.8874649e-05,  1.2083563e-05,  4.1519934e-06, -4.1405152e-06, -1.1983628e-05, -1.8615219e-05, -2.3395253e-05, -2.5867396e-05, -2.5802451e-05, -2.3219487e-05, -1.8382728e-05, -1.1774639e-05, -4.0479195e-06,  4.0388089e-06,  1.1695316e-05,  1.8176805e-05,  2.2856192e-05,  2.5284625e-05,  2.5234422e-05,  2.2720321e-05,  1.7997083e-05,  1.1533758e-05,  3.9672265e-06, -3.9604181e-06, -1.1474480e-05, -1.7843192e-05, -2.2448817e-05, -2.4847418e-05, -2.4811546e-05, -2.2351731e-05, -1.7714769e-05, -1.1359033e-05, -3.9092642e-06,  3.9046933e-06,  1.1319235e-05,  1.7611449e-05,  2.2169437e-05};
		int32_t numBlock=RECORDING_BUFLEN/NumTaps;
		arm_fir_instance_f32 S;

		arm_fir_init_f32(&S, NumTaps, firCoeffs32, firStateF32, blockSize);
		  for(int i=0; i < numBlock; i++)
		  {
			arm_fir_f32(&S, floatBuffer + (i*blockSize), floatBuffer + (i*blockSize), blockSize);
		  }
		transformBufferToDAC(floatBuffer,RECORDING_BUFLEN, sendingBuffer);



		printf("Sending audio to other board \r\n");

		uint16_t step = RECORDING_BUFLEN/SENDING_BUFLEN;
		for (int i = 0 ; i < step; i++) {
			if(wifi_send_data_to_board(&(sendingBuffer[i*SENDING_BUFLEN])) == WIFI_STATUS_OK) {
				printf("Sent packet %d\r\n", i);
			}
		}
   // }
    buttonPressed = false;
  }
}

/**
 * This function attempts to sent an HTTP request to the other board, which contains some data.
 */
static int wifi_send_data_to_board(uint8_t* data) {
	// first try to connect to the board

    if (WIFI_OpenClientConnection(REMOTE_SOCKET, WIFI_TCP_PROTOCOL, "test", RemoteIP_Addr, REMOTE_PORT, PORT) != WIFI_STATUS_OK) {
    	printf("Could not connect to other board \r\n");
    	return -1;
    }

    printf("Connected to other board\r\n");
	//char* http_header = "HTTP/1.0 200 OK\r\nContent-Type: text/plain\r\n";
    //strcat(http_header, data);

    uint16_t actualSent;
    /*
    for (int i = 0; i < 20; i++) {
    	if (WIFI_SendData(REMOTE_SOCKET, &(data[i*1000]), SENDING_BUFLEN, &actualSent, WIFI_WRITE_TIMEOUT) == WIFI_STATUS_OK) {
			printf("Sent packet %d \r\n", i);
			//memset(data, 0, strlen(data));
			return -1;
    	}
    }
    */
	if (WIFI_SendData(REMOTE_SOCKET,data, SENDING_BUFLEN, &actualSent, WIFI_WRITE_TIMEOUT) != WIFI_STATUS_OK) {
		printf("Could not send data \r\n");
		//memset(data, 0, strlen(data));
		return -1;
	}

    //memset(data, 0, strlen(data)); // maybe we can remove this
    // wait for resp from receiving board before proceeding
    uint8_t resp[100];
    memset(resp, 0, strlen((char*)resp));
    uint16_t actualReceived;

    while(WIFI_ReceiveData(REMOTE_SOCKET, resp, 100, &actualReceived, WIFI_READ_TIMEOUT) != WIFI_STATUS_OK) {

    }
    printf("Received response from receiving board: %s\r\n", resp);

    // close connection

    if (WIFI_CloseClientConnection(REMOTE_SOCKET) != WIFI_STATUS_OK) {
    	printf("Could not close client connection \r\n");
    	return -1;
    }
    printf("Closed client connection \r\n");

    return WIFI_STATUS_OK;
}
/**
 * This function takes care of:
 * - starting the es-wifi module
 * - connecting to a network whose credentials are provided in code
 * - connect to the receiving board using ip address provided in parameters of this function
 * - returns -1 if anything bad happens
 * - returns WIFI_STATUS_OK if successful
 */
static int wifi_connect_to_board(uint8_t ip0, uint8_t ip1, uint8_t ip2, uint8_t ip3) {
	// start wifi module
	wifi_start();


	// connect to existing AP
	if (WIFI_Connect(SSID, PASSWORD, SECURITY) == WIFI_STATUS_OK)
	{
	  if(WIFI_GetIP_Address(IP_Addr, sizeof(IP_Addr)) == WIFI_STATUS_OK)
	  {
		LOG(("eS-WiFi module connected: got IP Address : %d.%d.%d.%d\r\n",
				 IP_Addr[0],
				 IP_Addr[1],
				 IP_Addr[2],
				 IP_Addr[3]));
	  }
	  else
	  {
		LOG((" ERROR : es-wifi module CANNOT get IP address\r\n"));
		return -1;
	  }
	}
	else
	{
	   LOG(("ERROR : es-wifi module NOT connected\r\n"));
	   return -1;
	}
	// start server (?)

	if (WIFI_STATUS_OK != WIFI_StartServer(SOCKET, WIFI_TCP_PROTOCOL, 1, "", PORT)) {
		printf("ERROR: Could not start server \r\n");
		return -1;
	}

	// trying to connect to other board using IP addr
    RemoteIP_Addr[0] = ip0;
    RemoteIP_Addr[1] = ip1;
    RemoteIP_Addr[2] = ip2;
    RemoteIP_Addr[3] = ip3;
    if (WIFI_OpenClientConnection(REMOTE_SOCKET, WIFI_TCP_PROTOCOL, "test", RemoteIP_Addr, REMOTE_PORT, PORT) != WIFI_STATUS_OK) {
    	printf("Could not connect to other board \r\n");
    	return -1;
    }

    // we need to disconnect at the end since we will be reconnecting to send data
    // close connection
    if (WIFI_CloseClientConnection(REMOTE_SOCKET) != WIFI_STATUS_OK) {
    	printf("Could not close client connection \r\n");
    	return -1;
    }

    return WIFI_STATUS_OK;
}

/**
  * @brief  Send HTML page
  * @param  None
  * @retval None
  */


static int wifi_start(void)
{
  uint8_t  MAC_Addr[6];

 /*Initialize and use WIFI module */
  if(WIFI_Init() ==  WIFI_STATUS_OK)
  {
    LOG(("ES-WIFI Initialized.\r\n"));
    if(WIFI_GetMAC_Address(MAC_Addr, sizeof(MAC_Addr)) == WIFI_STATUS_OK)
    {
      LOG(("> eS-WiFi module MAC Address : %02X:%02X:%02X:%02X:%02X:%02X\r\n",
               MAC_Addr[0],
               MAC_Addr[1],
               MAC_Addr[2],
               MAC_Addr[3],
               MAC_Addr[4],
               MAC_Addr[5]));
    }
    else
    {
      LOG(("> ERROR : CANNOT get MAC address\r\n"));
      return -1;
    }
  }
  else
  {
    return -1;
  }
  return 0;
}

/**
 * Transforms a buffer's values into valid DAC 8bit right aligned values
 */
void transformBufferToFloat(int32_t *buffer, uint32_t recording_buffer_length, float32_t *outputBuffer) {
	for (int i = 0; i < recording_buffer_length; i++) {
		outputBuffer[i]=(float)buffer[i];
	}
}
void transformBufferToDAC(float32_t *buffer, uint32_t recording_buffer_length, uint8_t *outputBuffer) {
	// need to map buffer values to 8bit right alligned values (uint8_t)
	// from experimentation (screaming at the board): min values tend to be -3000 and max seems to be ~1000
	const int16_t MAX_VAL = 1200;
	const int16_t MIN_VAL = -1200;
	const float a = (255.0)/(MAX_VAL - MIN_VAL); // slope
	for (int i = 0; i < recording_buffer_length; i++) {
		int32_t val = (int32_t)buffer[i];
		val = val >> 8; // remove this for LOUDER but MORE SCUFFED NOISE
		// clip buffer values to within [-MIN_VAL, MAX_VAL]
		if (val <= MIN_VAL) {
			val = MIN_VAL;
		}
		if (val >= MAX_VAL) {
			val = MAX_VAL;
		}
		// scale values up by [-MIN_VAL] to make sure no negatives
		if (MIN_VAL < 0) {
			val += (-MIN_VAL);
		}
		// now the range of val should be [0, MAX_VAL-MIN_VAL], apply linear function to get DAC val
		val = round(a*val);
		if (val >= 0 && val <= 255) {
			outputBuffer[i] = (uint8_t)val; // change the buffer
		} else {
			Error_Handler(); // should not happen
		}
	}
}

/**
  * @brief  System Clock Configuration
  *         The system Clock is configured as follow :
  *            System Clock source            = PLL (MSI)
  *            SYSCLK(Hz)                     = 80000000
  *            HCLK(Hz)                       = 80000000
  *            AHB Prescaler                  = 1
  *            APB1 Prescaler                 = 1
  *            APB2 Prescaler                 = 1
  *            MSI Frequency(Hz)              = 4000000
  *            PLL_M                          = 1
  *            PLL_N                          = 40
  *            PLL_R                          = 2
  *            PLL_P                          = 7
  *            PLL_Q                          = 4
  *            Flash Latency(WS)              = 4
  * @param  None
  * @retval None
  */
static void SystemClock_Config(void)
{
  RCC_ClkInitTypeDef RCC_ClkInitStruct;
  RCC_OscInitTypeDef RCC_OscInitStruct;

  /* MSI is enabled after System reset, activate PLL with MSI as source */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_MSI;
  RCC_OscInitStruct.MSIState = RCC_MSI_ON;
  RCC_OscInitStruct.MSIClockRange = RCC_MSIRANGE_6;
  RCC_OscInitStruct.MSICalibrationValue = RCC_MSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_MSI;
  RCC_OscInitStruct.PLL.PLLM = 1;
  RCC_OscInitStruct.PLL.PLLN = 40;
  RCC_OscInitStruct.PLL.PLLR = 2;
  RCC_OscInitStruct.PLL.PLLP = 7;
  RCC_OscInitStruct.PLL.PLLQ = 4;
  if(HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    /* Initialization Error */
    while(1);
  }

  /* Select PLL as system clock source and configure the HCLK, PCLK1 and PCLK2
     clocks dividers */
  RCC_ClkInitStruct.ClockType = (RCC_CLOCKTYPE_SYSCLK | RCC_CLOCKTYPE_HCLK | RCC_CLOCKTYPE_PCLK1 | RCC_CLOCKTYPE_PCLK2);
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;
  if(HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_4) != HAL_OK)
  {
    /* Initialization Error */
    while(1);
  }
}
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
/* USER CODE BEGIN MX_GPIO_Init_1 */
/* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();

  /*Configure GPIO pin : PC13 */
  GPIO_InitStruct.Pin = GPIO_PIN_13;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /* EXTI interrupt init*/
  HAL_NVIC_SetPriority(EXTI15_10_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);

/* USER CODE BEGIN MX_GPIO_Init_2 */
/* USER CODE END MX_GPIO_Init_2 */
}

#if defined (TERMINAL_USE)
/**
  * @brief  Retargets the C library printf function to the USART.
  * @param  None
  * @retval None
  */
PUTCHAR_PROTOTYPE
{
  /* Place your implementation of fputc here */
  /* e.g. write a character to the USART1 and Loop until the end of transmission */
  HAL_UART_Transmit(&hDiscoUart, (uint8_t *)&ch, 1, 0xFFFF);

  return ch;
}

#endif /* TERMINAL_USE */

#ifdef USE_FULL_ASSERT

/**
   * @brief Reports the name of the source file and the source line number
   * where the assert_param error has occurred.
   * @param file: pointer to the source file name
   * @param line: assert_param error line source number
   * @retval None
   */
void assert_failed(uint8_t* file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
    ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */

}

#endif

static void MX_DAC1_Init(void)
{

  /* USER CODE BEGIN DAC1_Init 0 */

  /* USER CODE END DAC1_Init 0 */

  DAC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN DAC1_Init 1 */

  /* USER CODE END DAC1_Init 1 */

  /** DAC Initialization
  */
  hdac1.Instance = DAC1;
  if (HAL_DAC_Init(&hdac1) != HAL_OK)
  {
    Error_Handler();
  }

  /** DAC channel OUT1 config
  */
  sConfig.DAC_SampleAndHold = DAC_SAMPLEANDHOLD_DISABLE;
  sConfig.DAC_Trigger = DAC_TRIGGER_T2_TRGO;
  sConfig.DAC_HighFrequency = DAC_HIGH_FREQUENCY_INTERFACE_MODE_ABOVE_80MHZ;
  sConfig.DAC_OutputBuffer = DAC_OUTPUTBUFFER_ENABLE;
  sConfig.DAC_ConnectOnChipPeripheral = DAC_CHIPCONNECT_DISABLE;
  sConfig.DAC_UserTrimming = DAC_TRIMMING_FACTORY;
  if (HAL_DAC_ConfigChannel(&hdac1, &sConfig, DAC_CHANNEL_1) != HAL_OK)
  {
    Error_Handler();
  }

  /** DAC channel OUT2 config
  */
  sConfig.DAC_Trigger = DAC_TRIGGER_NONE;
  if (HAL_DAC_ConfigChannel(&hdac1, &sConfig, DAC_CHANNEL_2) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN DAC1_Init 2 */

  /* USER CODE END DAC1_Init 2 */

}

/**
  * @brief DFSDM1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_DFSDM1_Init(void)
{

  /* USER CODE BEGIN DFSDM1_Init 0 */

  /* USER CODE END DFSDM1_Init 0 */

  /* USER CODE BEGIN DFSDM1_Init 1 */

  /* USER CODE END DFSDM1_Init 1 */
  hdfsdm1_filter0.Instance = DFSDM1_Filter0;
  hdfsdm1_filter0.Init.RegularParam.Trigger = DFSDM_FILTER_SW_TRIGGER;
  hdfsdm1_filter0.Init.RegularParam.FastMode = ENABLE;
  hdfsdm1_filter0.Init.RegularParam.DmaMode = ENABLE;
  hdfsdm1_filter0.Init.FilterParam.SincOrder = DFSDM_FILTER_FASTSINC_ORDER;
  hdfsdm1_filter0.Init.FilterParam.Oversampling = 100;
  hdfsdm1_filter0.Init.FilterParam.IntOversampling = 1;
  if (HAL_DFSDM_FilterInit(&hdfsdm1_filter0) != HAL_OK)
  {
    Error_Handler();
  }
  hdfsdm1_channel2.Instance = DFSDM1_Channel2;
  hdfsdm1_channel2.Init.OutputClock.Activation = ENABLE;
  hdfsdm1_channel2.Init.OutputClock.Selection = DFSDM_CHANNEL_OUTPUT_CLOCK_SYSTEM;
  hdfsdm1_channel2.Init.OutputClock.Divider = 50*SAMPLING_RATE_FACTOR; // CHANGED FROM 50 to 100 so that SAMPLING RATE IS 10K
  hdfsdm1_channel2.Init.Input.Multiplexer = DFSDM_CHANNEL_EXTERNAL_INPUTS;
  hdfsdm1_channel2.Init.Input.DataPacking = DFSDM_CHANNEL_STANDARD_MODE;
  hdfsdm1_channel2.Init.Input.Pins = DFSDM_CHANNEL_SAME_CHANNEL_PINS;
  hdfsdm1_channel2.Init.SerialInterface.Type = DFSDM_CHANNEL_SPI_RISING;
  hdfsdm1_channel2.Init.SerialInterface.SpiClock = DFSDM_CHANNEL_SPI_CLOCK_INTERNAL;
  hdfsdm1_channel2.Init.Awd.FilterOrder = DFSDM_CHANNEL_FASTSINC_ORDER;
  hdfsdm1_channel2.Init.Awd.Oversampling = 1;
  hdfsdm1_channel2.Init.Offset = 0;
  hdfsdm1_channel2.Init.RightBitShift = 0x00;
  if (HAL_DFSDM_ChannelInit(&hdfsdm1_channel2) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_DFSDM_FilterConfigRegChannel(&hdfsdm1_filter0, DFSDM_CHANNEL_2, DFSDM_CONTINUOUS_CONV_ON) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN DFSDM1_Init 2 */

  /* USER CODE END DFSDM1_Init 2 */

}

/**
  * @brief TIM2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM2_Init(void)
{

  /* USER CODE BEGIN TIM2_Init 0 */

  /* USER CODE END TIM2_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM2_Init 1 */

  /* USER CODE END TIM2_Init 1 */
  htim2.Instance = TIM2;
  htim2.Init.Prescaler = 0;
  htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim2.Init.Period = 5000*SAMPLING_RATE_FACTOR;
  htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim2, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_UPDATE;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim2, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM2_Init 2 */

  /* USER CODE END TIM2_Init 2 */

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMAMUX1_CLK_ENABLE();
  __HAL_RCC_DMA1_CLK_ENABLE();

  /* DMA interrupt init */
  /* DMA1_Channel1_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel1_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel1_IRQn);
  /* DMA1_Channel2_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel2_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel2_IRQn);

}

/**
  * @brief  EXTI line detection callback.
  * @param  GPIO_Pin: Specifies the port pin connected to corresponding EXTI line.
  * @retval None
  */

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
  switch (GPIO_Pin)
  {
  case (GPIO_PIN_1):
    {
      SPI_WIFI_ISR();
      break;
    }
  case (GPIO_PIN_13):
     {
      buttonPressed=1;
        break;
     }
    default:
    {
      break;
    }
  }
}
/*
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin){
	if(GPIO_Pin==GPIO_PIN_1){
	    SPI_WIFI_ISR();
	}
	else if (GPIO_Pin==USER_BUTTON_PIN)
    {
     buttonPressed=true;
    }
}*/

void HAL_DFSDM_FilterRegConvCpltCallback(DFSDM_Filter_HandleTypeDef *hdfsdm_filter) {
	DFSDM_finished = true;
}

void HAL_DFSDM_FilterRegConvHalfCpltCallback (DFSDM_Filter_HandleTypeDef * hdfsdm_filter) {
	DFSDM_half_finished = true;
}
/**
  * @brief  SPI3 line detection callback.
  * @param  None
  * @retval None
  */
void SPI3_IRQHandler(void)
{
  HAL_SPI_IRQHandler(&hspi);
}

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}
#endif




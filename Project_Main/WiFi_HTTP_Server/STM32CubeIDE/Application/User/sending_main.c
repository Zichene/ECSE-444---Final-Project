/**
  ******************************************************************************
  * @file    Wifi/WiFi_HTTP_Server/src/main.c
  * @author  MCD Application Team
  * @brief   This file provides main program functions
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2017 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
//#define SENDING_ACTIVE // Comment/Uncomment this depending on if you are this board as sending/receiving
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include <math.h>
#include "sending_board_config.h"
#define ARM_MATH_CM4
#include "arm_math.h"

#ifdef SENDING_ACTIVE
/* Private defines -----------------------------------------------------------*/
#define PORT           10 // PORT of this board [sending board]
#define REMOTE_PORT    80 // PORT Of the receiving board
#define REMOTE_SOCKET	0 // SOCKET of the receiving board
#define TERMINAL_USE

#define WIFI_WRITE_TIMEOUT 10000
#define WIFI_READ_TIMEOUT  10000
#define SOCKET                 1
#define SENDING_BUFLEN 1000
#define RECORDING_BUFLEN 40000
#define SAMPLING_RATE_FACTOR 2 // DEFAULT SAMPLING IS AT 20 kHz, a higher factor means a lower sampling rate


#ifdef  TERMINAL_USE
#define LOG(a) printf a
#else
#define LOG(a)
#endif

/* Private typedef------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
DAC_HandleTypeDef hdac1;
DMA_HandleTypeDef hdma_dac1_ch1;
DFSDM_Filter_HandleTypeDef hdfsdm1_filter0;
DFSDM_Channel_HandleTypeDef hdfsdm1_channel2;
DMA_HandleTypeDef hdma_dfsdm1_flt0;
TIM_HandleTypeDef htim2;
#if defined (TERMINAL_USE)
extern UART_HandleTypeDef hDiscoUart;
#endif /* TERMINAL_USE */

volatile uint8_t mode=0;

//static  uint8_t http[1024];
static  uint8_t  IP_Addr[4];
static uint8_t RemoteIP_Addr[4]; // address of receiving board
static int32_t recordingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static uint32_t testingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static float32_t floatBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime
static uint8_t sendingBuffer[RECORDING_BUFLEN]; // sampling rate @ 20 kHz => 2 second of recording and 1 second of space for chime

/** INTERRUPT FLAGS **/
volatile uint8_t DFSDM_half_finished=false;
volatile uint8_t DFSDM_finished=false;
volatile uint8_t buttonPressed=0;



/* Private function prototypes -----------------------------------------------*/
#if defined (TERMINAL_USE)
#ifdef __GNUC__
/* With GCC, small printf (option LD Linker->Libraries->Small printf
   set to 'Yes') calls __io_putchar() */
#define PUTCHAR_PROTOTYPE int __io_putchar(int ch)
#else
#define PUTCHAR_PROTOTYPE int fputc(int ch, FILE *f)
#endif /* __GNUC__ */
#endif /* TERMINAL_USE */

static void SystemClock_Config(void);
static int wifi_start(void);
static int wifi_connect_to_board(uint8_t ip0, uint8_t ip1, uint8_t ip2, uint8_t ip3);
static int wifi_send_data_to_board(uint8_t* data);

/* MX Inits */
static void MX_DMA_Init(void);
static void MX_DAC1_Init(void);
static void MX_TIM2_Init(void);
static void MX_DFSDM1_Init(void);
static void MX_GPIO_Init(void);

/* Private functions ---------------------------------------------------------*/
void transformBufferToDAC(float32_t *buffer, uint32_t recording_buffer_length, uint8_t *outputBuffer);
void transformBufferToFloat(int32_t *buffer, uint32_t recording_buffer_length, float32_t *outputBuffer);

/**
  * @brief  Main program
  * @param  None
  * @retval None
  */
int main(void)
{
  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* Configure the system clock */
  SystemClock_Config();

  /* Configure LED2 */
  BSP_LED_Init(LED2);

  /* Initialize all configured peripherals */
  MX_DMA_Init();
  MX_DAC1_Init();
  MX_TIM2_Init();
  MX_DFSDM1_Init();
  MX_GPIO_Init();


  //HAL_DAC_Start(&hdac1, DAC_CHANNEL_1);
  HAL_TIM_Base_Start_IT(&htim2); // the _IT at the end of fn. means interrupt

  /* WIFI Web Server demonstration */
#if defined (TERMINAL_USE)
  /* Initialize all configured peripherals */
  hDiscoUart.Instance = DISCOVERY_COM1;
  hDiscoUart.Init.BaudRate = 115200;
  hDiscoUart.Init.WordLength = UART_WORDLENGTH_8B;
  hDiscoUart.Init.StopBits = UART_STOPBITS_1;
  hDiscoUart.Init.Parity = UART_PARITY_NONE;
  hDiscoUart.Init.Mode = UART_MODE_TX_RX;
  hDiscoUart.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  hDiscoUart.Init.OverSampling = UART_OVERSAMPLING_16;
  hDiscoUart.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  hDiscoUart.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;


  BSP_COM_Init(COM1, &hDiscoUart);

  /* resetting buffers */
  memset(recordingBuffer, 0, RECORDING_BUFLEN*sizeof(int32_t));
  memset(sendingBuffer, 0, SENDING_BUFLEN);

  printf("****** SENDING BOARD Initiating ****** \r\n");

#endif /* TERMINAL_USE */


	/*
	for (int i=0; i<RECORDING_BUFLEN;i++){
		printf("%d ", testingBuffer[i]);
	}
	*/
	//arm_rfft_fast_instance_f32 S;
	//arm_rfft_fast_init_f32(S, 1024);




	while(wifi_connect_to_board(REMOTE_IP_0, REMOTE_IP_1, REMOTE_IP_2, REMOTE_IP_3) != WIFI_STATUS_OK) {
		printf("Retrying to connect to board ... \r\n");
	}
	// successfully connected to board
	printf("Connected to other board. \r\n");
	//wifi_send_data_to_board("test");

    while (true) {
    	  printf("Waiting for button press to send mic data.\r\n");
    buttonPressed=false;
	  while(buttonPressed==false){
		__WFI(); // Waiting for interrupt mode?
	  }
	  buttonPressed=false;
		if (HAL_DFSDM_FilterRegularStart_DMA(&hdfsdm1_filter0, recordingBuffer, RECORDING_BUFLEN) != HAL_OK) {
		  printf("Failed to start DFSDM\r\n");
		}
		while (!DFSDM_finished) {
		}
		DFSDM_finished = false;
		HAL_DFSDM_FilterRegularStop_DMA(&hdfsdm1_filter0);

		transformBufferToFloat(recordingBuffer, RECORDING_BUFLEN, floatBuffer);
		/** Filter setup**/
		int32_t NumTaps=1984;
		int32_t blockSize=32;
		float32_t firStateF32[2*blockSize+NumTaps-1];
		float32_t firCoeffs32[1984]={-1.36568E-06, -1.52775E-06, -1.6902E-06, -1.85304E-06, -2.0163E-06, -2.18001E-06, -2.34418E-06, -2.50884E-06, -2.674E-06, -2.83971E-06, -3.00597E-06, -3.1728E-06, -3.34024E-06, -3.50831E-06, -3.67703E-06, -3.84642E-06, -4.0165E-06, -4.18731E-06, -4.35885E-06, -4.53116E-06, -4.70426E-06, -4.87817E-06, -5.05292E-06, -5.22853E-06, -5.40501E-06, -5.58241E-06, -5.76073E-06, -5.94E-06, -6.12024E-06, -6.30149E-06, -6.48375E-06, -6.66706E-06, -6.85144E-06, -7.0369E-06, -7.22348E-06, -7.4112E-06, -7.60007E-06, -7.79012E-06, -7.98138E-06, -8.17387E-06, -8.36761E-06, -8.56261E-06, -8.75892E-06, -8.95654E-06, -9.1555E-06, -9.35582E-06, -9.55752E-06, -9.76063E-06, -9.96517E-06, -1.01712E-05, -1.03786E-05, -1.05876E-05, -1.0798E-05, -1.101E-05, -1.12236E-05, -1.14387E-05, -1.16555E-05, -1.18738E-05, -1.20938E-05, -1.23154E-05, -1.25388E-05, -1.27638E-05, -1.29906E-05, -1.32191E-05, -1.34493E-05, -1.36814E-05, -1.39152E-05, -1.41509E-05, -1.43883E-05, -1.46277E-05, -1.48689E-05, -1.5112E-05, -1.53571E-05, -1.5604E-05, -1.58529E-05, -1.61038E-05, -1.63567E-05, -1.66115E-05, -1.68684E-05, -1.71273E-05, -1.73883E-05, -1.76513E-05, -1.79164E-05, -1.81836E-05, -1.84529E-05, -1.87244E-05, -1.89979E-05, -1.92737E-05, -1.95516E-05, -1.98317E-05, -2.0114E-05, -2.03986E-05, -2.06853E-05, -2.09743E-05, -2.12656E-05, -2.15591E-05, -2.18549E-05, -2.2153E-05, -2.24533E-05, -2.27561E-05, -2.30611E-05, -2.33684E-05, -2.36782E-05, -2.39902E-05, -2.43047E-05, -2.46215E-05, -2.49407E-05, -2.52623E-05, -2.55862E-05, -2.59126E-05, -2.62415E-05, -2.65727E-05, -2.69064E-05, -2.72425E-05, -2.75811E-05, -2.79221E-05, -2.82655E-05, -2.86115E-05, -2.89599E-05, -2.93108E-05, -2.96641E-05, -3.00199E-05, -3.03782E-05, -3.0739E-05, -3.11023E-05, -3.14681E-05, -3.18364E-05, -3.22071E-05, -3.25804E-05, -3.29561E-05, -3.33344E-05, -3.37151E-05, -3.40984E-05, -3.44841E-05, -3.48723E-05, -3.52631E-05, -3.56563E-05, -3.60519E-05, -3.64501E-05, -3.68508E-05, -3.72539E-05, -3.76595E-05, -3.80675E-05, -3.84781E-05, -3.8891E-05, -3.93064E-05, -3.97243E-05, -4.01446E-05, -4.05673E-05, -4.09925E-05, -4.142E-05, -4.18499E-05, -4.22823E-05, -4.2717E-05, -4.31541E-05, -4.35935E-05, -4.40353E-05, -4.44794E-05, -4.49259E-05, -4.53746E-05, -4.58257E-05, -4.6279E-05, -4.67346E-05, -4.71924E-05, -4.76525E-05, -4.81148E-05, -4.85794E-05, -4.90461E-05, -4.95149E-05, -4.9986E-05, -5.04591E-05, -5.09344E-05, -5.14118E-05, -5.18912E-05, -5.23727E-05, -5.28563E-05, -5.33418E-05, -5.38294E-05, -5.43189E-05, -5.48103E-05, -5.53037E-05, -5.5799E-05, -5.62962E-05, -5.67952E-05, -5.7296E-05, -5.77986E-05, -5.8303E-05, -5.88091E-05, -5.9317E-05, -5.98265E-05, -6.03377E-05, -6.08505E-05, -6.13649E-05, -6.18809E-05, -6.23984E-05, -6.29175E-05, -6.3438E-05, -6.39599E-05, -6.44832E-05, -6.5008E-05, -6.5534E-05, -6.60614E-05, -6.659E-05, -6.71199E-05, -6.76509E-05, -6.81831E-05, -6.87165E-05, -6.92509E-05, -6.97864E-05, -7.03229E-05, -7.08603E-05, -7.13987E-05, -7.19379E-05, -7.2478E-05, -7.30189E-05, -7.35606E-05, -7.4103E-05, -7.4646E-05, -7.51897E-05, -7.5734E-05, -7.62788E-05, -7.68241E-05, -7.73698E-05, -7.7916E-05, -7.84625E-05, -7.90093E-05, -7.95564E-05, -8.01037E-05, -8.06511E-05, -8.11987E-05, -8.17463E-05, -8.22939E-05, -8.28415E-05, -8.33889E-05, -8.39363E-05, -8.44834E-05, -8.50303E-05, -8.55769E-05, -8.61231E-05, -8.66688E-05, -8.72142E-05, -8.77589E-05, -8.83031E-05, -8.88467E-05, -8.93895E-05, -8.99316E-05, -9.04729E-05, -9.10133E-05, -9.15527E-05, -9.20912E-05, -9.26286E-05, -9.31648E-05, -9.36999E-05, -9.42337E-05, -9.47663E-05, -9.52974E-05, -9.58271E-05, -9.63554E-05, -9.6882E-05, -9.7407E-05, -9.79304E-05, -9.84519E-05, -9.89717E-05, -9.94895E-05, -0.000100005, -0.000100519, -0.000101031, -0.000101541, -0.000102048, -0.000102553, -0.000103056, -0.000103556, -0.000104053, -0.000104549, -0.000105041, -0.000105531, -0.000106017, -0.000106501, -0.000106982, -0.00010746, -0.000107935, -0.000108407, -0.000108875, -0.00010934, -0.000109802, -0.00011026, -0.000110715, -0.000111166, -0.000111613, -0.000112057, -0.000112496, -0.000112932, -0.000113363, -0.000113791, -0.000114214, -0.000114633, -0.000115048, -0.000115458, -0.000115863, -0.000116264, -0.000116661, -0.000117052, -0.000117439, -0.000117821, -0.000118198, -0.000118569, -0.000118936, -0.000119297, -0.000119653, -0.000120003, -0.000120348, -0.000120687, -0.00012102, -0.000121348, -0.00012167, -0.000121986, -0.000122296, -0.000122599, -0.000122897, -0.000123188, -0.000123472, -0.000123751, -0.000124022, -0.000124287, -0.000124545, -0.000124797, -0.000125041, -0.000125278, -0.000125509, -0.000125731, -0.000125947, -0.000126155, -0.000126356, -0.000126549, -0.000126735, -0.000126913, -0.000127083, -0.000127245, -0.000127399, -0.000127544, -0.000127682, -0.000127811, -0.000127932, -0.000128044, -0.000128148, -0.000128243, -0.000128329, -0.000128407, -0.000128475, -0.000128535, -0.000128585, -0.000128626, -0.000128657, -0.00012868, -0.000128692, -0.000128695, -0.000128688, -0.000128672, -0.000128645, -0.000128609, -0.000128562, -0.000128506, -0.000128439, -0.000128361, -0.000128273, -0.000128175, -0.000128066, -0.000127946, -0.000127815, -0.000127674, -0.000127521, -0.000127357, -0.000127182, -0.000126996, -0.000126798, -0.000126588, -0.000126368, -0.000126135, -0.000125891, -0.000125634, -0.000125366, -0.000125086, -0.000124793, -0.000124488, -0.000124171, -0.000123842, -0.0001235, -0.000123145, -0.000122778, -0.000122397, -0.000122004, -0.000121598, -0.000121179, -0.000120746, -0.000120301, -0.000119842, -0.000119369, -0.000118883, -0.000118384, -0.00011787, -0.000117343, -0.000116802, -0.000116247, -0.000115678, -0.000115094, -0.000114497, -0.000113885, -0.000113259, -0.000112618, -0.000111962, -0.000111292, -0.000110607, -0.000109907, -0.000109193, -0.000108463, -0.000107718, -0.000106958, -0.000106182, -0.000105392, -0.000104585, -0.000103764, -0.000102926, -0.000102073, -0.000101204, -0.000100319, -9.94187E-05, -9.85019E-05, -9.7569E-05, -9.66199E-05, -9.56546E-05, -9.46729E-05, -9.36747E-05, -9.266E-05, -9.16288E-05, -9.05809E-05, -8.95162E-05, -8.84347E-05, -8.73364E-05, -8.6221E-05, -8.50886E-05, -8.39391E-05, -8.27724E-05, -8.15884E-05, -8.03871E-05, -7.91684E-05, -7.79322E-05, -7.66784E-05, -7.5407E-05, -7.4118E-05, -7.28111E-05, -7.14865E-05, -7.01439E-05, -6.87833E-05, -6.74048E-05, -6.60081E-05, -6.45932E-05, -6.31601E-05, -6.17088E-05, -6.0239E-05, -5.87509E-05, -5.72442E-05, -5.5719E-05, -5.41752E-05, -5.26128E-05, -5.10316E-05, -4.94316E-05, -4.78128E-05, -4.6175E-05, -4.45183E-05, -4.28426E-05, -4.11478E-05, -3.94339E-05, -3.77008E-05, -3.59485E-05, -3.41769E-05, -3.23859E-05, -3.05755E-05, -2.87458E-05, -2.68965E-05, -2.50277E-05, -2.31392E-05, -2.12312E-05, -1.93035E-05, -1.7356E-05, -1.53888E-05, -1.34017E-05, -1.13948E-05, -9.36802E-06, -7.32127E-06, -5.25454E-06, -3.16777E-06, -1.06095E-06, 1.06598E-06, 3.21305E-06, 5.38029E-06, 7.56775E-06, 9.77546E-06, 1.20034E-05, 1.42517E-05, 1.65204E-05, 1.88094E-05, 2.11189E-05, 2.34487E-05, 2.57991E-05, 2.81699E-05, 3.05613E-05, 3.29732E-05, 3.54057E-05, 3.78587E-05, 4.03324E-05, 4.28268E-05, 4.53418E-05, 4.78775E-05, 5.04339E-05, 5.3011E-05, 5.56088E-05, 5.82275E-05, 6.08669E-05, 6.3527E-05, 6.6208E-05, 6.89098E-05, 7.16324E-05, 7.43759E-05, 7.71402E-05, 7.99253E-05, 8.27313E-05, 8.55582E-05, 8.8406E-05, 9.12746E-05, 9.41642E-05, 9.70746E-05, 0.000100006, 0.000102958, 0.000105931, 0.000108925, 0.00011194, 0.000114976, 0.000118032, 0.00012111, 0.000124208, 0.000127327, 0.000130468, 0.000133628, 0.00013681, 0.000140013, 0.000143236, 0.00014648, 0.000149745, 0.000153031, 0.000156337, 0.000159664, 0.000163012, 0.000166381, 0.00016977, 0.00017318, 0.00017661, 0.000180061, 0.000183533, 0.000187025, 0.000190538, 0.000194071, 0.000197625, 0.000201199, 0.000204793, 0.000208408, 0.000212043, 0.000215699, 0.000219374, 0.00022307, 0.000226786, 0.000230522, 0.000234279, 0.000238055, 0.000241851, 0.000245668, 0.000249504, 0.00025336, 0.000257236, 0.000261131, 0.000265047, 0.000268982, 0.000272937, 0.000276911, 0.000280905, 0.000284918, 0.000288951, 0.000293003, 0.000297074, 0.000301164, 0.000305274, 0.000309403, 0.000313551, 0.000317717, 0.000321903, 0.000326107, 0.000330331, 0.000334573, 0.000338833, 0.000343113, 0.00034741, 0.000351726, 0.000356061, 0.000360413, 0.000364784, 0.000369173, 0.00037358, 0.000378005, 0.000382448, 0.000386909, 0.000391387, 0.000395883, 0.000400397, 0.000404927, 0.000409476, 0.000414041, 0.000418624, 0.000423224, 0.000427841, 0.000432475, 0.000437125, 0.000441792, 0.000446476, 0.000451177, 0.000455894, 0.000460627, 0.000465376, 0.000470142, 0.000474923, 0.000479721, 0.000484534, 0.000489363, 0.000494207, 0.000499067, 0.000503943, 0.000508833, 0.000513739, 0.00051866, 0.000523596, 0.000528547, 0.000533512, 0.000538492, 0.000543486, 0.000548495, 0.000553518, 0.000558555, 0.000563606, 0.000568671, 0.00057375, 0.000578842, 0.000583948, 0.000589067, 0.000594199, 0.000599345, 0.000604503, 0.000609674, 0.000614858, 0.000620055, 0.000625264, 0.000630486, 0.000635719, 0.000640965, 0.000646222, 0.000651492, 0.000656773, 0.000662065, 0.000667369, 0.000672684, 0.00067801, 0.000683347, 0.000688695, 0.000694053, 0.000699422, 0.000704802, 0.000710191, 0.000715591, 0.000721, 0.000726419, 0.000731848, 0.000737286, 0.000742734, 0.000748191, 0.000753656, 0.000759131, 0.000764614, 0.000770106, 0.000775606, 0.000781114, 0.00078663, 0.000792154, 0.000797686, 0.000803226, 0.000808773, 0.000814327, 0.000819888, 0.000825456, 0.000831031, 0.000836613, 0.000842201, 0.000847795, 0.000853395, 0.000859001, 0.000864613, 0.00087023, 0.000875853, 0.000881481, 0.000887114, 0.000892752, 0.000898395, 0.000904042, 0.000909694, 0.00091535, 0.00092101, 0.000926673, 0.000932341, 0.000938012, 0.000943686, 0.000949363, 0.000955043, 0.000960726, 0.000966412, 0.0009721, 0.00097779, 0.000983482, 0.000989177, 0.000994872, 0.00100057, 0.001006268, 0.001011968, 0.001017669, 0.00102337, 0.001029072, 0.001034775, 0.001040478, 0.00104618, 0.001051883, 0.001057585, 0.001063287, 0.001068987, 0.001074687, 0.001080386, 0.001086084, 0.00109178, 0.001097474, 0.001103167, 0.001108857, 0.001114546, 0.001120231, 0.001125915, 0.001131595, 0.001137272, 0.001142946, 0.001148617, 0.001154284, 0.001159947, 0.001165607, 0.001171262, 0.001176913, 0.001182559, 0.001188201, 0.001193837, 0.001199468, 0.001205095, 0.001210715, 0.00121633, 0.001221939, 0.001227541, 0.001233138, 0.001238728, 0.001244311, 0.001249887, 0.001255457, 0.001261018, 0.001266573, 0.00127212, 0.001277659, 0.001283189, 0.001288712, 0.001294226, 0.001299731, 0.001305228, 0.001310715, 0.001316194, 0.001321662, 0.001327121, 0.001332571, 0.00133801, 0.001343439, 0.001348858, 0.001354266, 0.001359663, 0.001365049, 0.001370424, 0.001375788, 0.00138114, 0.00138648, 0.001391808, 0.001397124, 0.001402428, 0.001407719, 0.001412997, 0.001418262, 0.001423515, 0.001428754, 0.001433979, 0.001439191, 0.001444388, 0.001449572, 0.001454741, 0.001459896, 0.001465036, 0.001470162, 0.001475272, 0.001480367, 0.001485446, 0.00149051, 0.001495558, 0.001500591, 0.001505606, 0.001510606, 0.001515589, 0.001520555, 0.001525504, 0.001530437, 0.001535351, 0.001540249, 0.001545128, 0.00154999, 0.001554834, 0.00155966, 0.001564467, 0.001569255, 0.001574025, 0.001578776, 0.001583507, 0.00158822, 0.001592913, 0.001597586, 0.001602239, 0.001606872, 0.001611485, 0.001616078, 0.00162065, 0.001625202, 0.001629732, 0.001634241, 0.00163873, 0.001643196, 0.001647641, 0.001652065, 0.001656466, 0.001660846, 0.001665203, 0.001669537, 0.001673849, 0.001678138, 0.001682405, 0.001686648, 0.001690868, 0.001695064, 0.001699237, 0.001703386, 0.001707511, 0.001711612, 0.001715689, 0.001719741, 0.001723769, 0.001727772, 0.00173175, 0.001735704, 0.001739632, 0.001743534, 0.001747411, 0.001751263, 0.001755089, 0.001758889, 0.001762662, 0.00176641, 0.001770131, 0.001773825, 0.001777493, 0.001781134, 0.001784749, 0.001788336, 0.001791895, 0.001795428, 0.001798932, 0.00180241, 0.001805859, 0.00180928, 0.001812674, 0.001816039, 0.001819375, 0.001822684, 0.001825963, 0.001829214, 0.001832436, 0.00183563, 0.001838793, 0.001841928, 0.001845034, 0.001848109, 0.001851156, 0.001854172, 0.001857159, 0.001860115, 0.001863042, 0.001865938, 0.001868804, 0.00187164, 0.001874445, 0.001877219, 0.001879963, 0.001882675, 0.001885357, 0.001888007, 0.001890627, 0.001893215, 0.001895771, 0.001898297, 0.00190079, 0.001903252, 0.001905682, 0.00190808, 0.001910446, 0.00191278, 0.001915081, 0.001917351, 0.001919588, 0.001921792, 0.001923964, 0.001926103, 0.00192821, 0.001930283, 0.001932324, 0.001934332, 0.001936307, 0.001938248, 0.001940157, 0.001942032, 0.001943873, 0.001945682, 0.001947456, 0.001949197, 0.001950905, 0.001952578, 0.001954218, 0.001955824, 0.001957396, 0.001958934, 0.001960438, 0.001961908, 0.001963344, 0.001964745, 0.001966112, 0.001967445, 0.001968743, 0.001970007, 0.001971236, 0.001972431, 0.001973591, 0.001974717, 0.001975808, 0.001976864, 0.001977885, 0.001978871, 0.001979823, 0.00198074, 0.001981621, 0.001982468, 0.00198328, 0.001984056, 0.001984798, 0.001985504, 0.001986176, 0.001986812, 0.001987413, 0.001987978, 0.001988509, 0.001989004, 0.001989464, 0.001989888, 0.001990278, 0.001990632, 0.00199095, 0.001991233, 0.001991481, 0.001991694, 0.001991871, 0.001992012, 0.001992119, 0.001992189, 0.001992225, 0.001992225, 0.001992189, 0.001992119, 0.001992012, 0.001991871, 0.001991694, 0.001991481, 0.001991233, 0.00199095, 0.001990632, 0.001990278, 0.001989888, 0.001989464, 0.001989004, 0.001988509, 0.001987978, 0.001987413, 0.001986812, 0.001986176, 0.001985504, 0.001984798, 0.001984056, 0.00198328, 0.001982468, 0.001981621, 0.00198074, 0.001979823, 0.001978871, 0.001977885, 0.001976864, 0.001975808, 0.001974717, 0.001973591, 0.001972431, 0.001971236, 0.001970007, 0.001968743, 0.001967445, 0.001966112, 0.001964745, 0.001963344, 0.001961908, 0.001960438, 0.001958934, 0.001957396, 0.001955824, 0.001954218, 0.001952578, 0.001950905, 0.001949197, 0.001947456, 0.001945682, 0.001943873, 0.001942032, 0.001940157, 0.001938248, 0.001936307, 0.001934332, 0.001932324, 0.001930283, 0.00192821, 0.001926103, 0.001923964, 0.001921792, 0.001919588, 0.001917351, 0.001915081, 0.00191278, 0.001910446, 0.00190808, 0.001905682, 0.001903252, 0.00190079, 0.001898297, 0.001895771, 0.001893215, 0.001890627, 0.001888007, 0.001885357, 0.001882675, 0.001879963, 0.001877219, 0.001874445, 0.00187164, 0.001868804, 0.001865938, 0.001863042, 0.001860115, 0.001857159, 0.001854172, 0.001851156, 0.001848109, 0.001845034, 0.001841928, 0.001838793, 0.00183563, 0.001832436, 0.001829214, 0.001825963, 0.001822684, 0.001819375, 0.001816039, 0.001812674, 0.00180928, 0.001805859, 0.00180241, 0.001798932, 0.001795428, 0.001791895, 0.001788336, 0.001784749, 0.001781134, 0.001777493, 0.001773825, 0.001770131, 0.00176641, 0.001762662, 0.001758889, 0.001755089, 0.001751263, 0.001747411, 0.001743534, 0.001739632, 0.001735704, 0.00173175, 0.001727772, 0.001723769, 0.001719741, 0.001715689, 0.001711612, 0.001707511, 0.001703386, 0.001699237, 0.001695064, 0.001690868, 0.001686648, 0.001682405, 0.001678138, 0.001673849, 0.001669537, 0.001665203, 0.001660846, 0.001656466, 0.001652065, 0.001647641, 0.001643196, 0.00163873, 0.001634241, 0.001629732, 0.001625202, 0.00162065, 0.001616078, 0.001611485, 0.001606872, 0.001602239, 0.001597586, 0.001592913, 0.00158822, 0.001583507, 0.001578776, 0.001574025, 0.001569255, 0.001564467, 0.00155966, 0.001554834, 0.00154999, 0.001545128, 0.001540249, 0.001535351, 0.001530437, 0.001525504, 0.001520555, 0.001515589, 0.001510606, 0.001505606, 0.001500591, 0.001495558, 0.00149051, 0.001485446, 0.001480367, 0.001475272, 0.001470162, 0.001465036, 0.001459896, 0.001454741, 0.001449572, 0.001444388, 0.001439191, 0.001433979, 0.001428754, 0.001423515, 0.001418262, 0.001412997, 0.001407719, 0.001402428, 0.001397124, 0.001391808, 0.00138648, 0.00138114, 0.001375788, 0.001370424, 0.001365049, 0.001359663, 0.001354266, 0.001348858, 0.001343439, 0.00133801, 0.001332571, 0.001327121, 0.001321662, 0.001316194, 0.001310715, 0.001305228, 0.001299731, 0.001294226, 0.001288712, 0.001283189, 0.001277659, 0.00127212, 0.001266573, 0.001261018, 0.001255457, 0.001249887, 0.001244311, 0.001238728, 0.001233138, 0.001227541, 0.001221939, 0.00121633, 0.001210715, 0.001205095, 0.001199468, 0.001193837, 0.001188201, 0.001182559, 0.001176913, 0.001171262, 0.001165607, 0.001159947, 0.001154284, 0.001148617, 0.001142946, 0.001137272, 0.001131595, 0.001125915, 0.001120231, 0.001114546, 0.001108857, 0.001103167, 0.001097474, 0.00109178, 0.001086084, 0.001080386, 0.001074687, 0.001068987, 0.001063287, 0.001057585, 0.001051883, 0.00104618, 0.001040478, 0.001034775, 0.001029072, 0.00102337, 0.001017669, 0.001011968, 0.001006268, 0.00100057, 0.000994872, 0.000989177, 0.000983482, 0.00097779, 0.0009721, 0.000966412, 0.000960726, 0.000955043, 0.000949363, 0.000943686, 0.000938012, 0.000932341, 0.000926673, 0.00092101, 0.00091535, 0.000909694, 0.000904042, 0.000898395, 0.000892752, 0.000887114, 0.000881481, 0.000875853, 0.00087023, 0.000864613, 0.000859001, 0.000853395, 0.000847795, 0.000842201, 0.000836613, 0.000831031, 0.000825456, 0.000819888, 0.000814327, 0.000808773, 0.000803226, 0.000797686, 0.000792154, 0.00078663, 0.000781114, 0.000775606, 0.000770106, 0.000764614, 0.000759131, 0.000753656, 0.000748191, 0.000742734, 0.000737286, 0.000731848, 0.000726419, 0.000721, 0.000715591, 0.000710191, 0.000704802, 0.000699422, 0.000694053, 0.000688695, 0.000683347, 0.00067801, 0.000672684, 0.000667369, 0.000662065, 0.000656773, 0.000651492, 0.000646222, 0.000640965, 0.000635719, 0.000630486, 0.000625264, 0.000620055, 0.000614858, 0.000609674, 0.000604503, 0.000599345, 0.000594199, 0.000589067, 0.000583948, 0.000578842, 0.00057375, 0.000568671, 0.000563606, 0.000558555, 0.000553518, 0.000548495, 0.000543486, 0.000538492, 0.000533512, 0.000528547, 0.000523596, 0.00051866, 0.000513739, 0.000508833, 0.000503943, 0.000499067, 0.000494207, 0.000489363, 0.000484534, 0.000479721, 0.000474923, 0.000470142, 0.000465376, 0.000460627, 0.000455894, 0.000451177, 0.000446476, 0.000441792, 0.000437125, 0.000432475, 0.000427841, 0.000423224, 0.000418624, 0.000414041, 0.000409476, 0.000404927, 0.000400397, 0.000395883, 0.000391387, 0.000386909, 0.000382448, 0.000378005, 0.00037358, 0.000369173, 0.000364784, 0.000360413, 0.000356061, 0.000351726, 0.00034741, 0.000343113, 0.000338833, 0.000334573, 0.000330331, 0.000326107, 0.000321903, 0.000317717, 0.000313551, 0.000309403, 0.000305274, 0.000301164, 0.000297074, 0.000293003, 0.000288951, 0.000284918, 0.000280905, 0.000276911, 0.000272937, 0.000268982, 0.000265047, 0.000261131, 0.000257236, 0.00025336, 0.000249504, 0.000245668, 0.000241851, 0.000238055, 0.000234279, 0.000230522, 0.000226786, 0.00022307, 0.000219374, 0.000215699, 0.000212043, 0.000208408, 0.000204793, 0.000201199, 0.000197625, 0.000194071, 0.000190538, 0.000187025, 0.000183533, 0.000180061, 0.00017661, 0.00017318, 0.00016977, 0.000166381, 0.000163012, 0.000159664, 0.000156337, 0.000153031, 0.000149745, 0.00014648, 0.000143236, 0.000140013, 0.00013681, 0.000133628, 0.000130468, 0.000127327, 0.000124208, 0.00012111, 0.000118032, 0.000114976, 0.00011194, 0.000108925, 0.000105931, 0.000102958, 0.000100006, 9.70746E-05, 9.41642E-05, 9.12746E-05, 8.8406E-05, 8.55582E-05, 8.27313E-05, 7.99253E-05, 7.71402E-05, 7.43759E-05, 7.16324E-05, 6.89098E-05, 6.6208E-05, 6.3527E-05, 6.08669E-05, 5.82275E-05, 5.56088E-05, 5.3011E-05, 5.04339E-05, 4.78775E-05, 4.53418E-05, 4.28268E-05, 4.03324E-05, 3.78587E-05, 3.54057E-05, 3.29732E-05, 3.05613E-05, 2.81699E-05, 2.57991E-05, 2.34487E-05, 2.11189E-05, 1.88094E-05, 1.65204E-05, 1.42517E-05, 1.20034E-05, 9.77546E-06, 7.56775E-06, 5.38029E-06, 3.21305E-06, 1.06598E-06, -1.06095E-06, -3.16777E-06, -5.25454E-06, -7.32127E-06, -9.36802E-06, -1.13948E-05, -1.34017E-05, -1.53888E-05, -1.7356E-05, -1.93035E-05, -2.12312E-05, -2.31392E-05, -2.50277E-05, -2.68965E-05, -2.87458E-05, -3.05755E-05, -3.23859E-05, -3.41769E-05, -3.59485E-05, -3.77008E-05, -3.94339E-05, -4.11478E-05, -4.28426E-05, -4.45183E-05, -4.6175E-05, -4.78128E-05, -4.94316E-05, -5.10316E-05, -5.26128E-05, -5.41752E-05, -5.5719E-05, -5.72442E-05, -5.87509E-05, -6.0239E-05, -6.17088E-05, -6.31601E-05, -6.45932E-05, -6.60081E-05, -6.74048E-05, -6.87833E-05, -7.01439E-05, -7.14865E-05, -7.28111E-05, -7.4118E-05, -7.5407E-05, -7.66784E-05, -7.79322E-05, -7.91684E-05, -8.03871E-05, -8.15884E-05, -8.27724E-05, -8.39391E-05, -8.50886E-05, -8.6221E-05, -8.73364E-05, -8.84347E-05, -8.95162E-05, -9.05809E-05, -9.16288E-05, -9.266E-05, -9.36747E-05, -9.46729E-05, -9.56546E-05, -9.66199E-05, -9.7569E-05, -9.85019E-05, -9.94187E-05, -0.000100319, -0.000101204, -0.000102073, -0.000102926, -0.000103764, -0.000104585, -0.000105392, -0.000106182, -0.000106958, -0.000107718, -0.000108463, -0.000109193, -0.000109907, -0.000110607, -0.000111292, -0.000111962, -0.000112618, -0.000113259, -0.000113885, -0.000114497, -0.000115094, -0.000115678, -0.000116247, -0.000116802, -0.000117343, -0.00011787, -0.000118384, -0.000118883, -0.000119369, -0.000119842, -0.000120301, -0.000120746, -0.000121179, -0.000121598, -0.000122004, -0.000122397, -0.000122778, -0.000123145, -0.0001235, -0.000123842, -0.000124171, -0.000124488, -0.000124793, -0.000125086, -0.000125366, -0.000125634, -0.000125891, -0.000126135, -0.000126368, -0.000126588, -0.000126798, -0.000126996, -0.000127182, -0.000127357, -0.000127521, -0.000127674, -0.000127815, -0.000127946, -0.000128066, -0.000128175, -0.000128273, -0.000128361, -0.000128439, -0.000128506, -0.000128562, -0.000128609, -0.000128645, -0.000128672, -0.000128688, -0.000128695, -0.000128692, -0.00012868, -0.000128657, -0.000128626, -0.000128585, -0.000128535, -0.000128475, -0.000128407, -0.000128329, -0.000128243, -0.000128148, -0.000128044, -0.000127932, -0.000127811, -0.000127682, -0.000127544, -0.000127399, -0.000127245, -0.000127083, -0.000126913, -0.000126735, -0.000126549, -0.000126356, -0.000126155, -0.000125947, -0.000125731, -0.000125509, -0.000125278, -0.000125041, -0.000124797, -0.000124545, -0.000124287, -0.000124022, -0.000123751, -0.000123472, -0.000123188, -0.000122897, -0.000122599, -0.000122296, -0.000121986, -0.00012167, -0.000121348, -0.00012102, -0.000120687, -0.000120348, -0.000120003, -0.000119653, -0.000119297, -0.000118936, -0.000118569, -0.000118198, -0.000117821, -0.000117439, -0.000117052, -0.000116661, -0.000116264, -0.000115863, -0.000115458, -0.000115048, -0.000114633, -0.000114214, -0.000113791, -0.000113363, -0.000112932, -0.000112496, -0.000112057, -0.000111613, -0.000111166, -0.000110715, -0.00011026, -0.000109802, -0.00010934, -0.000108875, -0.000108407, -0.000107935, -0.00010746, -0.000106982, -0.000106501, -0.000106017, -0.000105531, -0.000105041, -0.000104549, -0.000104053, -0.000103556, -0.000103056, -0.000102553, -0.000102048, -0.000101541, -0.000101031, -0.000100519, -0.000100005, -9.94895E-05, -9.89717E-05, -9.84519E-05, -9.79304E-05, -9.7407E-05, -9.6882E-05, -9.63554E-05, -9.58271E-05, -9.52974E-05, -9.47663E-05, -9.42337E-05, -9.36999E-05, -9.31648E-05, -9.26286E-05, -9.20912E-05, -9.15527E-05, -9.10133E-05, -9.04729E-05, -8.99316E-05, -8.93895E-05, -8.88467E-05, -8.83031E-05, -8.77589E-05, -8.72142E-05, -8.66688E-05, -8.61231E-05, -8.55769E-05, -8.50303E-05, -8.44834E-05, -8.39363E-05, -8.33889E-05, -8.28415E-05, -8.22939E-05, -8.17463E-05, -8.11987E-05, -8.06511E-05, -8.01037E-05, -7.95564E-05, -7.90093E-05, -7.84625E-05, -7.7916E-05, -7.73698E-05, -7.68241E-05, -7.62788E-05, -7.5734E-05, -7.51897E-05, -7.4646E-05, -7.4103E-05, -7.35606E-05, -7.30189E-05, -7.2478E-05, -7.19379E-05, -7.13987E-05, -7.08603E-05, -7.03229E-05, -6.97864E-05, -6.92509E-05, -6.87165E-05, -6.81831E-05, -6.76509E-05, -6.71199E-05, -6.659E-05, -6.60614E-05, -6.5534E-05, -6.5008E-05, -6.44832E-05, -6.39599E-05, -6.3438E-05, -6.29175E-05, -6.23984E-05, -6.18809E-05, -6.13649E-05, -6.08505E-05, -6.03377E-05, -5.98265E-05, -5.9317E-05, -5.88091E-05, -5.8303E-05, -5.77986E-05, -5.7296E-05, -5.67952E-05, -5.62962E-05, -5.5799E-05, -5.53037E-05, -5.48103E-05, -5.43189E-05, -5.38294E-05, -5.33418E-05, -5.28563E-05, -5.23727E-05, -5.18912E-05, -5.14118E-05, -5.09344E-05, -5.04591E-05, -4.9986E-05, -4.95149E-05, -4.90461E-05, -4.85794E-05, -4.81148E-05, -4.76525E-05, -4.71924E-05, -4.67346E-05, -4.6279E-05, -4.58257E-05, -4.53746E-05, -4.49259E-05, -4.44794E-05, -4.40353E-05, -4.35935E-05, -4.31541E-05, -4.2717E-05, -4.22823E-05, -4.18499E-05, -4.142E-05, -4.09925E-05, -4.05673E-05, -4.01446E-05, -3.97243E-05, -3.93064E-05, -3.8891E-05, -3.84781E-05, -3.80675E-05, -3.76595E-05, -3.72539E-05, -3.68508E-05, -3.64501E-05, -3.60519E-05, -3.56563E-05, -3.52631E-05, -3.48723E-05, -3.44841E-05, -3.40984E-05, -3.37151E-05, -3.33344E-05, -3.29561E-05, -3.25804E-05, -3.22071E-05, -3.18364E-05, -3.14681E-05, -3.11023E-05, -3.0739E-05, -3.03782E-05, -3.00199E-05, -2.96641E-05, -2.93108E-05, -2.89599E-05, -2.86115E-05, -2.82655E-05, -2.79221E-05, -2.75811E-05, -2.72425E-05, -2.69064E-05, -2.65727E-05, -2.62415E-05, -2.59126E-05, -2.55862E-05, -2.52623E-05, -2.49407E-05, -2.46215E-05, -2.43047E-05, -2.39902E-05, -2.36782E-05, -2.33684E-05, -2.30611E-05, -2.27561E-05, -2.24533E-05, -2.2153E-05, -2.18549E-05, -2.15591E-05, -2.12656E-05, -2.09743E-05, -2.06853E-05, -2.03986E-05, -2.0114E-05, -1.98317E-05, -1.95516E-05, -1.92737E-05, -1.89979E-05, -1.87244E-05, -1.84529E-05, -1.81836E-05, -1.79164E-05, -1.76513E-05, -1.73883E-05, -1.71273E-05, -1.68684E-05, -1.66115E-05, -1.63567E-05, -1.61038E-05, -1.58529E-05, -1.5604E-05, -1.53571E-05, -1.5112E-05, -1.48689E-05, -1.46277E-05, -1.43883E-05, -1.41509E-05, -1.39152E-05, -1.36814E-05, -1.34493E-05, -1.32191E-05, -1.29906E-05, -1.27638E-05, -1.25388E-05, -1.23154E-05, -1.20938E-05, -1.18738E-05, -1.16555E-05, -1.14387E-05, -1.12236E-05, -1.101E-05, -1.0798E-05, -1.05876E-05, -1.03786E-05, -1.01712E-05, -9.96517E-06, -9.76063E-06, -9.55752E-06, -9.35582E-06, -9.1555E-06, -8.95654E-06, -8.75892E-06, -8.56261E-06, -8.36761E-06, -8.17387E-06, -7.98138E-06, -7.79012E-06, -7.60007E-06, -7.4112E-06, -7.22348E-06, -7.0369E-06, -6.85144E-06, -6.66706E-06, -6.48375E-06, -6.30149E-06, -6.12024E-06, -5.94E-06, -5.76073E-06, -5.58241E-06, -5.40501E-06, -5.22853E-06, -5.05292E-06, -4.87817E-06, -4.70426E-06, -4.53116E-06, -4.35885E-06, -4.18731E-06, -4.0165E-06, -3.84642E-06, -3.67703E-06, -3.50831E-06, -3.34024E-06, -3.1728E-06, -3.00597E-06, -2.83971E-06, -2.674E-06, -2.50884E-06, -2.34418E-06, -2.18001E-06, -2.0163E-06, -1.85304E-06, -1.6902E-06, -1.52775E-06, -1.36568E-06};
		int32_t numBlock=RECORDING_BUFLEN/NumTaps;
		arm_fir_instance_f32 S;

		arm_fir_init_f32(&S, NumTaps, firCoeffs32, firStateF32, blockSize);
		  for(int i=0; i < numBlock; i++)
		  {
			arm_fir_f32(&S, floatBuffer + (i*blockSize), floatBuffer + (i*blockSize), blockSize);
		  }
		transformBufferToDAC(floatBuffer,RECORDING_BUFLEN, sendingBuffer);



		printf("Sending audio to other board \r\n");

		uint16_t step = RECORDING_BUFLEN/SENDING_BUFLEN;
		for (int i = 0 ; i < step; i++) {
			if(wifi_send_data_to_board(&(sendingBuffer[i*SENDING_BUFLEN])) == WIFI_STATUS_OK) {
				printf("Sent packet %d\r\n", i);
			}
		}
   // }
    buttonPressed = false;
  }
}

/**
 * This function attempts to sent an HTTP request to the other board, which contains some data.
 */
static int wifi_send_data_to_board(uint8_t* data) {
	// first try to connect to the board

    if (WIFI_OpenClientConnection(REMOTE_SOCKET, WIFI_TCP_PROTOCOL, "test", RemoteIP_Addr, REMOTE_PORT, PORT) != WIFI_STATUS_OK) {
    	printf("Could not connect to other board \r\n");
    	return -1;
    }

    printf("Connected to other board\r\n");
	//char* http_header = "HTTP/1.0 200 OK\r\nContent-Type: text/plain\r\n";
    //strcat(http_header, data);

    uint16_t actualSent;
    /*
    for (int i = 0; i < 20; i++) {
    	if (WIFI_SendData(REMOTE_SOCKET, &(data[i*1000]), SENDING_BUFLEN, &actualSent, WIFI_WRITE_TIMEOUT) == WIFI_STATUS_OK) {
			printf("Sent packet %d \r\n", i);
			//memset(data, 0, strlen(data));
			return -1;
    	}
    }
    */
	if (WIFI_SendData(REMOTE_SOCKET,data, SENDING_BUFLEN, &actualSent, WIFI_WRITE_TIMEOUT) != WIFI_STATUS_OK) {
		printf("Could not send data \r\n");
		//memset(data, 0, strlen(data));
		return -1;
	}

    //memset(data, 0, strlen(data)); // maybe we can remove this
    // wait for resp from receiving board before proceeding
    uint8_t resp[100];
    memset(resp, 0, strlen((char*)resp));
    uint16_t actualReceived;

    while(WIFI_ReceiveData(REMOTE_SOCKET, resp, 100, &actualReceived, WIFI_READ_TIMEOUT) != WIFI_STATUS_OK) {

    }
    printf("Received response from receiving board: %s\r\n", resp);

    // close connection

    if (WIFI_CloseClientConnection(REMOTE_SOCKET) != WIFI_STATUS_OK) {
    	printf("Could not close client connection \r\n");
    	return -1;
    }
    printf("Closed client connection \r\n");

    return WIFI_STATUS_OK;
}
/**
 * This function takes care of:
 * - starting the es-wifi module
 * - connecting to a network whose credentials are provided in code
 * - connect to the receiving board using ip address provided in parameters of this function
 * - returns -1 if anything bad happens
 * - returns WIFI_STATUS_OK if successful
 */
static int wifi_connect_to_board(uint8_t ip0, uint8_t ip1, uint8_t ip2, uint8_t ip3) {
	// start wifi module
	wifi_start();


	// connect to existing AP
	if (WIFI_Connect(SSID, PASSWORD, SECURITY) == WIFI_STATUS_OK)
	{
	  if(WIFI_GetIP_Address(IP_Addr, sizeof(IP_Addr)) == WIFI_STATUS_OK)
	  {
		LOG(("eS-WiFi module connected: got IP Address : %d.%d.%d.%d\r\n",
				 IP_Addr[0],
				 IP_Addr[1],
				 IP_Addr[2],
				 IP_Addr[3]));
	  }
	  else
	  {
		LOG((" ERROR : es-wifi module CANNOT get IP address\r\n"));
		return -1;
	  }
	}
	else
	{
	   LOG(("ERROR : es-wifi module NOT connected\r\n"));
	   return -1;
	}
	// start server (?)

	if (WIFI_STATUS_OK != WIFI_StartServer(SOCKET, WIFI_TCP_PROTOCOL, 1, "", PORT)) {
		printf("ERROR: Could not start server \r\n");
		return -1;
	}

	// trying to connect to other board using IP addr
    RemoteIP_Addr[0] = ip0;
    RemoteIP_Addr[1] = ip1;
    RemoteIP_Addr[2] = ip2;
    RemoteIP_Addr[3] = ip3;
    if (WIFI_OpenClientConnection(REMOTE_SOCKET, WIFI_TCP_PROTOCOL, "test", RemoteIP_Addr, REMOTE_PORT, PORT) != WIFI_STATUS_OK) {
    	printf("Could not connect to other board \r\n");
    	return -1;
    }

    // we need to disconnect at the end since we will be reconnecting to send data
    // close connection
    if (WIFI_CloseClientConnection(REMOTE_SOCKET) != WIFI_STATUS_OK) {
    	printf("Could not close client connection \r\n");
    	return -1;
    }

    return WIFI_STATUS_OK;
}

/**
  * @brief  Send HTML page
  * @param  None
  * @retval None
  */


static int wifi_start(void)
{
  uint8_t  MAC_Addr[6];

 /*Initialize and use WIFI module */
  if(WIFI_Init() ==  WIFI_STATUS_OK)
  {
    LOG(("ES-WIFI Initialized.\r\n"));
    if(WIFI_GetMAC_Address(MAC_Addr, sizeof(MAC_Addr)) == WIFI_STATUS_OK)
    {
      LOG(("> eS-WiFi module MAC Address : %02X:%02X:%02X:%02X:%02X:%02X\r\n",
               MAC_Addr[0],
               MAC_Addr[1],
               MAC_Addr[2],
               MAC_Addr[3],
               MAC_Addr[4],
               MAC_Addr[5]));
    }
    else
    {
      LOG(("> ERROR : CANNOT get MAC address\r\n"));
      return -1;
    }
  }
  else
  {
    return -1;
  }
  return 0;
}

/**
 * Transforms a buffer's values into valid DAC 8bit right aligned values
 */
void transformBufferToFloat(int32_t *buffer, uint32_t recording_buffer_length, float32_t *outputBuffer) {
	for (int i = 0; i < recording_buffer_length; i++) {
		outputBuffer[i]=(float)buffer[i];
	}
}
void transformBufferToDAC(float32_t *buffer, uint32_t recording_buffer_length, uint8_t *outputBuffer) {
	// need to map buffer values to 8bit right alligned values (uint8_t)
	// from experimentation (screaming at the board): min values tend to be -3000 and max seems to be ~1000
	const int16_t MAX_VAL = 1200;
	const int16_t MIN_VAL = -1200;
	const float a = (255.0)/(MAX_VAL - MIN_VAL); // slope
	for (int i = 0; i < recording_buffer_length; i++) {
		int32_t val = (int32_t)buffer[i];
		val = val >> 8; // remove this for LOUDER but MORE SCUFFED NOISE
		// clip buffer values to within [-MIN_VAL, MAX_VAL]
		if (val <= MIN_VAL) {
			val = MIN_VAL;
		}
		if (val >= MAX_VAL) {
			val = MAX_VAL;
		}
		// scale values up by [-MIN_VAL] to make sure no negatives
		if (MIN_VAL < 0) {
			val += (-MIN_VAL);
		}
		// now the range of val should be [0, MAX_VAL-MIN_VAL], apply linear function to get DAC val
		val = round(a*val);
		if (val >= 0 && val <= 255) {
			outputBuffer[i] = (uint8_t)val; // change the buffer
		} else {
			Error_Handler(); // should not happen
		}
	}
}

/**
  * @brief  System Clock Configuration
  *         The system Clock is configured as follow :
  *            System Clock source            = PLL (MSI)
  *            SYSCLK(Hz)                     = 80000000
  *            HCLK(Hz)                       = 80000000
  *            AHB Prescaler                  = 1
  *            APB1 Prescaler                 = 1
  *            APB2 Prescaler                 = 1
  *            MSI Frequency(Hz)              = 4000000
  *            PLL_M                          = 1
  *            PLL_N                          = 40
  *            PLL_R                          = 2
  *            PLL_P                          = 7
  *            PLL_Q                          = 4
  *            Flash Latency(WS)              = 4
  * @param  None
  * @retval None
  */
static void SystemClock_Config(void)
{
  RCC_ClkInitTypeDef RCC_ClkInitStruct;
  RCC_OscInitTypeDef RCC_OscInitStruct;

  /* MSI is enabled after System reset, activate PLL with MSI as source */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_MSI;
  RCC_OscInitStruct.MSIState = RCC_MSI_ON;
  RCC_OscInitStruct.MSIClockRange = RCC_MSIRANGE_6;
  RCC_OscInitStruct.MSICalibrationValue = RCC_MSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_MSI;
  RCC_OscInitStruct.PLL.PLLM = 1;
  RCC_OscInitStruct.PLL.PLLN = 40;
  RCC_OscInitStruct.PLL.PLLR = 2;
  RCC_OscInitStruct.PLL.PLLP = 7;
  RCC_OscInitStruct.PLL.PLLQ = 4;
  if(HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    /* Initialization Error */
    while(1);
  }

  /* Select PLL as system clock source and configure the HCLK, PCLK1 and PCLK2
     clocks dividers */
  RCC_ClkInitStruct.ClockType = (RCC_CLOCKTYPE_SYSCLK | RCC_CLOCKTYPE_HCLK | RCC_CLOCKTYPE_PCLK1 | RCC_CLOCKTYPE_PCLK2);
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;
  if(HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_4) != HAL_OK)
  {
    /* Initialization Error */
    while(1);
  }
}
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
/* USER CODE BEGIN MX_GPIO_Init_1 */
/* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();

  /*Configure GPIO pin : PC13 */
  GPIO_InitStruct.Pin = GPIO_PIN_13;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /* EXTI interrupt init*/
  HAL_NVIC_SetPriority(EXTI15_10_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);

/* USER CODE BEGIN MX_GPIO_Init_2 */
/* USER CODE END MX_GPIO_Init_2 */
}

#if defined (TERMINAL_USE)
/**
  * @brief  Retargets the C library printf function to the USART.
  * @param  None
  * @retval None
  */
PUTCHAR_PROTOTYPE
{
  /* Place your implementation of fputc here */
  /* e.g. write a character to the USART1 and Loop until the end of transmission */
  HAL_UART_Transmit(&hDiscoUart, (uint8_t *)&ch, 1, 0xFFFF);

  return ch;
}

#endif /* TERMINAL_USE */

#ifdef USE_FULL_ASSERT

/**
   * @brief Reports the name of the source file and the source line number
   * where the assert_param error has occurred.
   * @param file: pointer to the source file name
   * @param line: assert_param error line source number
   * @retval None
   */
void assert_failed(uint8_t* file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
    ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */

}

#endif

static void MX_DAC1_Init(void)
{

  /* USER CODE BEGIN DAC1_Init 0 */

  /* USER CODE END DAC1_Init 0 */

  DAC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN DAC1_Init 1 */

  /* USER CODE END DAC1_Init 1 */

  /** DAC Initialization
  */
  hdac1.Instance = DAC1;
  if (HAL_DAC_Init(&hdac1) != HAL_OK)
  {
    Error_Handler();
  }

  /** DAC channel OUT1 config
  */
  sConfig.DAC_SampleAndHold = DAC_SAMPLEANDHOLD_DISABLE;
  sConfig.DAC_Trigger = DAC_TRIGGER_T2_TRGO;
  sConfig.DAC_HighFrequency = DAC_HIGH_FREQUENCY_INTERFACE_MODE_ABOVE_80MHZ;
  sConfig.DAC_OutputBuffer = DAC_OUTPUTBUFFER_ENABLE;
  sConfig.DAC_ConnectOnChipPeripheral = DAC_CHIPCONNECT_DISABLE;
  sConfig.DAC_UserTrimming = DAC_TRIMMING_FACTORY;
  if (HAL_DAC_ConfigChannel(&hdac1, &sConfig, DAC_CHANNEL_1) != HAL_OK)
  {
    Error_Handler();
  }

  /** DAC channel OUT2 config
  */
  sConfig.DAC_Trigger = DAC_TRIGGER_NONE;
  if (HAL_DAC_ConfigChannel(&hdac1, &sConfig, DAC_CHANNEL_2) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN DAC1_Init 2 */

  /* USER CODE END DAC1_Init 2 */

}

/**
  * @brief DFSDM1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_DFSDM1_Init(void)
{

  /* USER CODE BEGIN DFSDM1_Init 0 */

  /* USER CODE END DFSDM1_Init 0 */

  /* USER CODE BEGIN DFSDM1_Init 1 */

  /* USER CODE END DFSDM1_Init 1 */
  hdfsdm1_filter0.Instance = DFSDM1_Filter0;
  hdfsdm1_filter0.Init.RegularParam.Trigger = DFSDM_FILTER_SW_TRIGGER;
  hdfsdm1_filter0.Init.RegularParam.FastMode = ENABLE;
  hdfsdm1_filter0.Init.RegularParam.DmaMode = ENABLE;
  hdfsdm1_filter0.Init.FilterParam.SincOrder = DFSDM_FILTER_FASTSINC_ORDER;
  hdfsdm1_filter0.Init.FilterParam.Oversampling = 100;
  hdfsdm1_filter0.Init.FilterParam.IntOversampling = 1;
  if (HAL_DFSDM_FilterInit(&hdfsdm1_filter0) != HAL_OK)
  {
    Error_Handler();
  }
  hdfsdm1_channel2.Instance = DFSDM1_Channel2;
  hdfsdm1_channel2.Init.OutputClock.Activation = ENABLE;
  hdfsdm1_channel2.Init.OutputClock.Selection = DFSDM_CHANNEL_OUTPUT_CLOCK_SYSTEM;
  hdfsdm1_channel2.Init.OutputClock.Divider = 50*SAMPLING_RATE_FACTOR; // CHANGED FROM 50 to 100 so that SAMPLING RATE IS 10K
  hdfsdm1_channel2.Init.Input.Multiplexer = DFSDM_CHANNEL_EXTERNAL_INPUTS;
  hdfsdm1_channel2.Init.Input.DataPacking = DFSDM_CHANNEL_STANDARD_MODE;
  hdfsdm1_channel2.Init.Input.Pins = DFSDM_CHANNEL_SAME_CHANNEL_PINS;
  hdfsdm1_channel2.Init.SerialInterface.Type = DFSDM_CHANNEL_SPI_RISING;
  hdfsdm1_channel2.Init.SerialInterface.SpiClock = DFSDM_CHANNEL_SPI_CLOCK_INTERNAL;
  hdfsdm1_channel2.Init.Awd.FilterOrder = DFSDM_CHANNEL_FASTSINC_ORDER;
  hdfsdm1_channel2.Init.Awd.Oversampling = 1;
  hdfsdm1_channel2.Init.Offset = 0;
  hdfsdm1_channel2.Init.RightBitShift = 0x00;
  if (HAL_DFSDM_ChannelInit(&hdfsdm1_channel2) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_DFSDM_FilterConfigRegChannel(&hdfsdm1_filter0, DFSDM_CHANNEL_2, DFSDM_CONTINUOUS_CONV_ON) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN DFSDM1_Init 2 */

  /* USER CODE END DFSDM1_Init 2 */

}

/**
  * @brief TIM2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM2_Init(void)
{

  /* USER CODE BEGIN TIM2_Init 0 */

  /* USER CODE END TIM2_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM2_Init 1 */

  /* USER CODE END TIM2_Init 1 */
  htim2.Instance = TIM2;
  htim2.Init.Prescaler = 0;
  htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim2.Init.Period = 5000*SAMPLING_RATE_FACTOR;
  htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim2, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_UPDATE;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim2, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM2_Init 2 */

  /* USER CODE END TIM2_Init 2 */

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMAMUX1_CLK_ENABLE();
  __HAL_RCC_DMA1_CLK_ENABLE();

  /* DMA interrupt init */
  /* DMA1_Channel1_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel1_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel1_IRQn);
  /* DMA1_Channel2_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel2_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel2_IRQn);

}

/**
  * @brief  EXTI line detection callback.
  * @param  GPIO_Pin: Specifies the port pin connected to corresponding EXTI line.
  * @retval None
  */

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
  switch (GPIO_Pin)
  {
  case (GPIO_PIN_1):
    {
      SPI_WIFI_ISR();
      break;
    }
  case (GPIO_PIN_13):
     {
      buttonPressed=1;
        break;
     }
    default:
    {
      break;
    }
  }
}
/*
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin){
	if(GPIO_Pin==GPIO_PIN_1){
	    SPI_WIFI_ISR();
	}
	else if (GPIO_Pin==USER_BUTTON_PIN)
    {
     buttonPressed=true;
    }
}*/

void HAL_DFSDM_FilterRegConvCpltCallback(DFSDM_Filter_HandleTypeDef *hdfsdm_filter) {
	DFSDM_finished = true;
}

void HAL_DFSDM_FilterRegConvHalfCpltCallback (DFSDM_Filter_HandleTypeDef * hdfsdm_filter) {
	DFSDM_half_finished = true;
}
/**
  * @brief  SPI3 line detection callback.
  * @param  None
  * @retval None
  */
void SPI3_IRQHandler(void)
{
  HAL_SPI_IRQHandler(&hspi);
}

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}
#endif



